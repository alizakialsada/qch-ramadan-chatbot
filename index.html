<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QCH ‚Äì Smart Ramadan Medication Assistant (v7)</title>
  <meta name="description" content="Qatif Central Hospital ‚Äì Ramadan Medication Assistant (Arabic/English)." />

  <style>
    :root{
      --bg:#0b1f26;
      --panel:#0f2a33;
      --panel2:#0d2530;
      --stroke: rgba(255,255,255,.08);
      --text:#eaf6fb;
      --muted:#a8c3cd;
      --accent:#35d0c7;
      --accent2:#2aa6ff;
      --good:#22c55e;
      --warn:#f59e0b;
      --danger:#ff4d4f;
      --radius:18px;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      font-synthesis: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 720px at 20% 10%, #15404d 0%, var(--bg) 55%),
        radial-gradient(900px 520px at 80% 40%, rgba(42,166,255,.18) 0%, rgba(0,0,0,0) 60%);
      color:var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
    }

    .wrap{max-width:1220px; margin:24px auto; padding:16px;}

    .top{
      background: linear-gradient(135deg, rgba(18,55,71,.95), rgba(13,42,52,.88));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:14px; align-items:center}
    .logo{
      width:54px; height:54px; border-radius:16px;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      display:grid; place-items:center;
      font-weight:900; letter-spacing:.5px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title p{margin:4px 0 0; color:var(--muted); font-size:13px}

    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    select, button, input{
      background: rgba(10,28,36,.65);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    select:focus, button:focus, input:focus{
      border-color: rgba(53,208,199,.45);
      box-shadow: 0 0 0 3px rgba(53,208,199,.12);
    }
    button{
      cursor:pointer;
      background: linear-gradient(135deg, rgba(53,208,199,.18), rgba(42,166,255,.12));
    }
    button:hover{filter:brightness(1.06)}

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.55fr .95fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(11,31,38,.70), rgba(10,28,36,.55));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(20,60,74,.55), rgba(0,0,0,0));
    }
    .cardHead .left{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill.good{color: rgba(34,197,94,.95); border-color: rgba(34,197,94,.25)}
    .pill.warn{color: rgba(245,158,11,.95); border-color: rgba(245,158,11,.25)}
    .pill.danger{color: rgba(255,77,79,.95); border-color: rgba(255,77,79,.25)}

    .chatBody{
      height:520px;
      padding:12px 12px 0;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
    }
    .avatar{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      font-weight:800;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .bubble{
      max-width: 78%;
      padding:12px 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
    }
    .bubble small{display:block; margin-top:8px; color:var(--muted); font-size:12px}
    .me .avatar{background: rgba(42,166,255,.12); border-color: rgba(42,166,255,.25)}
    .me .bubble{background: rgba(42,166,255,.10); border-color: rgba(42,166,255,.20)}
    .bot .avatar{background: rgba(53,208,199,.12); border-color: rgba(53,208,199,.25)}
    .bot .bubble{background: rgba(53,208,199,.08); border-color: rgba(53,208,199,.18)}

    .composer{
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(10,28,36,.55));
    }
    .composer input{
      flex:1;
      padding:12px 14px;
      border-radius: 16px;
      font-size:14px;
    }
    .send{
      padding:12px 16px;
      border-radius: 16px;
      font-weight:700;
    }

    .sideBody{
      padding:14px 16px 16px;
    }
    .note{
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.08);
      border-radius:16px;
      padding:12px 12px;
      color: #ffe8c2;
      margin-bottom:12px;
      line-height:1.35;
    }
    .how{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .how b{color:var(--text)}
    .foot{
      margin-top:14px;
      color: rgba(168,195,205,.85);
      font-size:13px;
      line-height:1.35;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding:2px 8px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      display:inline-block;
      margin:0 2px;
    }
    .tags{margin-top:10px; display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      background: rgba(255,255,255,.03);
    }
    .tag.good{border-color: rgba(34,197,94,.25); color: rgba(34,197,94,.95); background: rgba(34,197,94,.08)}
    .tag.warn{border-color: rgba(245,158,11,.25); color: rgba(245,158,11,.95); background: rgba(245,158,11,.08)}
    .tag.danger{border-color: rgba(255,77,79,.25); color: rgba(255,77,79,.95); background: rgba(255,77,79,.08)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">QCH</div>
        <div class="title">
          <h1>QCH ‚Äì Smart Ramadan Medication Assistant</h1>
          <p>Hospital-grade rules: medication + class + frequency ‚Ä¢ Arabic / English</p>
        </div>
      </div>

      <div class="controls">
        <select id="lang">
          <option value="bi" selected>Arabic + English</option>
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>

        <select id="role">
          <option value="patient" selected>Patient</option>
          <option value="hcp">HCP</option>
        </select>

        <button id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="card">
        <div class="cardHead">
          <div class="left">
            <b>Chat</b>
            <span class="pill">Ramadan ‚Ä¢ v7 (Class + Frequency Engine)</span>
          </div>
          <span id="statusPill" class="pill good">Ready</span>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="composer">
          <input id="userInput" type="text" placeholder="Type medication name‚Ä¶ / ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ°‚Ä¶" autocomplete="off" />
          <button id="sendBtn" class="send">Send</button>
        </div>
      </div>

      <!-- SAFETY -->
      <div class="card">
        <div class="cardHead">
          <div class="left">
            <b>Safety & How to use</b>
          </div>
          <span class="pill">No PHI stored</span>
        </div>

        <div class="sideBody">
          <div class="note">
            <b>Important:</b> General guidance only. For <b>insulin</b>, <b>warfarin</b>, <b>pregnancy</b>, CKD/CLD, transplant,
            chemotherapy, seizure meds, or complex regimens ‚Üí consult your clinician/pharmacist.
          </div>

          <div class="how">
            <b>Perfect Ramadan method:</b><br/>
            1) Type the <b>medication name</b>. If not found ‚Üí type a <b>class</b> (e.g., antibiotic, PPI, blood pressure).<br/>
            2) If still unknown, the assistant will ask: <b>How many times per day?</b> (OD/BID/TID/QID).<br/>
            3) Follow timing + warning labels (‚úÖ / ‚ö†Ô∏è / ‚õî).
            <div class="tags">
              <span class="tag good">‚úÖ Safer</span>
              <span class="tag warn">‚ö†Ô∏è Caution</span>
              <span class="tag danger">‚õî High-risk</span>
              <span class="tag">Iftar</span>
              <span class="tag">Suhoor</span>
              <span class="tag">Bedtime</span>
            </div>
          </div>

          <div class="foot">
            Created by <b>Ali Alsada</b><br/>
            Pharmacy Department ‚Ä¢ Qatif Central Hospital
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   QCH Ramadan Assistant v7
   Single-file ‚Ä¢ Offline rules
   ========================= */

const el = (id) => document.getElementById(id);
const chatBody = el("chatBody");
const input = el("userInput");
const sendBtn = el("sendBtn");
const resetBtn = el("resetBtn");
const langSel = el("lang");
const roleSel = el("role");
const statusPill = el("statusPill");

const state = {
  pending: null, // { kind: "ask_freq", payload: {...} }
};

function nowStamp(){
  const d = new Date();
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

function setStatus(type, text){
  statusPill.className = "pill " + (type || "good");
  statusPill.textContent = text;
}

function addMsg(who, text, meta){
  const row = document.createElement("div");
  row.className = "msg " + (who === "me" ? "me" : "bot");

  const av = document.createElement("div");
  av.className = "avatar";
  av.textContent = who === "me" ? "ME" : "QCH";

  const bub = document.createElement("div");
  bub.className = "bubble";
  bub.textContent = text;

  const small = document.createElement("small");
  small.textContent = (meta || nowStamp());
  bub.appendChild(small);

  row.appendChild(av);
  row.appendChild(bub);
  chatBody.appendChild(row);

  chatBody.scrollTop = chatBody.scrollHeight;
}

function t(bi, en, ar){
  const v = langSel.value;
  if (v === "en") return en;
  if (v === "ar") return ar;
  return bi;
}

function normalize(s){
  return (s || "")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim();
}

function containsAny(text, arr){
  return arr.some(k => text.includes(k));
}

/* ==== Knowledge base (simple) ==== */
const KB = {
  // PPI / GERD
  ppi: {
    keys: ["ppi","omeprazole","pantoprazole","esomeprazole","lansoprazole","rabeprazole","nexium","losec","controloc","pantoloc"],
    class: "PPI",
    risk: "good",
    advice: () => t(
`‚úÖ PPI / ÿØŸàÿßÿ° ŸÑŸÑŸÖÿπÿØÿ©
‚Ä¢ Best timing: 30‚Äì60 min BEFORE Suhoor (or before Iftar if night symptoms).
‚Ä¢ Take on empty stomach.
‚Ä¢ If once daily (OD) ‚Üí Suhoor. If BID ‚Üí Suhoor + before Iftar.`,
`‚úÖ PPI (acid reducer)
‚Ä¢ Best: 30‚Äì60 min BEFORE Suhoor (or before Iftar if night symptoms).
‚Ä¢ Take on empty stomach.
‚Ä¢ OD ‚Üí Suhoor. BID ‚Üí Suhoor + before Iftar.`,
`‚úÖ ŸÖÿ´ÿ®ÿ∑ÿßÿ™ ŸÖÿ∂ÿÆÿ© ÿßŸÑÿ®ÿ±Ÿàÿ™ŸàŸÜ (PPI)
‚Ä¢ ÿßŸÑÿ£ŸÅÿ∂ŸÑ: ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ± ÿ®ŸÄ 30‚Äì60 ÿØŸÇŸäŸÇÿ© (ÿ£Ÿà ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ÿ•ÿ∞ÿß ÿßŸÑÿ£ÿπÿ±ÿßÿ∂ ŸÑŸäŸÑŸäÿ©).
‚Ä¢ Ÿäÿ§ÿÆÿ∞ ÿπŸÑŸâ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ©.
‚Ä¢ ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß ‚Üí ÿ≥ÿ≠Ÿàÿ±. ŸÖÿ±ÿ™ŸäŸÜ ‚Üí ÿ≥ÿ≠Ÿàÿ± + ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±.`
    )
  },

  // Warfarin / anticoagulants
  warfarin: {
    keys: ["warfarin","coumadin"],
    class: "Warfarin",
    risk: "danger",
    advice: () => t(
`‚õî Warfarin / Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ
‚Ä¢ Keep SAME daily time (often after Iftar is practical).
‚Ä¢ DO NOT change dose yourself.
‚Ä¢ INR monitoring is essential (diet changes in Ramadan can affect INR).
‚Ä¢ Avoid new herbals/supplements without checking.`,
`‚õî Warfarin
‚Ä¢ Keep the SAME daily time (often after Iftar is practical).
‚Ä¢ Do NOT self-adjust dose.
‚Ä¢ INR monitoring is essential (diet changes can affect INR).
‚Ä¢ Avoid new herbals/supplements without checking.`,
`‚õî Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ
‚Ä¢ ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ŸÜŸÅÿ≥ ŸàŸÇÿ™ ÿßŸÑÿ¨ÿ±ÿπÿ© ŸäŸàŸÖŸäŸãÿß (ÿ∫ÿßŸÑÿ®Ÿãÿß ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±).
‚Ä¢ ŸÑÿß ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑÿ¨ÿ±ÿπÿ© ÿ®ŸÜŸÅÿ≥ŸÉ.
‚Ä¢ ŸÖÿ™ÿßÿ®ÿπÿ© INR ÿ∂ÿ±Ÿàÿ±Ÿäÿ© (ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑÿ£ŸÉŸÑ ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ ŸÇÿØ Ÿäÿ§ÿ´ÿ±).
‚Ä¢ ÿ™ÿ¨ŸÜŸëÿ® ÿßŸÑÿ£ÿπÿ¥ÿßÿ®/ÿßŸÑŸÖŸÉŸÖŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ®ÿØŸàŸÜ ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ©.`
    )
  },

  doac: {
    keys: ["apixaban","eliquis","rivaroxaban","xarelto","dabigatran","pradaxa","edoxaban","savaysa","lixiana"],
    class: "DOAC",
    risk: "warn",
    advice: () => t(
`‚ö†Ô∏è Anticoagulant (DOAC)
‚Ä¢ Keep consistent schedule.
‚Ä¢ BID (e.g., apixaban) ‚Üí Iftar + Suhoor.
‚Ä¢ OD (e.g., rivaroxaban) ‚Üí Iftar is usually practical (some need food‚Äîfollow label).
‚Ä¢ Missed dose rules differ ‚Üí confirm with pharmacist.`,
`‚ö†Ô∏è Anticoagulant (DOAC)
‚Ä¢ Keep consistent schedule.
‚Ä¢ BID (e.g., apixaban) ‚Üí Iftar + Suhoor.
‚Ä¢ OD (e.g., rivaroxaban) ‚Üí Iftar is usually practical (some need food‚Äîfollow label).
‚Ä¢ Missed-dose rules differ ‚Üí confirm with pharmacist.`,
`‚ö†Ô∏è ŸÖÿ∂ÿßÿØÿßÿ™ ÿßŸÑÿ™ÿÆÿ´ÿ± ÿßŸÑÿ≠ÿØŸäÿ´ÿ© (DOAC)
‚Ä¢ ÿ´ÿ®Ÿëÿ™ ÿßŸÑŸÖŸàÿßÿπŸäÿØ ŸÇÿØÿ± ÿßŸÑÿ•ŸÖŸÉÿßŸÜ.
‚Ä¢ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß (ŸÖÿ´ŸÑ ÿ£ÿ®ŸäŸÉÿ≥ÿßÿ®ÿßŸÜ) ‚Üí ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ±.
‚Ä¢ ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß (ŸÖÿ´ŸÑ ÿ±ŸäŸÅÿßÿ±ŸàŸÉÿ≥ÿßÿ®ÿßŸÜ) ‚Üí ÿ∫ÿßŸÑÿ®Ÿãÿß ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± (ÿ®ÿπÿ∂Ÿáÿß Ÿäÿ≠ÿ™ÿßÿ¨ ŸÖÿπ ÿßŸÑÿ∑ÿπÿßŸÖ‚Äîÿßÿ™ÿ®ÿπ ÿßŸÑŸÜÿ¥ÿ±ÿ©).
‚Ä¢ ŸÇŸàÿßÿπÿØ ŸÜÿ≥ŸäÿßŸÜ ÿßŸÑÿ¨ÿ±ÿπÿ© ÿ™ÿÆÿ™ŸÑŸÅ ‚Üí ÿßÿ≥ÿ£ŸÑ ÿßŸÑÿµŸäÿØŸÑŸä.`
    )
  },

  // Insulin / diabetes
  insulin: {
    keys: ["insulin","lantus","levemir","tresiba","novorapid","humalog","apidra","aspart","lispro","glargine","detemir","degludec","regular insulin","nph","mixtard","humulin","novomix"],
    class: "Insulin",
    risk: "danger",
    advice: () => t(
`‚õî Insulin / ÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ
‚Ä¢ Ramadan insulin adjustment is INDIVIDUAL.
‚Ä¢ Risk of hypoglycemia/dehydration ‚Üí must follow diabetes plan.
‚Ä¢ In general: monitor glucose more, and break fast if low sugar.
üëâ Please consult your diabetes clinic/pharmacist for dose changes.`,
`‚õî Insulin
‚Ä¢ Ramadan adjustment is INDIVIDUAL.
‚Ä¢ Higher hypoglycemia/dehydration risk ‚Üí follow a diabetes plan.
‚Ä¢ Monitor glucose more; break fast if hypoglycemia.
üëâ Consult your diabetes clinic/pharmacist for dosing.`,
`‚õî ÿßŸÑÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ
‚Ä¢ ÿ™ÿπÿØŸäŸÑ ÿ¨ÿ±ÿπÿßÿ™ ÿ±ŸÖÿ∂ÿßŸÜ ‚Äúÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßŸÑÿ©‚Äù ŸàŸÑÿß ŸäŸàÿ¨ÿØ ÿ¨ÿØŸàŸÑ Ÿàÿßÿ≠ÿØ ŸÑŸÑÿ¨ŸÖŸäÿπ.
‚Ä¢ ÿÆÿ∑ÿ± Ÿáÿ®Ÿàÿ∑ ÿßŸÑÿ≥ŸÉÿ±/ÿßŸÑÿ¨ŸÅÿßŸÅ ÿ£ÿπŸÑŸâ ‚Üí ŸÑÿßÿ≤ŸÖ ÿÆÿ∑ÿ© ÿ≥ŸÉÿ±Ÿä.
‚Ä¢ ÿ±ÿßŸÇÿ® ÿßŸÑÿ≥ŸÉÿ± ÿ£ŸÉÿ´ÿ±ÿå ŸàÿßŸÅÿ∑ÿ± ÿ•ÿ∞ÿß ÿ≠ÿØÿ´ Ÿáÿ®Ÿàÿ∑.
üëâ ÿ±ÿßÿ¨ÿπ ÿπŸäÿßÿØÿ© ÿßŸÑÿ≥ŸÉÿ±Ÿä/ÿßŸÑÿµŸäÿØŸÑŸä ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™.`
    )
  },

  // Antibiotics (class)
  antibiotic: {
    keys: ["antibiotic","antibiotics","amoxicillin","augmentin","azithromycin","clarithromycin","ciprofloxacin","levofloxacin","cephalexin","cefuroxime","clindamycin","metronidazole","doxycycline","trimethoprim","co-trimoxazole","bactrim"],
    class: "Antibiotic",
    risk: "warn",
    advice: (freq) => {
      const f = freq || "BID";
      const map = {
        "OD": t(
`‚ö†Ô∏è Antibiotic (OD)
‚Ä¢ Take after Iftar (or as prescribed).
‚Ä¢ Complete the full course.`,
`‚ö†Ô∏è Antibiotic (once daily)
‚Ä¢ Take after Iftar (or as prescribed).
‚Ä¢ Complete the full course.`,
`‚ö†Ô∏è ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä (ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ Ÿäÿ§ÿÆÿ∞ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± (ÿ£Ÿà ÿ≠ÿ≥ÿ® ÿßŸÑŸàÿµŸÅÿ©).
‚Ä¢ ÿ£ŸÉŸÖŸÑ ÿßŸÑŸÉŸàÿ±ÿ≥ ŸÉÿßŸÖŸÑŸãÿß.`
        ),
        "BID": t(
`‚ö†Ô∏è Antibiotic (BID)
‚Ä¢ Iftar + Suhoor (about 12 hours apart if possible).
‚Ä¢ Do not skip doses.`,
`‚ö†Ô∏è Antibiotic (twice daily)
‚Ä¢ Iftar + Suhoor (‚âà12 hours apart if possible).
‚Ä¢ Don‚Äôt skip doses.`,
`‚ö†Ô∏è ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä (ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ± (ŸÇÿ±ÿßÿ®ÿ© 12 ÿ≥ÿßÿπÿ© ÿ•ŸÜ ÿ£ŸÖŸÉŸÜ).
‚Ä¢ ŸÑÿß ÿ™ÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™.`
        ),
        "TID": t(
`‚ö†Ô∏è Antibiotic (TID)
‚Ä¢ Often difficult in Ramadan. Typical approach:
  Iftar + late evening + Suhoor (spacing as evenly as possible).
‚Ä¢ If your prescription is strict ‚Üí ask pharmacist for alternative regimen.`,
`‚ö†Ô∏è Antibiotic (three times daily)
‚Ä¢ Can be difficult in Ramadan:
  Iftar + late evening + Suhoor (as evenly spaced as possible).
‚Ä¢ If strict schedule needed ‚Üí ask pharmacist for an alternative regimen.`,
`‚ö†Ô∏è ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä (3 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ ŸÇÿØ ŸäŸÉŸàŸÜ ÿµÿπÿ® ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ:
  ÿ•ŸÅÿ∑ÿßÿ± + ÿ¢ÿÆÿ± ÿßŸÑŸÑŸäŸÑ + ÿ≥ÿ≠Ÿàÿ± (Ÿàÿ≤ŸëÿπŸáÿß ŸÇÿØÿ± ÿßŸÑÿ•ŸÖŸÉÿßŸÜ).
‚Ä¢ ÿ•ÿ∞ÿß ŸÑÿßÿ≤ŸÖ ÿ™ŸàŸÇŸäÿ™ ÿµÿßÿ±ŸÖ ‚Üí ÿßÿ≥ÿ£ŸÑ ÿßŸÑÿµŸäÿØŸÑŸä ÿπŸÜ ÿ®ÿØŸäŸÑ.`
        ),
        "QID": t(
`‚õî Antibiotic (QID)
‚Ä¢ Usually NOT suitable to compress into fasting hours.
‚Ä¢ Contact pharmacist/doctor to adjust therapy.`,
`‚õî Antibiotic (four times daily)
‚Ä¢ Usually NOT suitable to compress into fasting hours.
‚Ä¢ Contact pharmacist/doctor to adjust therapy.`,
`‚õî ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä (4 ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß ŸÑÿß ŸäŸÜÿßÿ≥ÿ® ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ ŸÅŸä ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±.
‚Ä¢ ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®/ÿßŸÑÿµŸäÿØŸÑŸä ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿÆÿ∑ÿ©.`
        )
      };
      return map[f] || map["BID"];
    }
  },

  // BP meds (class)
  bp: {
    keys: ["blood pressure","bp","hypertension","amlodipine","valsartan","losartan","lisinopril","enalapril","ramipril","bisoprolol","metoprolol","atenolol","hydrochlorothiazide","indapamide","furosemide","spironolactone"],
    class: "Blood pressure",
    risk: "warn",
    advice: (freq) => {
      const f = freq || "OD";
      if (containsAny(normalize(freq||""), ["diuretic","furosemide","hydrochlorothiazide","indapamide"])) {
        // not used directly; kept for future
      }
      const txtOD = t(
`‚ö†Ô∏è Blood pressure meds (OD)
‚Ä¢ Many can be taken after Iftar.
‚Ä¢ If dizziness/low BP ‚Üí hydrate in non-fasting hours and consult clinic.`,
`‚ö†Ô∏è Blood pressure meds (once daily)
‚Ä¢ Many can be taken after Iftar.
‚Ä¢ If dizziness/low BP ‚Üí hydrate in non-fasting hours and consult clinic.`,
`‚ö†Ô∏è ÿ£ÿØŸàŸäÿ© ÿßŸÑÿ∂ÿ∫ÿ∑ (ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ ŸÉÿ´Ÿäÿ± ŸÖŸÜŸáÿß ŸÖŸÜÿßÿ≥ÿ® ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±.
‚Ä¢ ÿ•ÿ∞ÿß ÿØŸàÿÆÿ©/Ÿáÿ®Ÿàÿ∑ ÿ∂ÿ∫ÿ∑ ‚Üí ÿßŸáÿ™ŸÖ ÿ®ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑ Ÿàÿ±ÿßÿ¨ÿπ ÿßŸÑÿπŸäÿßÿØÿ©.`
      );
      const txtBID = t(
`‚ö†Ô∏è Blood pressure meds (BID)
‚Ä¢ Iftar + Suhoor.
‚Ä¢ Watch for dizziness especially with dehydration.`,
`‚ö†Ô∏è Blood pressure meds (twice daily)
‚Ä¢ Iftar + Suhoor.
‚Ä¢ Watch for dizziness especially with dehydration.`,
`‚ö†Ô∏è ÿ£ÿØŸàŸäÿ© ÿßŸÑÿ∂ÿ∫ÿ∑ (ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß)
‚Ä¢ ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ±.
‚Ä¢ ÿßŸÜÿ™ÿ®Ÿá ŸÑŸÑÿØŸàÿÆÿ© ÿÆÿµŸàÿµŸãÿß ŸÖÿπ ŸÇŸÑÿ© ÿßŸÑÿ≥Ÿàÿßÿ¶ŸÑ.`
      );
      return f === "BID" ? txtBID : txtOD;
    }
  },

  // Thyroid
  levothyroxine: {
    keys: ["levothyroxine","thyroxine","eltroxin","euthyrox"],
    class: "Thyroid",
    risk: "warn",
    advice: () => t(
`‚ö†Ô∏è Levothyroxine / ŸÑŸäŸÅŸàÿ´Ÿäÿ±ŸàŸÉÿ≥ŸäŸÜ
‚Ä¢ Take on empty stomach.
‚Ä¢ Options in Ramadan:
  A) 30‚Äì60 min BEFORE Suhoor, OR
  B) 3‚Äì4 hours AFTER Iftar (no food).
‚Ä¢ Keep same routine daily.`,
`‚ö†Ô∏è Levothyroxine
‚Ä¢ Take on empty stomach.
‚Ä¢ Options:
  A) 30‚Äì60 min BEFORE Suhoor, OR
  B) 3‚Äì4 hours AFTER Iftar (no food).
‚Ä¢ Keep same routine daily.`,
`‚ö†Ô∏è ŸÑŸäŸÅŸàÿ´Ÿäÿ±ŸàŸÉÿ≥ŸäŸÜ
‚Ä¢ Ÿäÿ§ÿÆÿ∞ ÿπŸÑŸâ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ©.
‚Ä¢ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™:
  ÿ£) ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ± ÿ®ŸÄ 30‚Äì60 ÿØŸÇŸäŸÇÿ©ÿå ÿ£Ÿà
  ÿ®) ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ÿ®ŸÄ 3‚Äì4 ÿ≥ÿßÿπÿßÿ™ ÿ®ÿØŸàŸÜ ÿ£ŸÉŸÑ.
‚Ä¢ ÿ´ÿ®Ÿëÿ™ ŸÜŸÅÿ≥ ÿßŸÑÿ±Ÿàÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß.`
    )
  },

  // Metformin etc (basic guidance)
  diabetesOrals: {
    keys: ["metformin","gliclazide","glimepiride","sulfonylurea","sitagliptin","linagliptin","dapagliflozin","empagliflozin","canagliflozin","sglt2","dpp4"],
    class: "Diabetes (oral)",
    risk: "warn",
    advice: () => t(
`‚ö†Ô∏è Diabetes tablets
‚Ä¢ Dose changes depend on your glucose control and risk of hypos.
‚Ä¢ Sulfonylureas (e.g., gliclazide/glimepiride) can cause hypoglycemia.
üëâ Please consult diabetes clinic for a Ramadan plan.`,
`‚ö†Ô∏è Diabetes tablets
‚Ä¢ Dose changes depend on control and hypoglycemia risk.
‚Ä¢ Sulfonylureas (e.g., gliclazide/glimepiride) can cause hypos.
üëâ Consult diabetes clinic for a Ramadan plan.`,
`‚ö†Ô∏è ÿ£ÿØŸàŸäÿ© ÿßŸÑÿ≥ŸÉÿ±Ÿä ÿßŸÑŸÅŸÖŸàŸäÿ©
‚Ä¢ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ Ÿäÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸàÿÆÿ∑ÿ± ÿßŸÑŸáÿ®Ÿàÿ∑.
‚Ä¢ ÿßŸÑÿ≥ŸÑŸÅŸàŸÜŸäŸÑ ŸäŸàÿ±Ÿäÿß (ŸÖÿ´ŸÑ ÿ¨ŸÑŸäŸÉŸÑÿßÿ≤ÿßŸäÿØ/ÿ¨ŸÑŸäŸÖÿ®Ÿäÿ±ÿßŸäÿØ) ŸÇÿØ ÿ™ÿ≥ÿ®ÿ® Ÿáÿ®Ÿàÿ∑.
üëâ ÿ±ÿßÿ¨ÿπ ÿπŸäÿßÿØÿ© ÿßŸÑÿ≥ŸÉÿ±Ÿä ŸÑÿÆÿ∑ÿ© ÿ±ŸÖÿ∂ÿßŸÜ.`
    )
  }
};

/* ==== Helper: classify input ==== */
function classify(text){
  const s = normalize(text);

  // Special quick class keywords
  const classHints = [
    { k:["ppi","acid","heartburn","gerd","ŸÖÿπÿØÿ©","ÿ≠ŸÖŸàÿ∂ÿ©"], tag:"ppi" },
    { k:["warfarin","Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ"], tag:"warfarin" },
    { k:["insulin","ÿßŸÜÿ≥ŸàŸÑŸäŸÜ","ÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ"], tag:"insulin" },
    { k:["antibiotic","ŸÖÿ∂ÿßÿØ","ŸÖÿ∂ÿßÿØÿßÿ™"], tag:"antibiotic" },
    { k:["blood pressure","ÿ∂ÿ∫ÿ∑","hypertension","bp"], tag:"bp" },
    { k:["thyroxine","levothyroxine","ÿ∫ÿØÿ©","ÿØÿ±ŸÇŸäÿ©"], tag:"levothyroxine" },
    { k:["apixaban","rivaroxaban","dabigatran","eliquis","xarelto","pradaxa","ŸÖÿ∂ÿßÿØ ÿ™ÿÆÿ´ÿ±"], tag:"doac" },
    { k:["metformin","ÿ≥ŸÉÿ±","diabetes","sglt2","dpp4","gliclazide"], tag:"diabetesOrals" },
  ];

  for (const h of classHints){
    if (containsAny(s, h.k.map(normalize))) return h.tag;
  }

  // Direct KB match by keys
  for (const key in KB){
    const item = KB[key];
    if (item.keys && containsAny(s, item.keys.map(normalize))) return key;
  }

  return null;
}

function isFreqToken(s){
  const x = normalize(s);
  return ["od","qd","once","once daily","bid","twice","twice daily","tid","three times","three times daily","qid","four times","four times daily",
          "ŸÖÿ±ÿ©","ŸÖÿ±Ÿá","ŸÖÿ±ÿ™ŸäŸÜ","ÿ´ŸÑÿßÿ´","ÿ´ŸÑÿßÿ´ ŸÖÿ±ÿßÿ™","4 ŸÖÿ±ÿßÿ™","ÿßÿ±ÿ®ÿπ","ÿ£ÿ±ÿ®ÿπ"].some(k => x === k || x.includes(k));
}

function parseFreq(text){
  const s = normalize(text);

  // English
  if (s.includes("qid") || s.includes("four")) return "QID";
  if (s.includes("tid") || s.includes("three")) return "TID";
  if (s.includes("bid") || s.includes("twice")) return "BID";
  if (s.includes("od") || s.includes("qd") || s.includes("once")) return "OD";

  // Arabic
  if (s.includes("ÿ£ÿ±ÿ®ÿπ") || s.includes("ÿßÿ±ÿ®ÿπ") || s.includes("4")) return "QID";
  if (s.includes("ÿ´ŸÑÿßÿ´")) return "TID";
  if (s.includes("ŸÖÿ±ÿ™ŸäŸÜ")) return "BID";
  if (s.includes("ŸÖÿ±ÿ©") || s.includes("ŸÖÿ±Ÿá")) return "OD";

  return null;
}

/* ==== Response generator ==== */
function respondTo(text){
  const s = normalize(text);

  // If we are waiting for frequency answer
  if (state.pending && state.pending.kind === "ask_freq"){
    const freq = parseFreq(s);
    if (!freq){
      return {
        type:"warn",
        text: t(
`I still need the frequency üòä
Type: OD / BID / TID / QID  (or: ŸÖÿ±ÿ© / ŸÖÿ±ÿ™ŸäŸÜ / ÿ´ŸÑÿßÿ´ / ÿ£ÿ±ÿ®ÿπ)`,
`I still need the frequency üòä
Type: OD / BID / TID / QID (or Arabic: ŸÖÿ±ÿ©/ŸÖÿ±ÿ™ŸäŸÜ/ÿ´ŸÑÿßÿ´/ÿ£ÿ±ÿ®ÿπ)`,
`ŸÑÿßÿ≤ŸÖ ÿ£ÿπÿ±ŸÅ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ™ üòä
ÿßŸÉÿ™ÿ®: OD / BID / TID / QID  ÿ£Ÿà (ŸÖÿ±ÿ© / ŸÖÿ±ÿ™ŸäŸÜ / ÿ´ŸÑÿßÿ´ / ÿ£ÿ±ÿ®ÿπ)`
        ),
        keepPending:true
      };
    }

    const tag = state.pending.payload.tag;
    const item = KB[tag];
    state.pending = null;

    if (tag === "antibiotic" || tag === "bp"){
      return {
        type: item.risk,
        text: item.advice(freq)
      };
    }

    // For unknown class we just give generic by freq
    return {
      type:"good",
      text: genericByFreq(freq)
    };
  }

  // Greetings / help
  if (containsAny(s, ["hi","hello","ÿßŸÑÿ≥ŸÑÿßŸÖ","ŸÖÿ±ÿ≠ÿ®ÿß","ŸáŸÑÿß","ÿßŸáŸÑÿß","ŸÖÿ≥ÿßÿ°","ÿµÿ®ÿßÿ≠"])){
    return {
      type:"good",
      text: t(
`Hi üëã / ŸÖÿ±ÿ≠ÿ®Ÿãÿß
Type a medication name (e.g., omeprazole, warfarin) or a class (antibiotic, PPI).
If needed, I will ask for frequency (OD/BID/TID/QID).`,
`Hi üëã
Type a medication name (e.g., omeprazole, warfarin) or a class (antibiotic, PPI).
If needed, I will ask for frequency (OD/BID/TID/QID).`,
`ŸÖÿ±ÿ≠ÿ®Ÿãÿß üëã
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° (ŸÖÿ´ŸÑ: ÿ£ŸàŸÖŸäÿ®ÿ±ÿßÿ≤ŸàŸÑÿå Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ) ÿ£Ÿà ŸÅÿ¶ÿ© ÿßŸÑÿØŸàÿßÿ° (ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸäÿå ÿ£ÿØŸàŸäÿ© ŸÖÿπÿØÿ©).
ÿ•ÿ∞ÿß ÿßÿ≠ÿ™ÿ¨ÿ™ ÿ®ÿ≥ÿ£ŸÑŸÉ ÿπŸÜ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ™ (OD/BID/TID/QID).`
      )
    };
  }

  // Identify category
  const tag = classify(s);
  if (tag){
    const item = KB[tag];

    // Some classes require frequency for best advice
    if (tag === "antibiotic" || tag === "bp"){
      // ask freq
      state.pending = { kind:"ask_freq", payload:{ tag } };
      return {
        type:"warn",
        text: t(
`I recognized: ${item.class} / ÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ: ${item.class}
How many times per day? (OD/BID/TID/QID)`,
`I recognized: ${item.class}
How many times per day? (OD/BID/TID/QID)`,
`ÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ: ${item.class}
ŸÉŸÖ ŸÖÿ±ÿ© ÿ®ÿßŸÑŸäŸàŸÖÿü (OD/BID/TID/QID)`
      };
    }

    return { type: item.risk, text: item.advice() };
  }

  // If looks like they typed only frequency without context
  if (isFreqToken(s)){
    const freq = parseFreq(s);
    return { type:"good", text: genericByFreq(freq || "BID") };
  }

  // Unknown ‚Üí ask class or frequency
  state.pending = { kind:"ask_freq", payload:{ tag: null } };
  return {
    type:"warn",
    text: t(
`I couldn't match that medication yet.
Please type a class (PPI / antibiotic / blood pressure / insulin / anticoagulant),
or tell me the frequency: OD/BID/TID/QID.`,
`I couldn't match that medication yet.
Type a class (PPI / antibiotic / blood pressure / insulin / anticoagulant),
or tell me the frequency: OD/BID/TID/QID.`,
`ŸÖÿß ŸÇÿØÿ±ÿ™ ÿ£ÿ≠ÿØÿØ ÿßŸÑÿØŸàÿßÿ°.
ÿßŸÉÿ™ÿ® ŸÅÿ¶ÿ© ÿßŸÑÿØŸàÿßÿ° (ŸÖÿπÿØÿ©/PPI ÿ£Ÿà ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä ÿ£Ÿà ÿ∂ÿ∫ÿ∑ ÿ£Ÿà ÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ ÿ£Ÿà ŸÖÿ∂ÿßÿØ ÿ™ÿÆÿ´ÿ±)
ÿ£Ÿà ÿßŸÉÿ™ÿ® ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ™: OD/BID/TID/QID.`
    )
  };
}

function genericByFreq(freq){
  const f = freq || "BID";
  const map = {
    "OD": t(
`‚úÖ Once daily (OD)
‚Ä¢ ÿπÿßÿØÿ©: ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸÖŸÜÿßÿ≥ÿ®.
‚Ä¢ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿØŸàŸäÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ© (ŸÖÿ´ŸÑ PPI ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ±).
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ŸÑÿ£ÿπÿ∑ŸäŸÉ ÿ™ŸàŸÇŸäÿ™ ÿ£ÿØŸÇ.`,
`‚úÖ Once daily (OD)
‚Ä¢ Often: after Iftar is practical.
‚Ä¢ Some need empty stomach (e.g., PPI before Suhoor).
Type the drug name for a more specific plan.`,
`‚úÖ ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß (OD)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸÖŸÜÿßÿ≥ÿ®.
‚Ä¢ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿØŸàŸäÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ© (ŸÖÿ´ŸÑ PPI ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ±).
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ÿπÿ¥ÿßŸÜ ÿ£ÿπÿ∑ŸäŸÉ ÿÆÿ∑ÿ© ÿ£ÿØŸÇ.`
    ),
    "BID": t(
`‚úÖ Twice daily (BID)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß: ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ± (ÿ™ŸÇÿ±Ÿäÿ®Ÿãÿß 12 ÿ≥ÿßÿπÿ© ÿ•ÿ∞ÿß ÿ£ŸÖŸÉŸÜ).
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ŸÑÿ£ÿπÿ∑ŸäŸÉ ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™ ÿÆÿßÿµÿ©.`,
`‚úÖ Twice daily (BID)
‚Ä¢ Typically: Iftar + Suhoor (~12h apart if possible).
Type the drug name for specific cautions.`,
`‚úÖ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß (BID)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß: ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ± (ÿ≠ŸàÿßŸÑŸä 12 ÿ≥ÿßÿπÿ© ÿ•ŸÜ ÿ£ŸÖŸÉŸÜ).
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ŸÑÿ£ÿπÿ∑ŸäŸÉ ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßÿ™ ÿÆÿßÿµÿ©.`
    ),
    "TID": t(
`‚ö†Ô∏è Three times daily (TID)
‚Ä¢ ÿßŸÅÿ∑ÿßÿ± + ÿ¢ÿÆÿ± ÿßŸÑŸÑŸäŸÑ + ÿ≥ÿ≠Ÿàÿ± (ŸÇÿ≥ŸëŸÖŸáÿß ŸÇÿØÿ± ÿßŸÑÿ•ŸÖŸÉÿßŸÜ).
‚Ä¢ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿØŸàŸäÿ© ŸÑÿß ŸäŸÜÿµÿ≠ ÿ®ÿ™ÿ∫ŸäŸäÿ±Ÿáÿß ‚Üí ÿ±ÿßÿ¨ÿπ ÿßŸÑÿµŸäÿØŸÑŸä.`,
`‚ö†Ô∏è Three times daily (TID)
‚Ä¢ Iftar + late evening + Suhoor (space as evenly as possible).
‚Ä¢ Some meds shouldn‚Äôt be adjusted ‚Üí confirm with pharmacist.`,
`‚ö†Ô∏è ÿ´ŸÑÿßÿ´ ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß (TID)
‚Ä¢ ÿ•ŸÅÿ∑ÿßÿ± + ÿ¢ÿÆÿ± ÿßŸÑŸÑŸäŸÑ + ÿ≥ÿ≠Ÿàÿ± (Ÿàÿ≤ŸëÿπŸáÿß ŸÇÿØÿ± ÿßŸÑÿ•ŸÖŸÉÿßŸÜ).
‚Ä¢ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿØŸàŸäÿ© ŸÑÿß ÿ™ŸèÿπÿØŸëŸÑ ÿ®ÿ≥ŸáŸàŸÑÿ© ‚Üí ÿßÿ≥ÿ£ŸÑ ÿßŸÑÿµŸäÿØŸÑŸä.`
    ),
    "QID": t(
`‚õî Four times daily (QID)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß ŸÑÿß ŸäŸÜÿßÿ≥ÿ® ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ.
‚Ä¢ ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®/ÿßŸÑÿµŸäÿØŸÑŸä ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ.`,
`‚õî Four times daily (QID)
‚Ä¢ Often NOT suitable to compress within non-fasting hours.
‚Ä¢ Contact doctor/pharmacist to adjust regimen.`,
`‚õî ÿ£ÿ±ÿ®ÿπ ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß (QID)
‚Ä¢ ÿ∫ÿßŸÑÿ®Ÿãÿß ŸÑÿß ŸäŸÜÿßÿ≥ÿ® ÿ∂ÿ∫ÿ∑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ.
‚Ä¢ ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ∑ÿ®Ÿäÿ®/ÿßŸÑÿµŸäÿØŸÑŸä ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ.`
    ),
  };
  return map[f] || map["BID"];
}

/* ==== UI wiring ==== */
function boot(){
  chatBody.innerHTML = "";
  state.pending = null;
  setStatus("good", "Ready");

  addMsg("bot", t(
`Welcome üëã
Type a medication name (e.g., omeprazole / warfarin / insulin) or a class (antibiotic, PPI, blood pressure).
I‚Äôll guide you for Ramadan timing.`,
`Welcome üëã
Type a medication name (e.g., omeprazole / warfarin / insulin) or a class (antibiotic, PPI, blood pressure).
I‚Äôll guide you for Ramadan timing.`,
`ÿ£ŸáŸÑŸãÿß üëã
ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° (ŸÖÿ´ŸÑ ÿ£ŸàŸÖŸäÿ®ÿ±ÿßÿ≤ŸàŸÑ/Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ/ÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ) ÿ£Ÿà ŸÅÿ¶ÿ© (ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä/ÿ£ÿØŸàŸäÿ© ŸÖÿπÿØÿ©/PPI/ÿ∂ÿ∫ÿ∑).
Ÿàÿ£ÿπÿ∑ŸäŸÉ ÿ™ŸàŸÇŸäÿ™ ŸÖŸÜÿßÿ≥ÿ® ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ.`
  ));
}

function handleSend(){
  const text = input.value.trim();
  if (!text) return;

  addMsg("me", text);
  input.value = "";

  try{
    setStatus("good", "Thinking‚Ä¶");
    const res = respondTo(text);

    setStatus(res.type || "good", res.type === "danger" ? "High-risk" : res.type === "warn" ? "Caution" : "OK");
    addMsg("bot", res.text);

    if (res.keepPending){
      // keep status as caution
      setStatus("warn", "Need frequency");
    }
  } catch (e){
    console.error(e);
    setStatus("danger", "Error");
    addMsg("bot", t(
`‚õî Something went wrong. Please try again or reset.`,
`‚õî Something went wrong. Please try again or reset.`,
`‚õî ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. ÿ¨ÿ±Ÿëÿ® ŸÖÿ±ÿ© ÿ´ÿßŸÜŸäÿ© ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ Reset.`
    ));
  }
}

/* Enter key to send */
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") handleSend();
});
sendBtn.addEventListener("click", handleSend);
resetBtn.addEventListener("click", boot);

/* Changing language/role resets conversation for clarity */
langSel.addEventListener("change", boot);
roleSel.addEventListener("change", () => {
  // role affects future expansion; for now we just reset
  boot();
});

document.addEventListener("DOMContentLoaded", () => {
  // Safety check: make sure required elements exist
  const missing = [];
  ["chatBody","userInput","sendBtn","resetBtn","lang","role","statusPill"].forEach(id=>{
    if (!document.getElementById(id)) missing.push(id);
  });

  if (missing.length){
    alert("Missing elements: " + missing.join(", ") + "\nCheck IDs in HTML.");
    return;
  }

  // Re-bind elements (in case script ran before DOM)
  // (Keep your existing code as-is, this just ensures init runs after DOM)
  boot();
});

