<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCH â€“ Smart Ramadan Medication Assistant</title>
  <meta name="description" content="Qatif Central Hospital â€“ Ramadan Medication Assistant (Arabic/English)." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#dfeef8">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f7fcff;
      --panel:#ffffff;
      --stroke:#cfe0ec;
      --stroke2:#bcd2e2;
      --text:#0f2a3a;
      --muted:#466274;

      --bubble:#eaf4fb;
      --bubble2:#dff0fb;

      --btn:#6bb6d6;
      --btnText:#0a2230;

      --shadow: 0 10px 35px rgba(15,42,58,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7fcff, #eef7ff);
      color: var(--text);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px;}

    /* Header with logos right & left */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:18px 18px;
      border:2px solid var(--stroke);
      background: rgba(255,255,255,.90);
      border-radius: 28px;
      box-shadow: var(--shadow);
    }
    .logoBox{
      background:#fff;
      border-radius:18px;
      border:1px solid var(--stroke);
      padding:10px 20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logoBox img{
      height:110px; /* âœ… BIG LOGO: change 110 -> 130 if you want bigger */
      width:auto;
      object-fit:contain;
      display:block;
    }
    .titleBox{
      flex:1;
      text-align:center;
      line-height:1.2;
      padding:0 10px;
    }
    .titleBox h1{margin:0; font-size:22px; font-weight:900;}
    .titleBox .sub{margin-top:6px; font-size:14px; color:var(--muted);}

    /* Top action buttons */
    .topBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .pillBtn{
      border:1px solid var(--stroke2);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
    }
    .pillBtn:hover{filter:brightness(0.98)}
    .pillBtn.primary{
      background: linear-gradient(180deg, #e7f6ff, #d8eefc);
      border-color:#9ec7dd;
      font-weight:800;
    }

    /* Layout: main chat + right panel */
    .grid{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
      .logoBox img{height:85px;}
    }

    .card{
      border:2px solid var(--stroke);
      border-radius: 28px;
      background: rgba(255,255,255,.90);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(223,240,251,.70), rgba(255,255,255,.55));
    }
    .cardHead .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .cardHead .title{font-weight:900; font-size:16px;}
    .cardHead .hint{font-size:13px; color:var(--muted);}
    .status{font-size:13px; color:var(--muted);}

    #chat{
      padding:16px;
      min-height: 560px;
      max-height: 560px;
      overflow:auto;
      background: linear-gradient(180deg, rgba(245,251,255,.75), rgba(232,245,255,.55));
    }

    /* Bubbles like your screenshot */
    .msg{display:flex; flex-direction:column; gap:10px; margin:14px 0;}
    .msg.bot{align-items:stretch;}
    .msg.user{align-items:flex-start;}

    .bubble{
      border-radius: 22px;
      border:2px solid var(--stroke);
      background: radial-gradient(140% 160% at 50% 0%, rgba(255,255,255,.95), var(--bubble));
      padding:18px 18px;
      box-shadow: 0 8px 22px rgba(15,42,58,.08);
      line-height:1.9;
      font-size:18px;
    }
    .bubble.user{
      background: radial-gradient(140% 160% at 50% 0%, rgba(255,255,255,.95), var(--bubble2));
    }

    .botTitle{
      font-weight:950;
      font-size:22px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .metaLine{
      font-size:17px;
      color: #1c3a4d;
      margin:6px 0 0 0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background:#fff;
      color:#17374a;
      font-weight:800;
      font-size:14px;
    }
    .warn{
      border:1px solid #f3d08a;
      background: #fff7df;
      color:#6a4b00;
    }
    .ok{
      border:1px solid #bfe7c8;
      background:#effbf2;
      color:#165a2b;
    }

    .sectionText{font-size:18px; margin-top:10px;}
    .finePrint{
      font-size:15px;
      color: var(--muted);
      border-top:1px solid var(--stroke);
      margin-top:14px;
      padding-top:10px;
      line-height:1.8;
    }

    .actionsRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .copyBtn{
      border:1px solid var(--stroke2);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-size:15px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
      width: fit-content;
    }

    /* Composer */
    .composer{
      display:flex;
      gap:14px;
      padding:16px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.80);
      align-items:center;
    }
    #userInput{
      flex:1;
      padding:18px 18px;
      border-radius: 22px;
      border:2px solid var(--stroke);
      background:#fff;
      font-size:18px;
      outline:none;
    }
    #sendBtn{
      padding:18px 22px;
      border-radius: 22px;
      border:0;
      background: var(--btn);
      color: #083047;
      font-size:18px;
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(107,182,214,.35);
    }

    /* Right panel */
    .panelBody{padding:14px;}
    .panelTitle{font-weight:950; font-size:16px; margin:0 0 8px 0;}
    .chips{display:flex; gap:10px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--stroke2);
      background:#fff;
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
    }
    .chip:hover{filter:brightness(0.98)}
    .kpis{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .kpi{
      border:1px solid var(--stroke2);
      border-radius: 18px;
      padding:12px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
    }
    .kpi .num{font-size:22px; font-weight:950;}
    .kpi .lbl{font-size:13px; color:var(--muted); margin-top:4px;}

    .notes{
      margin-top:12px;
      color:var(--muted);
      font-size:14px;
      line-height:1.8;
    }

    .footer{
      margin-top:12px;
      text-align:center;
      color: var(--muted);
      font-size:13px;
      padding:10px 0 2px 0;
    }

    /* Modal */
    #topModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;}
    .modalBox{
      max-width:560px;
      margin: 10vh auto;
      background:#fff;
      border-radius: 22px;
      border:2px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:18px;}
    .row{display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--stroke); font-size:16px;}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header -->
    <div class="header">
      <!-- RIGHT (RTL) -->
      <div class="logoBox" title="QCH">
        <img src="logo_qch.png" alt="QCH Logo">
      </div>

      <div class="titleBox">
        <h1 id="appTitle">QCH â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©</h1>
        <div class="sub" id="appSub">Ø¹Ø±Ø¨ÙŠ / Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Â· Ø³Ù‡Ù„ Ù„Ù„Ù…Ø±ÙŠØ¶ Â· ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ©</div>
      </div>

      <!-- LEFT -->
      <div class="logoBox" title="Health Holding Company">
        <img src="logo_health_holding.png" alt="Health Holding Logo">
      </div>
    </div>

    <div class="topBtns">
      <button id="langBtn" class="pillBtn primary" type="button">ğŸŒ English</button>
      <button id="topBtn" class="pillBtn" type="button">ğŸ“Š Top 10</button>
      <button id="installBtn" class="pillBtn" type="button" style="display:none;">â¬‡ï¸ Install</button>
    </div>

    <div class="grid">

      <!-- Chat -->
      <div class="card">
        <div class="cardHead">
          <div class="left">
            <div class="title" id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
            <div class="hint" id="chatHint">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
          </div>
          <div class="status" id="statusHint">â€¦</div>
        </div>

        <div id="chat"></div>

        <div class="composer">
          <input id="userInput" list="drugHints" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§â€¦" autocomplete="off" />
          <datalist id="drugHints"></datalist>
          <button id="sendBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>

      <!-- Right panel: easy icon buttons -->
      <div class="card">
        <div class="cardHead">
          <div class="left">
            <div class="title" id="panelTitle">Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø©</div>
            <div class="hint" id="panelHint">Ø§Ø¶ØºØ· Ø²Ø± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</div>
          </div>
          <div class="status" id="panelStatus">Patient-friendly</div>
        </div>

        <div class="panelBody">
          <div class="panelTitle" id="quickTitle">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <div class="chips" id="chips"></div>

          <div class="panelTitle" style="margin-top:14px;" id="analyticsTitle">Analytics (local)</div>
          <div class="kpis">
            <div class="kpi">
              <div class="num" id="kpiUsed">0</div>
              <div class="lbl" id="kpiUsedLbl">Tracked selections</div>
            </div>
            <div class="kpi">
              <div class="num" id="kpiDrugs">0</div>
              <div class="lbl" id="kpiDrugsLbl">Drugs loaded</div>
            </div>
          </div>

          <div class="notes" id="notesBox">
            â€¢ This tool provides general guidance only.<br>
            â€¢ Always follow the clinician plan.<br>
            â€¢ For emergencies, contact your hospital/911.
          </div>

          <div class="footer" id="footerText">Created by Automation Supervisor Ali Alsada</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Top 10 modal -->
  <div id="topModal">
    <div class="modalBox">
      <div class="modalHead">
        <h3 id="topTitle">ğŸ“Š Top 10 Ø£Ø¯ÙˆÙŠØ©</h3>
        <button id="topClose" class="pillBtn" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="topList"></div>
      <div style="margin-top:10px; color:var(--muted); font-size:13px;" id="topNote">
        ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ØªØµÙØ­ (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±).
      </div>
    </div>
  </div>

  <script>
    // ================= Language =================
    let LANG = "ar"; // start Arabic
    const T = {
      ar: {
        dir:"rtl", htmlLang:"ar",
        langBtn:"ğŸŒ English",
        appTitle:"QCH â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©",
        appSub:"Ø¹Ø±Ø¨ÙŠ / Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Â· Ø³Ù‡Ù„ Ù„Ù„Ù…Ø±ÙŠØ¶ Â· ØªØ­Ù„ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ©",
        chatTitle:"Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©",
        chatHint:"Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©",
        panelTitle:"Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø©",
        panelHint:"Ø§Ø¶ØºØ· Ø²Ø± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡",
        statusLoading:"Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ drugs.jsonâ€¦",
        statusReady:"Ready",
        inputPh:"Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§â€¦",
        send:"Ø¥Ø±Ø³Ø§Ù„",
        you:"Ø£Ù†Øª",
        welcomeTitle:"Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹",
        welcome:"Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ. Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ Ø±Ù…Ø¶Ø§Ù†.",
        copy:"ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø¯",
        copied:"âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®",
        topTitle:"ğŸ“Š Top 10 Ø£Ø¯ÙˆÙŠØ©",
        topEmpty:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø§Øª ÙˆØ³ÙŠØªÙƒÙˆÙ‘Ù† Top 10 ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.",
        disclaimer:"ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ«Ù‚ÙŠÙ ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ. Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙƒ Ø³ÙƒØ± Ø¹Ù„Ù‰ Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/Ø£Ø¯ÙˆÙŠØ© Ø³ÙŠÙˆÙ„Ø©ØŒ Ø£Ùˆ Ù…Ø±Ø¶ ÙƒÙ„Ù‰/Ù‚Ù„Ø¨â€”Ø§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ùƒ Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„.",
        classLabel:"Ø§Ù„ØªØµÙ†ÙŠÙ",
        notesLabel:"Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
        ramadanLabel:"ØªÙˆÙ‚ÙŠØª Ø±Ù…Ø¶Ø§Ù†",
        missing:"Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù….",
        analyticsTitle:"Analytics (local)",
        usedLbl:"Tracked selections",
        drugsLbl:"Drugs loaded",
        footer:"Created by Automation Supervisor Ali Alsada",
        chips: [
          {k:"top",   label:"â­ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©", q:"__TOP__"},
          {k:"dm",    label:"ğŸ©¸ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø³ÙƒØ±",     q:"__CAT__:Diabetes"},
          {k:"bp",    label:"â¤ï¸ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¶ØºØ·",     q:"__CAT__:Hypertension"},
          {k:"pain",  label:"ğŸŸ¦ Ù…Ø³ÙƒÙ†Ø§Øª",          q:"__CAT__:Pain"},
          {k:"abx",   label:"ğŸ§« Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ©",    q:"__CAT__:Antibiotic"},
          {k:"gi",    label:"ğŸ«§ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø¹Ø¯Ø©",    q:"__CAT__:GI"},
          {k:"war",   label:"âš ï¸ ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†",        q:"warfarin"},
          {k:"tips",  label:"ğŸ•’ Ù†ØµØ§Ø¦Ø­ Ø±Ù…Ø¶Ø§Ù†",      q:"__RAMADAN_TIPS__"}
        ]
      },
      en: {
        dir:"ltr", htmlLang:"en",
        langBtn:"ğŸŒ Arabic",
        appTitle:"QCH â€“ Smart Ramadan Medication Assistant",
        appSub:"Arabic / English Â· Patient-friendly Â· Offline analytics",
        chatTitle:"Chat",
        chatHint:"Type the medication name and get autocomplete while typing",
        panelTitle:"Quick Buttons",
        panelHint:"Tap a button or type a medication name",
        statusLoading:"Loading drugs.jsonâ€¦",
        statusReady:"Ready",
        inputPh:"Type medication name hereâ€¦",
        send:"Send",
        you:"You",
        welcomeTitle:"Hello ğŸ‘‹",
        welcome:"Iâ€™m the Ramadan Medication Assistant. Type a medication name and Iâ€™ll give general timing guidance for Ramadan.",
        copy:"ğŸ“‹ Copy reply",
        copied:"âœ… Copied",
        topTitle:"ğŸ“Š Top 10 meds",
        topEmpty:"No data yet. Use the chat and it will auto-build Top 10.",
        disclaimer:"Note: General guidance only, not a substitute for a clinician/pharmacist. If you use insulin/anticoagulants, or have kidney/heart diseaseâ€”consult your clinician before changes.",
        classLabel:"Class",
        notesLabel:"Notes",
        ramadanLabel:"Ramadan timing",
        missing:"I couldnâ€™t find this medication in the list. Try English name or part of the name.",
        analyticsTitle:"Analytics (local)",
        usedLbl:"Tracked selections",
        drugsLbl:"Drugs loaded",
        footer:"Created by Automation Supervisor Ali Alsada",
        chips: [
          {k:"top",   label:"â­ Common meds",      q:"__TOP__"},
          {k:"dm",    label:"ğŸ©¸ Diabetes meds",    q:"__CAT__:Diabetes"},
          {k:"bp",    label:"â¤ï¸ Blood pressure",   q:"__CAT__:Hypertension"},
          {k:"pain",  label:"ğŸŸ¦ Pain relief",      q:"__CAT__:Pain"},
          {k:"abx",   label:"ğŸ§« Antibiotics",      q:"__CAT__:Antibiotic"},
          {k:"gi",    label:"ğŸ«§ Stomach / GI",     q:"__CAT__:GI"},
          {k:"war",   label:"âš ï¸ Warfarin",         q:"warfarin"},
          {k:"tips",  label:"ğŸ•’ Ramadan tips",      q:"__RAMADAN_TIPS__"}
        ]
      }
    };

    function applyLang(){
      document.documentElement.dir = T[LANG].dir;
      document.documentElement.lang = T[LANG].htmlLang;

      document.getElementById("langBtn").textContent = T[LANG].langBtn;
      document.getElementById("appTitle").textContent = T[LANG].appTitle;
      document.getElementById("appSub").textContent = T[LANG].appSub;

      document.getElementById("chatTitle").textContent = T[LANG].chatTitle;
      document.getElementById("chatHint").textContent = T[LANG].chatHint;

      document.getElementById("panelTitle").textContent = T[LANG].panelTitle;
      document.getElementById("panelHint").textContent = T[LANG].panelHint;

      document.getElementById("userInput").placeholder = T[LANG].inputPh;
      document.getElementById("sendBtn").textContent = T[LANG].send;

      document.getElementById("topTitle").textContent = T[LANG].topTitle;

      document.getElementById("analyticsTitle").textContent = T[LANG].analyticsTitle;
      document.getElementById("kpiUsedLbl").textContent = T[LANG].usedLbl;
      document.getElementById("kpiDrugsLbl").textContent = T[LANG].drugsLbl;

      document.getElementById("footerText").textContent = T[LANG].footer;

      renderChips();
    }

    // ================= Analytics (local) =================
    function trackDrugUse(drugKey){
      try{
        const key = "qch_drug_analytics_v1";
        const db = JSON.parse(localStorage.getItem(key) || "{}");
        db[drugKey] = (db[drugKey] || 0) + 1;
        localStorage.setItem(key, JSON.stringify(db));
        updateKpis();
      }catch(e){}
    }
    function getTopDrugs(limit=10){
      const key = "qch_drug_analytics_v1";
      const db = JSON.parse(localStorage.getItem(key) || "{}");
      return Object.entries(db).sort((a,b)=>b[1]-a[1]).slice(0, limit);
    }
    function getTotalTracked(){
      const key = "qch_drug_analytics_v1";
      const db = JSON.parse(localStorage.getItem(key) || "{}");
      return Object.values(db).reduce((a,b)=>a+b,0);
    }

    // ================= Helpers =================
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function scrollChat(){
      const c = document.getElementById("chat");
      c.scrollTop = c.scrollHeight;
    }

    // ================= Chat UI =================
    function addUserMessage(text){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg user";

      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.innerHTML = `<div style="font-weight:950; margin-bottom:6px;">${T[LANG].you} : ${escapeHtml(text)}</div>`;

      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollChat();
    }

    function addBotBubble(html, copyText){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg bot";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = html;

      const actions = document.createElement("div");
      actions.className = "actionsRow";

      const copyBtn = document.createElement("button");
      copyBtn.className = "copyBtn";
      copyBtn.type = "button";
      copyBtn.textContent = T[LANG].copy;
      copyBtn.onclick = async () => {
        const text = copyText || bubble.innerText;
        try{
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=> copyBtn.textContent = T[LANG].copy, 1200);
        }catch(e){
          const ta = document.createElement("textarea");
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy");
          document.body.removeChild(ta);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=> copyBtn.textContent = T[LANG].copy, 1200);
        }
      };

      actions.appendChild(copyBtn);
      wrap.appendChild(bubble);
      wrap.appendChild(actions);
      chat.appendChild(wrap);
      scrollChat();
    }

    function addWelcome(){
      const html = `
        <div class="botTitle">${escapeHtml(T[LANG].welcomeTitle)}</div>
        <div class="sectionText">${escapeHtml(T[LANG].welcome)}</div>
      `;
      addBotBubble(html, T[LANG].welcome);
    }

    // ================= Drugs + Autocomplete =================
    let DRUGS = [];
    function setDrugs(drugs){
      DRUGS = Array.isArray(drugs) ? drugs : [];
      document.getElementById("kpiDrugs").textContent = String(DRUGS.length || 0);
    }

    function normalize(s){
      return (s||"").toString().trim().toLowerCase();
    }

    function updateHints(q){
      const dl = document.getElementById("drugHints");
      dl.innerHTML = "";
      const query = normalize(q);
      if(query.length < 2) return;

      const matches = [];
      for(const d of DRUGS){
        const name = normalize(d.name);
        const brand = normalize(d.brand);
        const nameAr = normalize(d.name_ar);
        const strength = normalize(d.strength);

        if(name.includes(query) || brand.includes(query) || nameAr.includes(query)){
          matches.push(d);
          if(matches.length >= 12) break;
        }
      }

      for(const m of matches){
        const label = (LANG==="ar" && m.name_ar) ? m.name_ar : m.name;
        const opt = document.createElement("option");
        opt.value = (label || m.name || "") + (m.strength ? ` ${m.strength}` : "");
        dl.appendChild(opt);
      }
    }

    async function loadDrugsJson(){
      const status = document.getElementById("statusHint");
      status.textContent = T[LANG].statusLoading;
      try{
        const res = await fetch("drugs.json", {cache:"no-store"});
        if(!res.ok) throw new Error("no drugs.json");
        const data = await res.json();
        setDrugs(data);
        status.textContent = T[LANG].statusReady;
      }catch(e){
        setDrugs([]);
        status.textContent = "drugs.json not found";
      }
    }

    function findDrug(q){
      const query = normalize(q);
      if(!query) return null;

      // Exact: name + strength (any language)
      for(const d of DRUGS){
        const k1 = normalize((d.name||"") + " " + (d.strength||""));
        const k2 = normalize((d.name_ar||"") + " " + (d.strength||""));
        if(k1 === query || k2 === query) return d;
      }

      // Contains
      for(const d of DRUGS){
        const hay = normalize((d.name||"") + " " + (d.brand||"") + " " + (d.name_ar||"") + " " + (d.strength||""));
        if(hay.includes(query)) return d;
      }
      return null;
    }

    function buildReply(d){
      const title = (LANG==="ar" && d.name_ar) ? d.name_ar : (d.name || "");
      const strength = d.strength ? ` â€” ${d.strength}` : "";
      const brand = d.brand ? ` (${d.brand})` : "";
      const cls = (LANG==="ar" ? d.class_ar : d.class_en) || d.class || "";
      const notes = (LANG==="ar" ? d.notes_ar : d.notes_en) || "";
      const ramadan = (LANG==="ar" ? d.ramadan_ar : d.ramadan_en) || "";

      // Risk tag
      const risk = normalize(d.risk || "");
      const riskTag = risk === "high"
        ? `<span class="tag warn">âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø­Ø°Ø±/Ø®Ø·Ø© ÙØ±Ø¯ÙŠØ©</span>`
        : `<span class="tag ok">âœ… Ø¥Ø±Ø´Ø§Ø¯ Ø¹Ø§Ù…</span>`;

      const html = `
        <div class="botTitle">ğŸ’Š ${escapeHtml(title)}${escapeHtml(brand)}${escapeHtml(strength)}</div>
        <div class="metaLine">
          <span class="tag">ğŸ·ï¸ ${escapeHtml(T[LANG].classLabel)}: ${escapeHtml(cls || "â€”")}</span>
          ${riskTag}
        </div>
        ${notes ? `<div class="sectionText">ğŸ“ <b>${escapeHtml(T[LANG].notesLabel)}:</b> ${escapeHtml(notes)}</div>` : ""}
        ${ramadan ? `<div class="sectionText">ğŸŒ™ <b>${escapeHtml(T[LANG].ramadanLabel)}:</b> ${escapeHtml(ramadan)}</div>` : ""}
        <div class="finePrint">âš ï¸ ${escapeHtml(T[LANG].disclaimer)}</div>
      `;

      const copyText =
        `ğŸ’Š ${title}${brand}${strength}\n` +
        `${T[LANG].classLabel}: ${cls || "â€”"}\n` +
        (notes ? `\n${T[LANG].notesLabel}: ${notes}\n` : "") +
        (ramadan ? `\n${T[LANG].ramadanLabel}: ${ramadan}\n` : "") +
        `\nâš ï¸ ${T[LANG].disclaimer}`;

      return {html, copyText};
    }

    function handleQuery(q){
      const text = (q||"").trim();
      if(!text) return;

      // Quick chips commands
      if(text === "__RAMADAN_TIPS__"){
        const tips = (LANG==="ar")
          ? "ğŸ•’ Ù†ØµØ§Ø¦Ø­ Ø¹Ø§Ù…Ø© Ù„Ø±Ù…Ø¶Ø§Ù†:\nâ€¢ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ù†ÙØ³Ùƒ.\nâ€¢ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ØªÙÙ‚Ø³Ù… Ø¨ÙŠÙ† Ø§Ù„Ø¥ÙØ·Ø§Ø± ÙˆØ§Ù„Ø³Ø­ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·Ø©.\nâ€¢ Ø±Ø§Ù‚Ø¨ Ø³ÙƒØ± Ø§Ù„Ø¯Ù… Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø±ÙŠØ¶ Ø³ÙƒØ±ÙŠ.\nâ€¢ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù„Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ø§Ù„Ø³ÙƒØ±ÙŠ/Ø§Ù„Ø³ÙŠÙˆÙ„Ø©/Ø§Ù„Ø¶ØºØ·)."
          : "ğŸ•’ General Ramadan tips:\nâ€¢ Donâ€™t change doses on your own.\nâ€¢ Some meds are split between Iftar/Suhoor per plan.\nâ€¢ Monitor glucose if diabetic.\nâ€¢ Ask clinician for sensitive meds (diabetes/anticoagulants/BP).";
        addUserMessage(LANG==="ar" ? "Ù†ØµØ§Ø¦Ø­ Ø±Ù…Ø¶Ø§Ù†" : "Ramadan tips");
        addBotBubble(`<div class="botTitle">ğŸ•’</div><div class="sectionText">${escapeHtml(tips).replace(/\n/g,"<br>")}</div>`, tips);
        return;
      }

      if(text.startsWith("__CAT__:")){
        const cat = text.split(":")[1] || "";
        const list = DRUGS.filter(d => normalize(d.category) === normalize(cat))
                          .slice(0, 20)
                          .map(d => {
                            const nm = (LANG==="ar" && d.name_ar) ? d.name_ar : d.name;
                            return `â€¢ ${nm}${d.strength ? " " + d.strength : ""}`;
                          }).join("\n");

        const title = (LANG==="ar") ? `Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ØªØµÙ†ÙŠÙ: ${cat}` : `Category: ${cat}`;
        addUserMessage(title);
        addBotBubble(`<div class="botTitle">ğŸ“Œ ${escapeHtml(title)}</div><div class="sectionText">${escapeHtml(list || (LANG==="ar"?"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©":"No items found")).replace(/\n/g,"<br>")}</div>`, `${title}\n${list}`);
        return;
      }

      if(text === "__TOP__"){
        const top = getTopDrugs(10);
        const msg = top.length ? top.map(([n,c],i)=> `${i+1}. ${n} â€” ${c}`).join("\n")
                               : T[LANG].topEmpty;
        addUserMessage(LANG==="ar" ? "Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©" : "Common meds");
        addBotBubble(`<div class="botTitle">â­</div><div class="sectionText">${escapeHtml(msg).replace(/\n/g,"<br>")}</div>`, msg);
        return;
      }

      // Normal search
      addUserMessage(text);

      const d = findDrug(text);
      if(d){
        const {html, copyText} = buildReply(d);
        addBotBubble(html, copyText);

        const key = ((d.name||"") + (d.strength ? " " + d.strength : "")).trim();
        trackDrugUse(key);
        return;
      }

      addBotBubble(`<div class="botTitle">â„¹ï¸</div><div class="sectionText">${escapeHtml(T[LANG].missing)}</div>`, T[LANG].missing);
    }

    // ================= Chips =================
    function renderChips(){
      const box = document.getElementById("chips");
      box.innerHTML = "";
      for(const item of T[LANG].chips){
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = item.label;
        b.onclick = () => handleQuery(item.q);
        box.appendChild(b);
      }
      // notes language
      document.getElementById("notesBox").innerHTML =
        (LANG==="ar")
        ? "â€¢ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ù„ØªÙˆØ¹ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·.<br>â€¢ Ø§ØªØ¨Ø¹ Ø®Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§.<br>â€¢ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦: ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰/911."
        : "â€¢ This tool provides general guidance only.<br>â€¢ Always follow the clinician plan.<br>â€¢ For emergencies, contact your hospital/911.";
    }

    function updateKpis(){
      document.getElementById("kpiUsed").textContent = String(getTotalTracked());
    }

    // ================= Top 10 modal =================
    function renderTop(){
      const list = document.getElementById("topList");
      const top = getTopDrugs(10);
      if(!top.length){
        list.innerHTML = `<div style="color:var(--muted); font-size:15px;">${escapeHtml(T[LANG].topEmpty)}</div>`;
        return;
      }
      list.innerHTML = top.map(([name,count],i)=>`
        <div class="row">
          <div>${i+1}. ${escapeHtml(name)}</div>
          <div style="color:var(--muted)">${count}</div>
        </div>
      `).join("");
    }

    // ================= Install prompt =================
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "inline-flex";
    });

    // ================= Boot =================
    document.addEventListener("DOMContentLoaded", ()=>{
      applyLang();
      loadDrugsJson();
      updateKpis();

      // Welcome only once
      const chat = document.getElementById("chat");
      if(chat.children.length === 0) addWelcome();

      document.getElementById("langBtn").onclick = ()=>{
        LANG = (LANG === "ar") ? "en" : "ar";
        document.getElementById("chat").innerHTML = "";
        applyLang();
        loadDrugsJson();
        updateKpis();
        addWelcome();
      };

      document.getElementById("sendBtn").onclick = ()=>{
        const input = document.getElementById("userInput");
        const v = input.value.trim();
        if(!v) return;
        input.value = "";
        updateHints("");
        handleQuery(v);
      };

      document.getElementById("userInput").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          document.getElementById("sendBtn").click();
        }
      });
      document.getElementById("userInput").addEventListener("input", (e)=> updateHints(e.target.value));

      const topModal = document.getElementById("topModal");
      document.getElementById("topBtn").onclick = ()=>{ renderTop(); topModal.style.display="block"; };
      document.getElementById("topClose").onclick = ()=>{ topModal.style.display="none"; };
      topModal.onclick = (e)=>{ if(e.target.id==="topModal") topModal.style.display="none"; };

      document.getElementById("installBtn").onclick = async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById("installBtn").style.display = "none";
      };

      // Use your existing SW filename
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    });
  </script>
</body>
</html>
