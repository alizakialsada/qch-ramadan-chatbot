<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QCH â€“ Smart Ramadan Medication Assistant</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#35d0c7" />

<style>
:root{
  --primary:#2aa6ff;
  --accent:#35d0c7;
  --bg:#f4f9fc;
  --card:#ffffff;
  --border:#dbe7ef;
  --text:#0b2230;
  --muted:#6b8796;
  --radius:20px;
  --shadow:0 15px 40px rgba(0,0,0,.08);
  --danger:#ff4d4f;
  --ok:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:16px 20px;
  background:var(--card);
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
  position:sticky;
  top:0;
  z-index:10;
}

.logo{ height:58px; object-fit:contain; }

.title{
  text-align:center;
  flex:1;
  min-width:200px;
}
.title h1{ margin:0; font-size:18px; }
.title p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

.container{
  display:grid;
  grid-template-columns:340px 1fr;
  gap:18px;
  padding:18px;
}
@media (max-width: 980px){
  .container{ grid-template-columns:1fr; }
  header{ position:relative; }
  .logo{ height:50px; }
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}

.sidebar h3{ margin:0 0 10px; }
.hr{ height:1px; background:var(--border); border:0; margin:12px 0; }

.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  margin:6px 6px 0 0;
  font-size:13px;
  user-select:none;
  transition:transform .05s ease;
}
.btn:active{ transform:scale(.98); }
.btn.primary{ background:var(--accent); color:#fff; border:none; }
.btn.danger{ background:var(--danger); color:#fff; border:none; }
.btn.ghost{ background:#f7fbff; }
.btn.full{ width:100%; margin:10px 0 0; }

.kpi{
  background:#f6fbff;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.kpi strong{ font-size:16px; }

.badges{ display:flex; gap:8px; flex-wrap:wrap; }
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-size:12px;
  color:var(--muted);
}

.chat{
  min-height:340px;
  max-height:58vh;
  overflow:auto;
  padding-right:4px;
}
.bubble{
  background:#f0f7fb;
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:12px;
  border:1px solid var(--border);
  line-height:1.65;
}
.bubble .meta{
  color:var(--muted);
  font-size:12px;
  margin-top:8px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.tag{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-size:12px;
  color:var(--muted);
}

.row{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:10px;
  align-items:center;
  margin-top:12px;
}

.inputWrap{ position:relative; }
input{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  outline:none;
}
input:focus{ border-color:rgba(42,166,255,.6); box-shadow:0 0 0 4px rgba(42,166,255,.12); }

.suggest{
  position:absolute;
  top:46px;
  right:0;
  left:0;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:none;
  z-index:50;
}
.suggest button{
  width:100%;
  text-align:right;
  padding:10px 12px;
  border:0;
  background:#fff;
  cursor:pointer;
  font-size:13px;
}
.suggest button:hover{ background:#f6fbff; }
.suggest .line2{ color:var(--muted); font-size:12px; margin-top:2px; }

.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
.chip{
  border:1px dashed var(--border);
  background:#fff;
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  font-size:12px;
  color:var(--muted);
}

.footer{
  text-align:center;
  padding:16px;
  font-size:12px;
  color:var(--muted);
}

/* ===== MODAL ===== */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(11,34,48,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:999;
}
.modal{
  width:min(780px, 96vw);
  background:#fff;
  border-radius:22px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.modalHead{
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid var(--border);
}
.modalHead strong{ font-size:15px; }
.modalBody{
  padding:14px 16px;
  max-height:70vh;
  overflow:auto;
}
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border:1px solid var(--border);
  border-radius:14px;
}
.table th, .table td{
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  font-size:13px;
}
.table th{
  background:#f6fbff;
  text-align:right;
  color:var(--muted);
}
.table tr:last-child td{ border-bottom:none; }

/* ===== PRINT / PDF ===== */
@media print{
  body{ background:#fff; }
  header, .sidebar, .row, .footer, .chips, #openTopBtn { display:none !important; }
  .container{ padding:0; }
  .card{ border:none; box-shadow:none; }
  .chat{ max-height:none; overflow:visible; }
  .bubble{ page-break-inside:avoid; }
}
</style>
</head>

<body>

<header>
  <img src="logo_qch.png" class="logo" alt="QCH Logo">
  <div class="title">
    <h1>QCH â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©</h1>
    <p>Arabic â€¢ English â€¢ Patient Friendly â€¢ Offline Tracking â€¢ PDF</p>
  </div>
  <img src="logo_health_holding.png" class="logo" alt="Health Holding Logo">
</header>

<div class="container">

  <!-- SIDEBAR -->
  <div class="card sidebar">
    <h3>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>

    <div>
      <button class="btn" onclick="filterCategory('Hypertension')">Ø¶ØºØ· â¤ï¸</button>
      <button class="btn" onclick="filterCategory('Diabetes')">Ø³ÙƒØ± ğŸ©¸</button>
      <button class="btn" onclick="filterCategory('Thyroid')">Ø§Ù„ØºØ¯Ø© ğŸ¦‹</button>
      <button class="btn" onclick="filterCategory('GI')">Ø§Ù„Ù…Ø¹Ø¯Ø© ğŸ½</button>
      <button class="btn" onclick="filterCategory('Anticoagulant')">Ù…ÙÙ…ÙŠØ¹Ø§Øª ğŸ§¬</button>
      <button class="btn" onclick="filterCategory('Antibiotic')">Ù…Ø¶Ø§Ø¯Ø§Øª ğŸ¦ </button>
      <button class="btn" onclick="filterCategory('Pain')">Ø£Ù„Ù… ğŸ’Š</button>
      <button class="btn" onclick="filterCategory('Asthma')">ØµØ¯Ø± ğŸŒ¬ï¸</button>
      <button class="btn" onclick="filterCategory('Allergy')">Ø­Ø³Ø§Ø³ÙŠØ© ğŸŒ¿</button>
      <button class="btn" onclick="filterCategory('Lipids')">Ø¯Ù‡ÙˆÙ† ğŸ«€</button>
    </div>

    <div class="hr"></div>

    <div class="kpi"><span>Drugs loaded</span><strong id="drugsLoaded">0</strong></div>
    <div class="kpi"><span>Total selections</span><strong id="tracked">0</strong></div>
    <div class="kpi"><span>Top 10</span><strong id="topCount">0</strong></div>

    <div class="hr"></div>

    <button id="openTopBtn" class="btn ghost full" onclick="openTop10()">â­ Top 10 Dashboard</button>
    <button class="btn ghost full" onclick="exportDrugPDF()">ğŸ“„ Export PDF (Selected)</button>
    <button class="btn danger full" onclick="resetTracking()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹ â™»ï¸</button>
    <button class="btn danger full" onclick="clearChat()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ—‘</button>

    <div class="hr"></div>

    <div class="badges">
      <div class="badge">âš ï¸ Ù„Ø§ ÙŠØºÙ†ÙŠ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</div>
      <div class="badge">ğŸ”’ Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰</div>
      <div class="badge">ğŸ“¶ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="card">
    <div class="chat" id="chat"></div>

    <div class="row">
      <div class="inputWrap">
        <input id="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ / Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ / Ø£Ùˆ Ø§Ù„Ø´Ø±ÙƒØ©..." autocomplete="off">
        <div id="suggest" class="suggest"></div>
      </div>
      <button class="btn primary" onclick="searchDrug()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div class="chips" id="chips"></div>
  </div>

</div>

<div class="footer">Created by Automation Supervisor Ali Alsada</div>

<!-- TOP10 MODAL -->
<div class="modalBack" id="modalBack" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHead">
      <strong>â­ Top 10 Dashboard</strong>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" onclick="exportTop10PDF()">ğŸ“„ Export PDF</button>
        <button class="btn danger" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
      </div>
    </div>
    <div class="modalBody">
      <div id="top10Content"></div>
    </div>
  </div>
</div>

<script>
/* ========= SETTINGS ========= */
let LANG = localStorage.getItem("qch_lang") || "ar"; // ar | en
const TRACK_KEY = "qch_track_counts_v2";  // { "Amlodipine": 3, ... }
const TOTAL_KEY = "qch_total_selections_v2";

/* ========= STATE ========= */
let DRUGS = [];
let lastSelectedDrug = null;

/* ========= HELPERS ========= */
const $ = (id) => document.getElementById(id);
function safeText(s){ return (s ?? "").toString(); }
function norm(s){
  return safeText(s).toLowerCase().trim().replace(/\s+/g,' ');
}
function getTrackMap(){
  try{ return JSON.parse(localStorage.getItem(TRACK_KEY) || "{}"); }
  catch{ return {}; }
}
function setTrackMap(map){ localStorage.setItem(TRACK_KEY, JSON.stringify(map)); }
function getTotal(){ return Number(localStorage.getItem(TOTAL_KEY) || "0"); }
function setTotal(n){ localStorage.setItem(TOTAL_KEY, String(n)); }

/* ========= LOAD DRUGS ========= */
async function loadDrugs(){
  try{
    const res = await fetch("drugs.json", { cache: "no-store" });
    const data = await res.json();
    DRUGS = Array.isArray(data) ? data : [];

    $("drugsLoaded").innerText = DRUGS.length;
    $("tracked").innerText = getTotal();
    updateTopCount();
    renderChips();

    greet();
  }catch(e){
    addMessage("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ© (drugs.json). ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ JSON ØµØ­ÙŠØ­.");
    console.log(e);
  }
}
loadDrugs();

/* ========= UI ========= */
function addMessage(html){
  const div = document.createElement("div");
  div.className = "bubble";
  div.innerHTML = html;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function clearChat(){ $("chat").innerHTML=""; greet(); }

function greet(){
  const msg = (LANG==="ar")
    ? "Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Ø§Ù„Ø´Ø±ÙƒØ©/Ø§Ù„ØªØ±ÙƒÙŠØ²) ÙˆØ³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙÙˆØ±ÙŠØ©."
    : "Hello ğŸ‘‹ Type medication name (Arabic/English/brand/strength) and instant suggestions will appear.";
  addMessage(`<strong>${msg}</strong><div class="meta"><span>QCH Ramadan Assistant</span></div>`);
}

/* ========= SEARCH + AUTOCOMPLETE (PRO) ========= */
$("input").addEventListener("input", onType);
$("input").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){ e.preventDefault(); searchDrug(); }
  if(e.key==="Escape"){ hideSuggest(); }
});

function hideSuggest(){
  $("suggest").style.display="none";
  $("suggest").innerHTML="";
}

function drugSearchBlob(d){
  // search across multiple fields
  return norm([
    d.name, d.name_ar, d.brand, d.strength, d.form, d.category
  ].map(safeText).join(" "));
}

function scoreDrug(d, q){
  const blob = drugSearchBlob(d);
  if(!blob.includes(q)) return 0;

  const en = norm(d.name);
  const ar = norm(d.name_ar);
  const brand = norm(d.brand);
  const strength = norm(d.strength);

  let s = 1;
  if(en.startsWith(q) || ar.startsWith(q)) s += 6;
  if(brand.startsWith(q)) s += 4;
  if(strength.startsWith(q)) s += 2;
  // contains bonuses
  if(en.includes(q) || ar.includes(q)) s += 2;
  if(brand.includes(q)) s += 1;
  return s;
}

function onType(){
  const q = norm($("input").value);
  if(!q || q.length < 2){ hideSuggest(); return; }

  const matches = DRUGS
    .map(d => ({ d, s: scoreDrug(d, q) }))
    .filter(x => x.s > 0)
    .sort((a,b)=>b.s-a.s)
    .slice(0, 10);

  if(matches.length === 0){ hideSuggest(); return; }

  $("suggest").innerHTML = matches.map(x=>{
    const d = x.d;
    const en = safeText(d.name);
    const ar = safeText(d.name_ar);
    const br = safeText(d.brand);
    const st = safeText(d.strength);
    const cat = safeText(d.category);

    const title = (LANG==="ar" && ar) ? ar : en;
    const sub = [
      (LANG==="ar" ? en : ar),
      br ? `Brand: ${br}` : "",
      st ? `Strength: ${st}` : "",
      cat ? `â€¢ ${cat}` : ""
    ].filter(Boolean).join(" â€” ");

    return `
      <button type="button" onclick="pickDrug('${escapeQuotes(en)}')">
        <div><strong>${escapeHtml(title)}</strong></div>
        <div class="line2">${escapeHtml(sub)}</div>
      </button>
    `;
  }).join("");
  $("suggest").style.display="block";
}

function escapeQuotes(s){ return safeText(s).replace(/'/g,"\\'"); }
function escapeHtml(s){
  return safeText(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function pickDrug(englishName){
  $("input").value = englishName;
  hideSuggest();
  searchDrug();
}

function findBestDrug(qRaw){
  const q = norm(qRaw);
  if(!q) return null;

  const ranked = DRUGS
    .map(d=>({ d, s: scoreDrug(d, q) }))
    .sort((a,b)=>b.s-a.s);

  if(ranked.length && ranked[0].s > 0) return ranked[0].d;
  return null;
}

function searchDrug(){
  const qRaw = $("input").value;
  const q = norm(qRaw);
  if(!q) return;

  const drug = findBestDrug(qRaw);
  if(drug){
    lastSelectedDrug = drug;
    trackSelection(drug);
    renderDrug(drug);
    $("input").value = "";
    hideSuggest();
  }else{
    addMessage(LANG==="ar"
      ? "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚. Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø­Ø±ÙÙŠÙ† Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª."
      : "âŒ No match. Type 2+ letters or choose a suggestion."
    );
  }
}

/* ========= RENDER DRUG (EXEC) ========= */
function riskLabel(r){
  const v = norm(r);
  if(v==="high") return "High Risk";
  if(v==="moderate") return "Moderate Risk";
  if(v==="low") return "Low Risk";
  return "-";
}

function renderDrug(d){
  const en = safeText(d.name);
  const ar = safeText(d.name_ar);
  const br = safeText(d.brand);
  const st = safeText(d.strength);
  const form = safeText(d.form);
  const cat = safeText(d.category);
  const risk = safeText(d.risk);

  const guideAR = safeText(d.ramadan_ar || d.ramadan || "");
  const guideEN = safeText(d.ramadan_en || "");
  const notesAR = safeText(d.notes_ar || "");
  const notesEN = safeText(d.notes_en || "");

  const map = getTrackMap();
  const count = map[en] || 0;

  const title = (LANG==="ar" ? (ar || en) : en);
  const alt   = (LANG==="ar" ? (en ? `(${en})` : "") : (ar ? `(${ar})` : ""));

  const guide = (LANG==="ar") ? (guideAR || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø¹Ø¯.") : (guideEN || guideAR || "No guidance yet.");
  const notes = (LANG==="ar") ? notesAR : (notesEN || notesAR);

  const metaTags = `
    <div class="meta">
      ${cat ? `<span class="tag">ğŸ· ${escapeHtml(cat)}</span>` : ""}
      ${br ? `<span class="tag">ğŸ­ ${escapeHtml(br)}</span>` : ""}
      ${st ? `<span class="tag">âš–ï¸ ${escapeHtml(st)}</span>` : ""}
      ${form ? `<span class="tag">ğŸ§¾ ${escapeHtml(form)}</span>` : ""}
      ${risk ? `<span class="tag">âš ï¸ ${escapeHtml(riskLabel(risk))}</span>` : ""}
      <span class="tag">â­ Selected: <strong>${count}</strong>x</span>
    </div>
  `;

  const notesBlock = notes ? `<div style="margin-top:10px"><strong>${LANG==="ar"?"Ù…Ù„Ø§Ø­Ø¸Ø§Øª":"Notes"}</strong><div>${escapeHtml(notes).replaceAll("\n","<br>")}</div></div>` : "";

  addMessage(`
    <strong>${escapeHtml(title)}</strong>
    ${alt ? `<small style="color:var(--muted)"> ${escapeHtml(alt)}</small>` : ""}
    <div style="margin-top:10px">${escapeHtml(guide).replaceAll("\n","<br>")}</div>
    ${notesBlock}
    ${metaTags}
    <div class="meta">
      <span style="color:var(--ok)">âœ… Ready for PDF</span>
      <span>Qatif Central Hospital</span>
    </div>
  `);
}

/* ========= CATEGORY FILTER ========= */
function filterCategory(cat){
  const results = DRUGS.filter(d => safeText(d.category) === cat);
  if(results.length === 0){
    addMessage(LANG==="ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ." : "No items in this category.");
    return;
  }

  addMessage(`<strong>${LANG==="ar" ? "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµÙ†ÙŠÙ:" : "Category results:"} ${escapeHtml(cat)}</strong>`);
  results.slice(0, 20).forEach(d => renderDrug(d));
  if(results.length > 20){
    addMessage(LANG==="ar" ? `â€¦ ØªÙ… Ø¹Ø±Ø¶ 20 ÙÙ‚Ø· Ù…Ù† Ø£ØµÙ„ ${results.length}` : `â€¦ showing 20 of ${results.length}`);
  }
}

/* ========= TRACKING ========= */
function trackSelection(d){
  const en = safeText(d.name);
  const map = getTrackMap();
  map[en] = (map[en] || 0) + 1;
  setTrackMap(map);

  const total = getTotal() + 1;
  setTotal(total);
  $("tracked").innerText = total;

  updateTopCount();
}

function updateTopCount(){
  const map = getTrackMap();
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  $("topCount").innerText = top.length;
}

/* ========= TOP10 DASHBOARD ========= */
function openTop10(){
  const map = getTrackMap();
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

  if(entries.length === 0){
    addMessage(LANG==="ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ¨Ø¹ Ø¨Ø¹Ø¯." : "No tracking data yet.");
    return;
  }

  const rows = entries.map(([name, count], i)=>{
    const d = DRUGS.find(x=>safeText(x.name)===name);
    const ar = d ? safeText(d.name_ar) : "";
    const br = d ? safeText(d.brand) : "";
    const st = d ? safeText(d.strength) : "";
    const cat = d ? safeText(d.category) : "";

    const label = (LANG==="ar" && ar) ? `${ar} (${name})` : `${name}${ar?` (${ar})`:""}`;
    const sub = [cat, br, st].filter(Boolean).join(" â€” ");

    return `
      <tr>
        <td>${i+1}</td>
        <td><strong>${escapeHtml(label)}</strong><div style="color:var(--muted);font-size:12px;margin-top:3px">${escapeHtml(sub)}</div></td>
        <td><strong>${count}</strong></td>
      </tr>
    `;
  }).join("");

  $("top10Content").innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th style="width:70px">#</th>
          <th>${LANG==="ar" ? "Ø§Ù„Ø¯ÙˆØ§Ø¡" : "Medication"}</th>
          <th style="width:140px">${LANG==="ar" ? "Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" : "Count"}</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <div style="margin-top:12px;color:var(--muted);font-size:12px">
      ${LANG==="ar" ? "Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ù…Ø§Ø¡ Ù…Ø±Ø¶Ù‰)." : "Note: Data stored locally on this device (no patient identifiers)."}
    </div>
  `;

  $("modalBack").style.display="flex";
}

function closeModal(){
  $("modalBack").style.display="none";
}

/* ========= RESET ========= */
function resetTracking(){
  localStorage.removeItem(TRACK_KEY);
  localStorage.removeItem(TOTAL_KEY);
  $("tracked").innerText = "0";
  updateTopCount();
  addMessage(LANG==="ar" ? "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹." : "âœ… Tracking reset.");
}

/* ========= CHIPS (COMMON / FAST) ========= */
function renderChips(){
  const container = $("chips");
  if(!container) return;

  // Prefer top tracked, else show curated
  const map = getTrackMap();
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);
  const fallback = ["Amlodipine","Losartan","Metformin","Omeprazole","Levothyroxine","Warfarin","Atorvastatin","Cetirizine"];

  const list = (top.length ? top : fallback)
    .map(n=>{
      const d = DRUGS.find(x=>norm(x.name)===norm(n));
      const label = d ? (LANG==="ar" ? (d.name_ar || d.name) : d.name) : n;
      return `<div class="chip" onclick="pickDrug('${escapeQuotes(d?d.name:n)}')">â­ ${escapeHtml(label)}</div>`;
    }).join("");

  container.innerHTML = list;
}

/* ========= EXPORT PDF (Selected Drug) ========= */
function exportDrugPDF(){
  if(!lastSelectedDrug){
    addMessage(LANG==="ar" ? "Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Export PDF." : "Select a medication first, then export PDF.");
    return;
  }
  // Add a print-friendly bubble header then print
  const d = lastSelectedDrug;
  const title = LANG==="ar" ? "QCH â€“ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø±Ù…Ø¶Ø§Ù† Ù„Ù„Ø¯ÙˆØ§Ø¡" : "QCH â€“ Ramadan Medication Guidance";

  addMessage(`
    <strong>${escapeHtml(title)}</strong>
    <div style="margin-top:10px;color:var(--muted);font-size:12px">
      ${LANG==="ar" ? "ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù PDF Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©." : "Save as PDF from the print dialog."}
    </div>
  `);

  setTimeout(()=>window.print(), 350);
}

/* ========= EXPORT PDF (Top10) ========= */
function exportTop10PDF(){
  // Print current modal content
  const back = $("modalBack");
  if(back.style.display !== "flex"){
    openTop10();
  }
  setTimeout(()=>window.print(), 300);
}

/* ========= PWA REGISTER ========= */
if ("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./service-worker.js")
      .then(()=>console.log("âœ… Service Worker registered"))
      .catch(err=>console.log("SW error", err));
  });
}
</script>

</body>
</html>
