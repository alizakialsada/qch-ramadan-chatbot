<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>QCH â€“ Smart Ramadan Medication Assistant</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0ea5a6" />

<style>
:root{
  --accent:#0ea5a6;
  --accent2:#2aa6ff;
  --bg:#f3fbff;
  --card:#ffffff;
  --border:#d7e9f2;
  --text:#07202a;
  --muted:#5f7f8f;
  --radius:22px;
  --shadow:0 18px 45px rgba(0,0,0,.08);
  --danger:#ff4d4f;
  --ok:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:var(--text);
  background:
    radial-gradient(900px 450px at 20% -10%, rgba(14,165,166,.18), transparent 60%),
    radial-gradient(900px 450px at 80% -10%, rgba(42,166,255,.14), transparent 60%),
    var(--bg);
}

/* ===== HEADER (clean: logos + one sentence only) ===== */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:14px 18px;
  background:linear-gradient(180deg, #ffffff 0%, #fbfeff 100%);
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
  position:sticky;
  top:0;
  z-index:20;
}

.headerTitle{
  flex:1;
  text-align:center;
  font-weight:900;
  letter-spacing:.2px;
  font-size:16px;
  line-height:1.35;
  background:linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  padding:0 8px;
}

.logo{
  height:110px;
  width:auto;
  object-fit:contain;
  background: linear-gradient(180deg, #ffffff 0%, #fbfeff 100%);
  padding:8px 14px;
  border-radius:18px;
  filter:none;
}

/* Keep Health Holding on the RIGHT always */
.logo-left{ order:1; }
.headerTitle{ order:2; }
.logo-right{ order:3; margin-right:auto; }

.container{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:16px;
  padding:16px;
}

/* ===== CARDS ===== */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}

.sidebar h3{
  margin:0 0 10px;
  font-size:14px;
  color:var(--muted);
  letter-spacing:.2px;
}
.hr{ height:1px; background:var(--border); border:0; margin:12px 0; }

/* ===== CATEGORY TILES (icons) ===== */
.catGrid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:10px;
}
.catBtn{
  border:1px solid var(--border);
  background:linear-gradient(180deg, #ffffff 0%, #f7fcff 100%);
  border-radius:18px;
  padding:12px 12px;
  cursor:pointer;
  text-align:right;
  transition:transform .05s ease, box-shadow .2s ease, border-color .2s ease;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.catBtn:hover{ box-shadow:0 14px 30px rgba(0,0,0,.06); border-color:rgba(14,165,166,.35); }
.catBtn:active{ transform:scale(.99); }
.catBtn .label{ font-weight:800; font-size:13px; }
.catBtn .icon{
  width:34px; height:34px;
  border-radius:12px;
  display:grid; place-items:center;
  background:linear-gradient(135deg, rgba(14,165,166,.15) 0%, rgba(42,166,255,.13) 100%);
  border:1px solid rgba(14,165,166,.18);
  font-size:18px;
}

/* ===== KPI ===== */
.kpiRow{ display:grid; grid-template-columns:1fr; gap:10px; }
.kpi{
  background:linear-gradient(180deg, #f4fbff 0%, #ffffff 100%);
  padding:12px;
  border-radius:16px;
  border:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.kpi span{ color:var(--muted); font-size:12px; }
.kpi strong{ font-size:16px; }

.badges{ display:flex; gap:8px; flex-wrap:wrap; }
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-size:12px;
  color:var(--muted);
}

/* ===== BUTTONS ===== */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  margin:6px 6px 0 0;
  font-size:13px;
  user-select:none;
  transition:transform .05s ease, box-shadow .15s ease;
}
.btn:hover{ box-shadow:0 10px 25px rgba(0,0,0,.06); }
.btn:active{ transform:scale(.98); }
.btn.primary{
  background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
  color:#fff;
  border:none;
}
.btn.danger{ background:var(--danger); color:#fff; border:none; }
.btn.ghost{ background:#f7fbff; }
.btn.full{ width:100%; margin:10px 0 0; }

/* ===== CHAT ===== */
.chat{
  min-height:420px;
  max-height:62vh;
  overflow:auto;
  padding-right:4px;
  scroll-behavior:smooth;
}
.bubble{
  background:linear-gradient(180deg, #f2fbff 0%, #ffffff 100%);
  padding:12px 14px;
  border-radius:18px;
  margin-bottom:12px;
  border:1px solid var(--border);
  line-height:1.8;
}
.bubble .meta{
  color:var(--muted);
  font-size:12px;
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.tag{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  font-size:12px;
  color:var(--muted);
}

/* ===== INPUT ===== */
.row{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:10px;
  align-items:center;
  margin-top:12px;
  position:sticky;
  bottom:0;
  background:linear-gradient(180deg, rgba(243,251,255,.0) 0%, rgba(243,251,255,.85) 40%, rgba(243,251,255,1) 100%);
  padding-top:10px;
}
.inputWrap{ position:relative; }
input{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  outline:none;
  background:#fff;
}
input:focus{
  border-color:rgba(14,165,166,.55);
  box-shadow:0 0 0 5px rgba(14,165,166,.14);
}
.suggest{
  position:absolute;
  top:52px;
  right:0;
  left:0;
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  display:none;
  z-index:50;
}
.suggest button{
  width:100%;
  text-align:right;
  padding:10px 12px;
  border:0;
  background:#fff;
  cursor:pointer;
  font-size:13px;
}
.suggest button:hover{ background:#f4fbff; }
.suggest .line2{ color:var(--muted); font-size:12px; margin-top:2px; }

/* ===== CHIPS ===== */
.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
.chip{
  border:1px dashed rgba(14,165,166,.35);
  background:#fff;
  border-radius:999px;
  padding:8px 10px;
  cursor:pointer;
  font-size:12px;
  color:var(--muted);
}
.chip:hover{ border-color:rgba(42,166,255,.45); }

.footer{
  text-align:center;
  padding:16px;
  font-size:12px;
  color:var(--muted);
}

/* ===== MODAL ===== */
.modalBack{
  position:fixed;
  inset:0;
  background:rgba(8,32,42,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:999;
}
.modal{
  width:min(820px, 96vw);
  background:#fff;
  border-radius:24px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.modalHead{
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(135deg, rgba(14,165,166,.10) 0%, rgba(42,166,255,.10) 100%);
}
.modalHead strong{ font-size:15px; }
.modalBody{
  padding:14px 16px;
  max-height:70vh;
  overflow:auto;
}
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border:1px solid var(--border);
  border-radius:16px;
}
.table th, .table td{
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  font-size:13px;
  vertical-align:top;
}
.table th{
  background:#f4fbff;
  text-align:right;
  color:var(--muted);
}
.table tr:last-child td{ border-bottom:none; }

/* ===== PRINT AREA ===== */
#printArea{ display:none; }
.printHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:10px 0 12px;
  border-bottom:2px solid #d7e9f2;
  margin-bottom:10px;
}
.printLogo{
  height:100px;
  width:auto;
  object-fit:contain;
  background:#fff;
  padding:6px 10px;
  border-radius:16px;
  filter:none;
}
.printTitle{ text-align:center; flex:1; }
.printTitle h2{ margin:0; font-size:16px; color:#07202a; }
.printTitle p{ margin:4px 0 0; font-size:11px; color:#5f7f8f; }
.printMeta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:11px;
  color:#5f7f8f;
  margin:10px 0 12px;
  padding-bottom:10px;
  border-bottom:1px solid #d7e9f2;
}
.printMeta strong{ color:#07202a; }
.printFooter{
  margin-top:14px;
  padding-top:10px;
  border-top:1px solid #d7e9f2;
  font-size:10.5px;
  color:#5f7f8f;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.printFooter .warn{ color:#07202a; }

@media print{
  @page { size: A4; margin: 14mm 12mm 14mm 12mm; }
  header, .sidebar, .row, .footer, .chips, #openTopBtn, .modalBack { display:none !important; }
  body{ background:#fff !important; }
  .container{ padding:0; }
  .card{ border:none; box-shadow:none; padding:0; }
  .chat{ max-height:none; overflow:visible; }
  #printArea{ display:block !important; }
  img{ max-width:100% !important; }
  #printArea img{ display:inline-block !important; visibility:visible !important; }
  .bubble{
    page-break-inside: avoid;
    border:1px solid #d7e9f2;
    background:#fff;
  }
}

/* ===== MOBILE ===== */
@media (max-width: 980px){
  .container{ grid-template-columns:1fr; }
  header{ position:relative; }
  .logo{ height:92px; }
}
@media (max-width: 600px){
  header{
    flex-direction:column;
    gap:10px;
    padding:12px;
  }
  .logo-right{ order:1; margin-right:0; }
  .headerTitle{ order:2; font-size:15px; }
  .logo-left{ order:3; }

  .logo{ height:86px; padding:6px 10px; border-radius:16px; }

  .container{ padding:12px; gap:12px; }

  .catGrid{ grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px; }
  .catBtn{ padding:10px 10px; border-radius:16px; }
  .catBtn .icon{ width:32px; height:32px; border-radius:12px; }

  .chat{ max-height:58vh; min-height:360px; }

  .row{ grid-template-columns:1fr; }
  .row .btn.primary{ width:100%; }
}
</style>
</head>

<body>

<header>
  <img src="logo_qch.png" class="logo logo-left" alt="QCH Logo">
  <div class="headerTitle">Ø§Ù„Ø´Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„Ø§Ù†ÙŠØ© Ø¨Ø´Ø¨ÙƒØ© Ø§Ù„Ù‚Ø·ÙŠÙ Ø§Ù„ØµØ­ÙŠØ©</div>
  <img src="logo_health_holding.png" class="logo logo-right" alt="Health Holding Logo">
</header>

<div class="container">

  <!-- SIDEBAR -->
  <div class="card sidebar">
    <h3>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>

    <div class="catGrid">
      <button class="catBtn" onclick="filterCategory('Hypertension', true)">
        <span class="label">Ø¶ØºØ·</span><span class="icon">â¤ï¸</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Diabetes', true)">
        <span class="label">Ø³ÙƒØ±</span><span class="icon">ğŸ©¸</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Insulin', true)">
        <span class="label">Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†</span><span class="icon">ğŸ’‰</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Thyroid', true)">
        <span class="label">Ø§Ù„ØºØ¯Ø©</span><span class="icon">ğŸ¦‹</span>
      </button>
      <button class="catBtn" onclick="filterCategory('GI', true)">
        <span class="label">Ø§Ù„Ù…Ø¹Ø¯Ø©</span><span class="icon">ğŸ½</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Anticoagulant', true)">
        <span class="label">Ù…ÙÙ…ÙŠØ¹Ø§Øª</span><span class="icon">ğŸ§¬</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Antibiotic', true)">
        <span class="label">Ù…Ø¶Ø§Ø¯Ø§Øª</span><span class="icon">ğŸ¦ </span>
      </button>
      <button class="catBtn" onclick="filterCategory('Pain', true)">
        <span class="label">Ø£Ù„Ù…</span><span class="icon">ğŸ’Š</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Asthma', true)">
        <span class="label">ØµØ¯Ø±</span><span class="icon">ğŸŒ¬ï¸</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Allergy', true)">
        <span class="label">Ø­Ø³Ø§Ø³ÙŠØ©</span><span class="icon">ğŸŒ¿</span>
      </button>
      <button class="catBtn" onclick="filterCategory('Lipids', true)">
        <span class="label">Ø¯Ù‡ÙˆÙ†</span><span class="icon">ğŸ«€</span>
      </button>
      <button class="catBtn" onclick="filterCategory('All', true)">
        <span class="label">Ø§Ù„ÙƒÙ„</span><span class="icon">â­</span>
      </button>
    </div>

    <div class="hr"></div>

    <div class="kpiRow">
      <div class="kpi"><span>Drugs loaded</span><strong id="drugsLoaded">0</strong></div>
      <div class="kpi"><span>Total selections</span><strong id="tracked">0</strong></div>
      <div class="kpi"><span>Top 10</span><strong id="topCount">0</strong></div>
    </div>

    <div class="hr"></div>

    <button id="openTopBtn" class="btn ghost full" onclick="openTop10()">â­ Top 10 Dashboard</button>
    <button class="btn primary full" onclick="exportDrugPDF()">ğŸ“„ Export PDF (Selected)</button>
    <button class="btn ghost full" onclick="exportTop10PDF()">ğŸ“„ Export PDF (Top 10)</button>

    <button class="btn danger full" onclick="resetTracking()">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹ â™»ï¸</button>
    <button class="btn danger full" onclick="clearChat()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ—‘</button>

    <div class="hr"></div>

    <div class="badges">
      <div class="badge">âš ï¸ Ù„Ø§ ÙŠØºÙ†ÙŠ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ</div>
      <div class="badge">ğŸ”’ Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰</div>
      <div class="badge">ğŸ“¶ ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="card">
    <div class="chat" id="chat"></div>

    <div class="row">
      <div class="inputWrap">
        <input id="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ / Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ / Brand / Strength ..." autocomplete="off">
        <div id="suggest" class="suggest"></div>
      </div>
      <button class="btn primary" onclick="searchDrug(true)">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div class="chips" id="chips"></div>
  </div>

</div>

<div class="footer">Created by Automation Supervisor Ali Alsada</div>

<!-- TOP10 MODAL -->
<div class="modalBack" id="modalBack" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHead">
      <strong>â­ Top 10 Dashboard</strong>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn ghost" onclick="exportTop10PDF()">ğŸ“„ Export PDF</button>
        <button class="btn danger" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
      </div>
    </div>
    <div class="modalBody">
      <div id="top10Content"></div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰).
      </div>
    </div>
  </div>
</div>

<!-- EXECUTIVE PRINT AREA -->
<div id="printArea">
  <div class="printHeader">
    <img src="logo_qch.png" class="printLogo" alt="QCH">
    <div class="printTitle">
      <h2>Qatif Central Hospital â€“ Smart Ramadan Medication Assistant</h2>
      <p>Executive PDF</p>
    </div>
    <img src="logo_health_holding.png" class="printLogo" alt="Health Holding">
  </div>

  <div class="printMeta">
    <div>Document: <strong id="printDocType">Medication Guidance</strong></div>
    <div>Generated: <strong id="printDate">â€”</strong></div>
    <div>Created by: <strong>Automation Supervisor Ali Alsada</strong></div>
  </div>

  <div id="printContent"></div>

  <div class="printFooter">
    <div class="warn">âš ï¸ This guidance does not replace clinician advice.</div>
    <div>QCH Pharmacy â€¢ Patient education</div>
  </div>
</div>

<script>
/* ========= SETTINGS ========= */
const TRACK_KEY = "qch_track_counts_v6";
const TOTAL_KEY = "qch_total_selections_v6";

/* ========= STATE ========= */
let DRUGS = [];
let lastSelectedDrug = null;

/* ========= HELPERS ========= */
const $ = (id) => document.getElementById(id);
function safeText(s){ return (s ?? "").toString(); }
function norm(s){ return safeText(s).toLowerCase().trim().replace(/\\s+/g,' '); }
function escapeHtml(s){
  return safeText(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function escapeQuotes(s){ return safeText(s).replace(/'/g,"\\'"); }

/* ===== Scroll helper (go down to chat/last message) ===== */
function scrollToChat(){
  const chat = $("chat");
  if(!chat) return;
  chat.scrollIntoView({ behavior:"smooth", block:"start" });
  setTimeout(()=>{ chat.scrollTop = chat.scrollHeight; }, 120);
}

/* === Category canonicalization === */
const CATEGORY_ALIASES = {
  "gi":"GI","g.i":"GI","gastro":"GI","gastrointestinal":"GI",
  "htn":"Hypertension","bp":"Hypertension","hypertension":"Hypertension",
  "dm":"Diabetes","diabetes":"Diabetes",
  "insulin":"Insulin",
  "blood thinner":"Anticoagulant","anticoagulant":"Anticoagulant",
  "abx":"Antibiotic","antibiotic":"Antibiotic",
  "lipid":"Lipids","lipids":"Lipids",
  "pain":"Pain","analgesic":"Pain",
  "resp":"Asthma","asthma":"Asthma",
  "antihistamine":"Allergy","allergy":"Allergy",
  "thyroid":"Thyroid","endocrine":"Thyroid",
  "all":"All"
};
function canonicalCategory(raw){
  const key = norm(raw);
  return CATEGORY_ALIASES[key] || safeText(raw).trim();
}

/* ========= LOCAL STORAGE ========= */
function getTrackMap(){
  try{ return JSON.parse(localStorage.getItem(TRACK_KEY) || "{}"); }
  catch{ return {}; }
}
function setTrackMap(map){ localStorage.setItem(TRACK_KEY, JSON.stringify(map)); }
function getTotal(){ return Number(localStorage.getItem(TOTAL_KEY) || "0"); }
function setTotal(n){ localStorage.setItem(TOTAL_KEY, String(n)); }

/* Wait for images before printing */
function waitForImages(selector, timeoutMs = 3000){
  const root = document.querySelector(selector);
  if(!root) return Promise.resolve();
  const imgs = Array.from(root.querySelectorAll("img"));
  if(imgs.length === 0) return Promise.resolve();
  const notReady = imgs.filter(img => !img.complete || img.naturalWidth === 0);
  if(notReady.length === 0) return Promise.resolve();

  return new Promise(resolve => {
    let done = false;
    const finish = () => { if(!done){ done = true; resolve(); } };
    const t = setTimeout(finish, timeoutMs);

    notReady.forEach(img => {
      img.addEventListener("load", () => {
        const still = imgs.some(i => !i.complete || i.naturalWidth === 0);
        if(!still){ clearTimeout(t); finish(); }
      }, { once:true });

      img.addEventListener("error", () => { clearTimeout(t); finish(); }, { once:true });

      if(img.naturalWidth === 0){
        const src = img.getAttribute("src");
        if(src) img.src = src + (src.includes("?") ? "&" : "?") + "v=" + Date.now();
      }
    });
  });
}

/* ========= LOAD DRUGS ========= */
async function loadDrugs(){
  try{
    const res = await fetch("./drugs.json?v=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    DRUGS = Array.isArray(data) ? data : [];
    DRUGS = DRUGS.map(d => ({ ...d, category: canonicalCategory(d.category) }));

    $("drugsLoaded").innerText = DRUGS.length;
    $("tracked").innerText = getTotal();
    updateTopCount();
    renderChips();
    greet();
  }catch(e){
    addMessage("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ© (drugs.json). ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ JSON ØµØ­ÙŠØ­ Ø¨Ø¯ÙˆÙ† ØªØ¹Ù„ÙŠÙ‚Ø§Øª.");
    console.log(e);
  }
}
loadDrugs();

/* ========= UI ========= */
function addMessage(html){
  const div = document.createElement("div");
  div.className = "bubble";
  div.innerHTML = html;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function clearChat(){ $("chat").innerHTML=""; greet(); }

function greet(){
  addMessage(
    `<strong>Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</strong>
     <div style="margin-top:6px">
       Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ/Brand/Strength) ÙˆØ³ØªØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙÙˆØ±ÙŠØ©.
     </div>
     <div class="meta"><span>QCH Pharmacy</span></div>`
  );
}

/* ========= SEARCH + AUTOCOMPLETE ========= */
$("input").addEventListener("input", onType);
$("input").addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){ e.preventDefault(); searchDrug(true); }
  if(e.key==="Escape"){ hideSuggest(); }
});

function hideSuggest(){
  $("suggest").style.display="none";
  $("suggest").innerHTML="";
}

function drugSearchBlob(d){
  return norm([d.name, d.name_ar, d.brand, d.strength, d.form, d.category].map(safeText).join(" "));
}
function scoreDrug(d, q){
  const blob = drugSearchBlob(d);
  if(!blob.includes(q)) return 0;

  const en = norm(d.name);
  const ar = norm(d.name_ar);
  const brand = norm(d.brand);
  const strength = norm(d.strength);

  let s = 1;
  if(en.startsWith(q) || ar.startsWith(q)) s += 7;
  if(brand.startsWith(q)) s += 5;
  if(strength.startsWith(q)) s += 3;
  if(en.includes(q) || ar.includes(q)) s += 2;
  if(brand.includes(q)) s += 1;
  return s;
}

function onType(){
  const q = norm($("input").value);
  if(!q || q.length < 2){ hideSuggest(); return; }

  const matches = DRUGS
    .map(d => ({ d, s: scoreDrug(d, q) }))
    .filter(x => x.s > 0)
    .sort((a,b)=>b.s-a.s)
    .slice(0, 10);

  if(matches.length === 0){ hideSuggest(); return; }

  $("suggest").innerHTML = matches.map(x=>{
    const d = x.d;
    const en = safeText(d.name);
    const ar = safeText(d.name_ar);
    const br = safeText(d.brand);
    const st = safeText(d.strength);
    const cat = safeText(d.category);

    const title = (ar || en);
    const sub = [
      en && ar ? en : "",
      br ? `Brand: ${br}` : "",
      st ? `Strength: ${st}` : "",
      cat ? `â€¢ ${cat}` : ""
    ].filter(Boolean).join(" â€” ");

    return `
      <button type="button" onclick="pickDrug('${escapeQuotes(en)}', true)">
        <div><strong>${escapeHtml(title)}</strong></div>
        <div class="line2">${escapeHtml(sub)}</div>
      </button>
    `;
  }).join("");

  $("suggest").style.display="block";
}

function pickDrug(englishName, scrollDown=false){
  $("input").value = englishName;
  hideSuggest();
  searchDrug(scrollDown);
}

function findBestDrug(qRaw){
  const q = norm(qRaw);
  if(!q) return null;

  const ranked = DRUGS.map(d=>({ d, s: scoreDrug(d, q) })).sort((a,b)=>b.s-a.s);
  if(ranked.length && ranked[0].s > 0) return ranked[0].d;
  return null;
}

function searchDrug(scrollDown=false){
  const qRaw = $("input").value;
  const q = norm(qRaw);
  if(!q) return;

  const drug = findBestDrug(qRaw);
  if(drug){
    lastSelectedDrug = drug;
    trackSelection(drug);
    renderDrug(drug);
    $("input").value = "";
    hideSuggest();
    if(scrollDown) scrollToChat();
  }else{
    addMessage("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚. Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø­Ø±ÙÙŠÙ† Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª.");
    if(scrollDown) scrollToChat();
  }
}

/* ========= RENDER ========= */
function riskLabel(r){
  const v = norm(r);
  if(v==="high") return "High Risk";
  if(v==="moderate") return "Moderate Risk";
  if(v==="low") return "Low Risk";
  return "-";
}

function renderDrug(d){
  const en = safeText(d.name);
  const ar = safeText(d.name_ar);
  const br = safeText(d.brand);
  const st = safeText(d.strength);
  const form = safeText(d.form);
  const cat = safeText(d.category);
  const risk = safeText(d.risk);

  const guide = safeText(d.ramadan_ar || d.ramadan || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯.");
  const notes = safeText(d.notes_ar || "");

  const map = getTrackMap();
  const count = map[en] || 0;

  const title = ar || en;
  const alt = (en && ar) ? `(${en})` : "";

  const notesBlock = notes ? `
    <div style="margin-top:10px">
      <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</strong>
      <div>${escapeHtml(notes).replaceAll("\\n","<br>")}</div>
    </div>` : "";

  addMessage(`
    <strong>${escapeHtml(title)}</strong>
    ${alt ? `<small style="color:var(--muted)"> ${escapeHtml(alt)}</small>` : ""}
    <div style="margin-top:10px">${escapeHtml(guide).replaceAll("\\n","<br>")}</div>
    ${notesBlock}
    <div class="meta">
      ${cat ? `<span class="tag">ğŸ· ${escapeHtml(cat)}</span>` : ""}
      ${br ? `<span class="tag">ğŸ­ ${escapeHtml(br)}</span>` : ""}
      ${st ? `<span class="tag">âš–ï¸ ${escapeHtml(st)}</span>` : ""}
      ${form ? `<span class="tag">ğŸ§¾ ${escapeHtml(form)}</span>` : ""}
      ${risk ? `<span class="tag">âš ï¸ ${escapeHtml(riskLabel(risk))}</span>` : ""}
      <span class="tag">â­ Selected: <strong>${count}</strong>x</span>
    </div>
    <div class="meta">
      <span style="color:var(--ok)">âœ… Ready for Executive PDF</span>
      <span>Qatif Health Network</span>
    </div>
  `);
}

/* ========= CATEGORY FILTER (scrolls down) ========= */
function filterCategory(cat, scrollDown=false){
  const sel = norm(canonicalCategory(cat));

  let results = [];
  if(sel === "all"){
    results = DRUGS.slice();
  }else{
    results = DRUGS.filter(d => norm(canonicalCategory(d.category)) === sel);
  }

  if(results.length === 0){
    addMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.");
    if(scrollDown) scrollToChat();
    return;
  }

  addMessage(`<strong>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµÙ†ÙŠÙ: ${escapeHtml(cat)}</strong> <span style="color:var(--muted);font-size:12px">(${results.length})</span>`);
  results.slice(0, 25).forEach(d => renderDrug(d));
  if(results.length > 25) addMessage(`â€¦ ØªÙ… Ø¹Ø±Ø¶ 25 ÙÙ‚Ø· Ù…Ù† Ø£ØµÙ„ ${results.length}`);

  if(scrollDown) scrollToChat();
}

/* ========= TRACKING ========= */
function trackSelection(d){
  const en = safeText(d.name);
  const map = getTrackMap();
  map[en] = (map[en] || 0) + 1;
  setTrackMap(map);

  const total = getTotal() + 1;
  setTotal(total);
  $("tracked").innerText = total;

  updateTopCount();
  renderChips();
}

function updateTopCount(){
  const map = getTrackMap();
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);
  $("topCount").innerText = top.length;
}

function resetTracking(){
  localStorage.removeItem(TRACK_KEY);
  localStorage.removeItem(TOTAL_KEY);
  $("tracked").innerText = "0";
  updateTopCount();
  renderChips();
  addMessage("âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØªØ¨Ø¹.");
}

/* ========= TOP10 DASHBOARD ========= */
function openTop10(){
  const map = getTrackMap();
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

  if(entries.length === 0){
    addMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ¨Ø¹ Ø¨Ø¹Ø¯.");
    scrollToChat();
    return;
  }

  const rows = entries.map(([name, count], i)=>{
    const d = DRUGS.find(x=>safeText(x.name)===name);
    const ar = d ? safeText(d.name_ar) : "";
    const br = d ? safeText(d.brand) : "";
    const st = d ? safeText(d.strength) : "";
    const cat = d ? safeText(d.category) : "";
    const label = ar ? `${ar} (${name})` : name;
    const sub = [cat, br, st].filter(Boolean).join(" â€” ");

    return `
      <tr>
        <td>${i+1}</td>
        <td><strong>${escapeHtml(label)}</strong><div style="color:var(--muted);font-size:12px;margin-top:3px">${escapeHtml(sub)}</div></td>
        <td><strong>${count}</strong></td>
      </tr>
    `;
  }).join("");

  $("top10Content").innerHTML = `
    <table class="table">
      <thead>
        <tr>
          <th style="width:70px">#</th>
          <th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
          <th style="width:140px">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  $("modalBack").style.display="flex";
}
function closeModal(){ $("modalBack").style.display="none"; }

/* ========= CHIPS ========= */
function renderChips(){
  const container = $("chips");
  if(!container) return;

  const map = getTrackMap();
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);

  const list = (top.length ? top : []).map(n=>{
    const d = DRUGS.find(x=>norm(x.name)===norm(n));
    const label = d ? (d.name_ar || d.name) : n;
    const key = d ? d.name : n;
    return `<div class="chip" onclick="pickDrug('${escapeQuotes(key)}', true)">â­ ${escapeHtml(label)}</div>`;
  }).join("");

  container.innerHTML = list || `<div style="color:var(--muted);font-size:12px">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡ Ù„ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© â­</div>`;
}

/* ========= EXECUTIVE PDF EXPORT (Selected) ========= */
async function exportDrugPDF(){
  if(!lastSelectedDrug){
    addMessage("Ø§Ø®ØªØ± Ø¯ÙˆØ§Ø¡ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Export PDF.");
    scrollToChat();
    return;
  }

  const d = lastSelectedDrug;
  const medTitle = (d.name_ar || d.name || "-");
  const alt = (d.name && d.name_ar) ? `(${d.name})` : "";
  const cat = d.category || "-";
  const brand = d.brand || "-";
  const strength = d.strength || "-";
  const form = d.form || "-";
  const guide = (d.ramadan_ar || d.ramadan || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯.");
  const notes = (d.notes_ar || "");

  $("printDocType").innerText = "Medication Guidance (Ramadan)";
  $("printDate").innerText = new Date().toLocaleString();

  $("printContent").innerHTML = `
    <div class="bubble">
      <strong style="font-size:15px">${escapeHtml(medTitle)}</strong>
      ${alt ? `<span style="color:var(--muted); font-size:12px"> ${escapeHtml(alt)}</span>` : ""}

      <div style="margin-top:10px; font-size:12px; color:var(--muted)">
        <div><strong>Category:</strong> ${escapeHtml(cat)}</div>
        <div><strong>Brand:</strong> ${escapeHtml(brand)}</div>
        <div><strong>Strength:</strong> ${escapeHtml(strength)}</div>
        <div><strong>Form:</strong> ${escapeHtml(form)}</div>
      </div>

      <div style="margin-top:12px; line-height:1.7">
        <strong>Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø±Ù…Ø¶Ø§Ù†</strong>
        <div style="margin-top:6px">${escapeHtml(guide).replaceAll("\\n","<br>")}</div>
      </div>

      ${notes ? `
      <div style="margin-top:12px; line-height:1.7">
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</strong>
        <div style="margin-top:6px">${escapeHtml(notes).replaceAll("\\n","<br>")}</div>
      </div>` : ""}

      <div style="margin-top:12px; font-size:11px; color:var(--muted)">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰.
      </div>
    </div>
  `;

  await waitForImages("#printArea", 3500);
  setTimeout(()=>window.print(), 150);
}

/* ========= EXECUTIVE PDF EXPORT (Top10) ========= */
async function exportTop10PDF(){
  const map = getTrackMap();
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,10);

  if(entries.length === 0){
    addMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØªØ¨Ø¹ Ø¨Ø¹Ø¯.");
    scrollToChat();
    return;
  }

  $("printDocType").innerText = "Top 10 Dashboard";
  $("printDate").innerText = new Date().toLocaleString();

  const rows = entries.map(([name,count], i)=>{
    const d = DRUGS.find(x=>safeText(x.name)===name);
    const ar = d ? safeText(d.name_ar) : "";
    const br = d ? safeText(d.brand) : "";
    const st = d ? safeText(d.strength) : "";
    const cat = d ? safeText(d.category) : "";
    const label = ar ? `${ar} (${name})` : name;
    const sub = [cat, br, st].filter(Boolean).join(" â€” ");

    return `
      <tr>
        <td>${i+1}</td>
        <td><strong>${escapeHtml(label)}</strong><div style="color:var(--muted);font-size:12px;margin-top:3px">${escapeHtml(sub)}</div></td>
        <td><strong>${count}</strong></td>
      </tr>
    `;
  }).join("");

  $("printContent").innerHTML = `
    <div class="bubble">
      <strong style="font-size:15px">â­ Top 10 Most Selected Medications</strong>
      <div style="margin-top:10px">
        <table class="table">
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th>Medication</th>
              <th style="width:140px">Count</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--muted)">
        This data is stored locally on the device (no patient identifiers).
      </div>
    </div>
  `;

  await waitForImages("#printArea", 3500);
  setTimeout(()=>window.print(), 150);
}

/* ========= PWA REGISTER ========= */
if ("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./service-worker.js")
      .then(()=>console.log("âœ… Service Worker registered"))
      .catch(err=>console.log("SW error", err));
  });
}
</script>

</body>
</html>
