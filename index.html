<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCH â€“ Smart Ramadan Medication Assistant</title>
  <meta name="description" content="Qatif Central Hospital â€“ Ramadan Medication Assistant (Arabic/English)." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1f26">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#0b1f26;
      --bg2:#081a20;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.18);
      --text:#eaf6fb;
      --muted:#b7d2dd;
      --accent:#35d0c7;
      --accent2:#2aa6ff;
      --danger:#ff4d4f;
      --warn:#f5a524;
      --ok:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(53,208,199,.18), transparent 55%),
        radial-gradient(1200px 700px at 85% 20%, rgba(42,166,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
    }

    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.10);
    }
    .logoBox{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .logoBox img{height:58px; width:auto; display:block; object-fit:contain;}
    .sep{width:1px; height:36px; background:rgba(255,255,255,.18);}
    .titles{line-height:1.15}
    .titles h1{margin:0; font-size:18px; font-weight:900; letter-spacing:.2px;}
    .titles .sub{margin-top:6px; font-size:13px; color:var(--muted);}

    .headerActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.10);}
    .btn.primary{
      border-color: rgba(53,208,199,.55);
      background: linear-gradient(180deg, rgba(53,208,199,.22), rgba(53,208,199,.10));
      font-weight:800;
    }
    .btn.danger{
      border-color: rgba(255,77,79,.55);
      background: linear-gradient(180deg, rgba(255,77,79,.20), rgba(255,77,79,.10));
      font-weight:800;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.7fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    /* Cards */
    .card{overflow:hidden;}
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      background: rgba(0,0,0,.10);
    }
    .cardHead .title{font-weight:900; font-size:13px;}
    .cardHead .hint{font-size:12px; color:var(--muted);}

    /* Chat */
    #chat{
      height:560px;
      overflow:auto;
      padding:14px;
      background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,.06));
    }
    .msg{display:flex; flex-direction:column; gap:8px; margin:12px 0;}
    .msg.user{align-items:flex-end;}
    .msg.bot{align-items:flex-start;}

    .bubble{
      max-width: 92%;
      padding:12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      line-height:1.55;
      font-size:14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      white-space:pre-wrap;
    }
    .msg.user .bubble{
      background: linear-gradient(180deg, rgba(42,166,255,.22), rgba(42,166,255,.10));
      border-color: rgba(42,166,255,.28);
    }
    .msg.bot .bubble{
      background: linear-gradient(180deg, rgba(53,208,199,.18), rgba(255,255,255,.04));
      border-color: rgba(53,208,199,.26);
    }

    .bubble .h{
      font-weight:900;
      font-size:15px;
      margin-bottom:6px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-size:12px;
      font-weight:800;
    }
    .tag.warn{border-color: rgba(245,165,36,.45); background: rgba(245,165,36,.12);}
    .tag.danger{border-color: rgba(255,77,79,.45); background: rgba(255,77,79,.12);}
    .tag.ok{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.12);}

    .bubbleActions{display:flex; gap:8px; flex-wrap:wrap;}
    .mini{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .mini:hover{background: rgba(255,255,255,.10);}

    /* Composer */
    .composer{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      background: rgba(0,0,0,.10);
      align-items:center;
    }
    #userInput{
      flex:1;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    #userInput::placeholder{color: rgba(183,210,221,.85);}
    #sendBtn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(53,208,199,.55);
      background: linear-gradient(180deg, rgba(53,208,199,.28), rgba(53,208,199,.12));
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    #sendBtn:hover{filter:brightness(1.05);}

    /* Sidebar */
    .side{padding:14px;}
    .section{margin-bottom:14px;}
    .section h3{margin:0 0 10px 0; font-size:13px; font-weight:900;}
    .chips{display:flex; flex-wrap:wrap; gap:10px;}
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size:13px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip:hover{background: rgba(255,255,255,.10);}

    .kpis{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .kpi{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
    }
    .kpi .num{font-size:20px; font-weight:950;}
    .kpi .lbl{margin-top:4px; font-size:12px; color:var(--muted);}

    .note{
      font-size:12px;
      color: rgba(183,210,221,.92);
      line-height:1.6;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:10px;
    }
    .footer{
      margin-top:12px;
      text-align:center;
      font-size:12px;
      color: rgba(183,210,221,.9);
    }

    /* Modal */
    #topModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;}
    .modalBox{
      max-width:560px;
      margin: 9vh auto;
      background: #0b1f26;
      border:1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:16px;
      color:var(--text);
    }
    .modalHead{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .row{display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.12); font-size:13px;}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header -->
    <div class="header glass">
      <div class="brand">
        <div class="logoBox" title="QCH">
          <img src="logo_qch.png" alt="QCH Logo">
        </div>
        <div class="sep"></div>
        <div class="logoBox" title="Health Holding">
          <img src="logo_health_holding.png" alt="Health Holding Logo">
        </div>
        <div class="titles">
          <h1 id="appTitle">QCH â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©</h1>
          <div class="sub" id="appSub">Ø¹Ø±Ø¨ÙŠ / English Â· Patient-friendly Â· Offline analytics</div>
        </div>
      </div>

      <div class="headerActions">
        <button id="langBtn" class="btn primary" type="button">ğŸŒ English</button>
        <button id="topBtn" class="btn" type="button">ğŸ“Š Top 10</button>
        <button id="installBtn" class="btn" type="button" style="display:none;">â¬‡ï¸ Install</button>
        <button id="clearBtn" class="btn danger" type="button">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
      </div>
    </div>

    <div class="grid">

      <!-- Chat Card -->
      <div class="card glass">
        <div class="cardHead">
          <div>
            <div class="title" id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
            <div class="hint" id="chatHint">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡â€¦ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©</div>
          </div>
          <div class="hint" id="statusHint">Loadingâ€¦</div>
        </div>

        <div id="chat"></div>

        <div class="composer">
          <input id="userInput" list="drugHints" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„â€¦" autocomplete="off" />
          <datalist id="drugHints"></datalist>
          <button id="sendBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>

      <!-- Side Card -->
      <div class="card glass">
        <div class="cardHead">
          <div>
            <div class="title" id="sideTitle">Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø©</div>
            <div class="hint" id="sideHint">Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø£Ùˆ Ù†ØµØ§Ø¦Ø­</div>
          </div>
          <div class="hint" id="sideStatus">Executive</div>
        </div>

        <div class="side">

          <div class="section">
            <h3 id="chipsTitle">Categories</h3>
            <div class="chips" id="chips"></div>
          </div>

          <div class="section">
            <h3 id="kpiTitle">Analytics (local)</h3>
            <div class="kpis">
              <div class="kpi">
                <div class="num" id="kpiUsed">0</div>
                <div class="lbl" id="kpiUsedLbl">Tracked selections</div>
              </div>
              <div class="kpi">
                <div class="num" id="kpiDrugs">0</div>
                <div class="lbl" id="kpiDrugsLbl">Drugs loaded</div>
              </div>
            </div>
          </div>

          <div class="note" id="noteBox">
            â€¢ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ù„Ù„ØªÙˆØ¹ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø· ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ.<br>
            â€¢ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ù†ÙØ³Ùƒ Ø®ØµÙˆØµØ§Ù‹ (Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/Ø§Ù„Ø³ÙŠÙˆÙ„Ø©/Ù…Ø¯Ø±Ø§Øª Ø§Ù„Ø¨ÙˆÙ„).<br>
            â€¢ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦: ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰/911.
          </div>

          <div class="footer" id="footerText">Created by Automation Supervisor Ali Alsada</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Top 10 Modal -->
  <div id="topModal">
    <div class="modalBox">
      <div class="modalHead">
        <div style="font-weight:950" id="topTitle">ğŸ“Š Top 10</div>
        <button id="topClose" class="btn" type="button">âœ• Close</button>
      </div>
      <div id="topList" style="margin-top:12px;"></div>
      <div style="margin-top:10px; color:rgba(183,210,221,.9); font-size:12px" id="topNote">
        Stored locally in your browser (no server).
      </div>
    </div>
  </div>

  <script>
    // ==============================
    //  Executive Ramadan Assistant
    // ==============================

    // ---------- Language ----------
    let LANG = "ar";
    const T = {
      ar: {
        dir:"rtl", htmlLang:"ar",
        langBtn:"ğŸŒ English",
        appTitle:"QCH â€“ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø£Ø¯ÙˆÙŠØ©",
        appSub:"Ø¹Ø±Ø¨ÙŠ / English Â· Patient-friendly Â· Offline analytics",
        chatTitle:"Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©",
        chatHint:"Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡â€¦ ÙˆØ³ÙŠØ¸Ù‡Ø± Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©",
        sideTitle:"Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø©",
        sideHint:"Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø£Ùˆ Ù†ØµØ§Ø¦Ø­",
        chipsTitle:"Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª",
        kpiTitle:"Analytics (local)",
        usedLbl:"Tracked selections",
        drugsLbl:"Drugs loaded",
        statusLoading:"Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ drugs.jsonâ€¦",
        statusReady:"Ready",
        placeholder:"Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø£Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„â€¦",
        send:"Ø¥Ø±Ø³Ø§Ù„",
        clear:"ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©",
        top:"ğŸ“Š Top 10",
        topTitle:"ğŸ“Š Top 10 Ø£Ø¯ÙˆÙŠØ©",
        topEmpty:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø§Øª ÙˆØ³ÙŠØªÙƒÙˆÙ‘Ù† Top 10 ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.",
        welcomeTitle:"Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹",
        welcome:"Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ (Ù…Ø«Ø§Ù„: Metformin 500 mg) Ø£Ùˆ Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±.",
        disclaimer:"ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ«Ù‚ÙŠÙ ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ. Ø®ØµÙˆØµØ§Ù‹ (Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/Ø§Ù„Ø³ÙŠÙˆÙ„Ø©/Ù…Ø¯Ø±Ø§Øª Ø§Ù„Ø¨ÙˆÙ„) Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ©.",
        copy:"ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø¯",
        copied:"âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®",
        notFound:"Ù„Ù… Ø£Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù….",
        tipsTitle:"ğŸ•’ Ù†ØµØ§Ø¦Ø­ Ø±Ù…Ø¶Ø§Ù†",
        tipsText:"â€¢ Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ù†ÙØ³Ùƒ.\nâ€¢ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ØªÙÙ‚Ø³Ù… Ø¨ÙŠÙ† Ø§Ù„Ø¥ÙØ·Ø§Ø± ÙˆØ§Ù„Ø³Ø­ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·Ø©.\nâ€¢ Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³ÙƒØ± Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…Ø±ÙŠØ¶ Ø³ÙƒØ±ÙŠ.\nâ€¢ Ù…Ø¯Ø±Ø§Øª Ø§Ù„Ø¨ÙˆÙ„ Ù‚Ø¯ ØªØ²ÙŠØ¯ Ø§Ù„Ø¬ÙØ§Ùâ€”Ø§Ø³Ø£Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¨.\nâ€¢ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†/Ø§Ù„Ø³ÙŠÙˆÙ„Ø©) ØªØ­ØªØ§Ø¬ Ø®Ø·Ø© ÙØ±Ø¯ÙŠØ©.",
        chips: [
          { label:"â­ Ø§Ù„Ø´Ø§Ø¦Ø¹", q:"__TOP__" },
          { label:"â¤ï¸ Ø¶ØºØ·", q:"__CAT__:Hypertension" },
          { label:"ğŸ©¸ Ø³ÙƒØ±", q:"__CAT__:Diabetes" },
          { label:"ğŸ¦‹ Ø§Ù„ØºØ¯Ø©", q:"__CAT__:Thyroid" },
          { label:"ğŸ«§ Ø§Ù„Ù…Ø¹Ø¯Ø©", q:"__CAT__:GI" },
          { label:"ğŸ’Š Ù…Ø³ÙƒÙ†Ø§Øª", q:"__CAT__:Pain" },
          { label:"ğŸ¦  Ù…Ø¶Ø§Ø¯Ø§Øª", q:"__CAT__:Antibiotic" },
          { label:"ğŸ§ˆ Ø¯Ù‡ÙˆÙ†", q:"__CAT__:Lipids" },
          { label:"ğŸŒ¬ Ø±Ø¨Ùˆ", q:"__CAT__:Asthma" },
          { label:"ğŸ¤§ Ø­Ø³Ø§Ø³ÙŠØ©", q:"__CAT__:Allergy" },
          { label:"âš ï¸ Ø³ÙŠÙˆÙ„Ø©", q:"__CAT__:Anticoagulant" },
          { label:"ğŸ§  Ù†ÙØ³ÙŠØ©", q:"__CAT__:Psych" },
          { label:"ğŸ¦´ ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª", q:"__CAT__:Vitamin" },
          { label:"ğŸ§‚ Ø£Ù…Ù„Ø§Ø­", q:"__CAT__:Electrolytes" },
          { label:"ğŸ«€ ÙØ´Ù„ Ù‚Ù„Ø¨ÙŠ", q:"__CAT__:HeartFailure" },
          { label:"ğŸ’‰ Ø³ØªÙŠØ±ÙˆÙŠØ¯/Ù…Ù†Ø§Ø¹Ø©", q:"__CAT__:Steroid" },
          { label:"ğŸ•’ Ù†ØµØ§Ø¦Ø­ Ø±Ù…Ø¶Ø§Ù†", q:"__RAMADAN_TIPS__" }
        ]
      },
      en: {
        dir:"ltr", htmlLang:"en",
        langBtn:"ğŸŒ Arabic",
        appTitle:"QCH â€“ Smart Ramadan Medication Assistant",
        appSub:"Arabic / English Â· Patient-friendly Â· Offline analytics",
        chatTitle:"Chat",
        chatHint:"Type medication nameâ€¦ autocomplete appears while typing",
        sideTitle:"Quick buttons",
        sideHint:"Choose a category or tips",
        chipsTitle:"Categories",
        kpiTitle:"Analytics (local)",
        usedLbl:"Tracked selections",
        drugsLbl:"Drugs loaded",
        statusLoading:"Loading drugs.jsonâ€¦",
        statusReady:"Ready",
        placeholder:"Type medication name or questionâ€¦",
        send:"Send",
        clear:"ğŸ—‘ Clear chat",
        top:"ğŸ“Š Top 10",
        topTitle:"ğŸ“Š Top 10 meds",
        topEmpty:"No data yet. Use the chatbot and it will auto-build Top 10.",
        welcomeTitle:"Hello ğŸ‘‹",
        welcome:"Type a medication name (e.g., Metformin 500 mg) or tap a category button.",
        disclaimer:"Note: General guidance only, not a substitute for a clinician/pharmacist. High-risk meds (insulin/anticoagulants/diuretics) need an individualized plan.",
        copy:"ğŸ“‹ Copy reply",
        copied:"âœ… Copied",
        notFound:"I couldnâ€™t find this medication in the list. Try English name or part of the name.",
        tipsTitle:"ğŸ•’ Ramadan tips",
        tipsText:"â€¢ Donâ€™t change doses on your own.\nâ€¢ Some meds are split between Iftar/Suhoor per plan.\nâ€¢ Monitor glucose if diabetic.\nâ€¢ Diuretics can worsen dehydrationâ€”ask clinician.\nâ€¢ High-risk meds (insulin/anticoagulants) need a plan.",
        chips: [
          { label:"â­ Common", q:"__TOP__" },
          { label:"â¤ï¸ BP", q:"__CAT__:Hypertension" },
          { label:"ğŸ©¸ Diabetes", q:"__CAT__:Diabetes" },
          { label:"ğŸ¦‹ Thyroid", q:"__CAT__:Thyroid" },
          { label:"ğŸ«§ GI", q:"__CAT__:GI" },
          { label:"ğŸ’Š Pain", q:"__CAT__:Pain" },
          { label:"ğŸ¦  Antibiotic", q:"__CAT__:Antibiotic" },
          { label:"ğŸ§ˆ Lipids", q:"__CAT__:Lipids" },
          { label:"ğŸŒ¬ Asthma", q:"__CAT__:Asthma" },
          { label:"ğŸ¤§ Allergy", q:"__CAT__:Allergy" },
          { label:"âš ï¸ Anticoagulant", q:"__CAT__:Anticoagulant" },
          { label:"ğŸ§  Psych", q:"__CAT__:Psych" },
          { label:"ğŸ¦´ Vitamins", q:"__CAT__:Vitamin" },
          { label:"ğŸ§‚ Electrolytes", q:"__CAT__:Electrolytes" },
          { label:"ğŸ«€ Heart failure", q:"__CAT__:HeartFailure" },
          { label:"ğŸ’‰ Steroid/Immuno", q:"__CAT__:Steroid" },
          { label:"ğŸ•’ Ramadan tips", q:"__RAMADAN_TIPS__" }
        ]
      }
    };

    function applyLang(){
      document.documentElement.dir = T[LANG].dir;
      document.documentElement.lang = T[LANG].htmlLang;

      document.getElementById("langBtn").textContent = T[LANG].langBtn;
      document.getElementById("appTitle").textContent = T[LANG].appTitle;
      document.getElementById("appSub").textContent = T[LANG].appSub;
      document.getElementById("chatTitle").textContent = T[LANG].chatTitle;
      document.getElementById("chatHint").textContent = T[LANG].chatHint;
      document.getElementById("sideTitle").textContent = T[LANG].sideTitle;
      document.getElementById("sideHint").textContent = T[LANG].sideHint;
      document.getElementById("chipsTitle").textContent = T[LANG].chipsTitle;
      document.getElementById("kpiTitle").textContent = T[LANG].kpiTitle;
      document.getElementById("kpiUsedLbl").textContent = T[LANG].usedLbl;
      document.getElementById("kpiDrugsLbl").textContent = T[LANG].drugsLbl;

      document.getElementById("userInput").placeholder = T[LANG].placeholder;
      document.getElementById("sendBtn").textContent = T[LANG].send;
      document.getElementById("clearBtn").textContent = T[LANG].clear;
      document.getElementById("topBtn").textContent = T[LANG].top;
      document.getElementById("topTitle").textContent = T[LANG].topTitle;
      renderChips();
    }

    // ---------- Analytics ----------
    function trackDrugUse(drugKey){
      try{
        const key = "qch_drug_analytics_v1";
        const db = JSON.parse(localStorage.getItem(key) || "{}");
        db[drugKey] = (db[drugKey] || 0) + 1;
        localStorage.setItem(key, JSON.stringify(db));
        updateKpis();
      }catch(e){}
    }
    function getTopDrugs(limit=10){
      const key = "qch_drug_analytics_v1";
      const db = JSON.parse(localStorage.getItem(key) || "{}");
      return Object.entries(db).sort((a,b)=>b[1]-a[1]).slice(0, limit);
    }
    function getTotalTracked(){
      const key = "qch_drug_analytics_v1";
      const db = JSON.parse(localStorage.getItem(key) || "{}");
      return Object.values(db).reduce((a,b)=>a+b,0);
    }
    function updateKpis(){
      document.getElementById("kpiUsed").textContent = String(getTotalTracked());
      document.getElementById("kpiDrugs").textContent = String(DRUGS.length || 0);
    }

    // ---------- Helpers ----------
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function normalize(s){ return (s||"").toString().trim().toLowerCase(); }
    function scrollChat(){
      const c = document.getElementById("chat");
      c.scrollTop = c.scrollHeight;
    }

    // ---------- Chat UI ----------
    function addUserMessage(text){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg user";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollChat();
    }

    function addBotMessage({title, lines=[], tags=[], disclaimer=true, copyText=""}){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg bot";

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const h = document.createElement("div");
      h.className = "h";
      h.innerHTML = escapeHtml(title);

      // tags
      tags.forEach(t=>{
        const span = document.createElement("span");
        span.className = "tag " + (t.type || "");
        span.textContent = t.text;
        h.appendChild(span);
      });

      bubble.appendChild(h);

      if(lines.length){
        const body = document.createElement("div");
        body.style.marginTop = "6px";
        body.textContent = lines.join("\n");
        bubble.appendChild(body);
      }

      if(disclaimer){
        const d = document.createElement("div");
        d.style.marginTop = "10px";
        d.style.paddingTop = "10px";
        d.style.borderTop = "1px solid rgba(255,255,255,.12)";
        d.style.color = "rgba(183,210,221,.95)";
        d.style.fontSize = "12px";
        d.textContent = "âš ï¸ " + T[LANG].disclaimer;
        bubble.appendChild(d);
      }

      const actions = document.createElement("div");
      actions.className = "bubbleActions";

      const copyBtn = document.createElement("button");
      copyBtn.className = "mini";
      copyBtn.type = "button";
      copyBtn.textContent = T[LANG].copy;
      copyBtn.onclick = async () => {
        const textToCopy = copyText || bubble.innerText;
        try{
          await navigator.clipboard.writeText(textToCopy);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=>copyBtn.textContent = T[LANG].copy, 1200);
        }catch(e){
          const ta = document.createElement("textarea");
          ta.value = textToCopy; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy");
          document.body.removeChild(ta);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=>copyBtn.textContent = T[LANG].copy, 1200);
        }
      };

      actions.appendChild(copyBtn);

      wrap.appendChild(bubble);
      wrap.appendChild(actions);
      chat.appendChild(wrap);
      scrollChat();
    }

    function clearChat(){
      document.getElementById("chat").innerHTML = "";
      addWelcome();
    }

    function addWelcome(){
      addBotMessage({
        title: T[LANG].welcomeTitle,
        lines: [T[LANG].welcome],
        tags: [{text:"QCH", type:"ok"}],
        disclaimer: false,
        copyText: T[LANG].welcome
      });
    }

    // ---------- Drugs + Autocomplete ----------
    let DRUGS = [];

    async function loadDrugsJson(){
      const status = document.getElementById("statusHint");
      status.textContent = T[LANG].statusLoading;
      try{
        const res = await fetch("drugs.json", {cache:"no-store"});
        if(!res.ok) throw new Error("no drugs.json");
        const data = await res.json();
        DRUGS = Array.isArray(data) ? data : [];
        status.textContent = T[LANG].statusReady;
        updateKpis();
      }catch(e){
        DRUGS = [];
        status.textContent = "drugs.json not found";
        updateKpis();
      }
    }

    function updateHints(q){
      const dl = document.getElementById("drugHints");
      dl.innerHTML = "";
      const query = normalize(q);
      if(query.length < 2) return;

      let count = 0;
      for(const d of DRUGS){
        const hay = normalize((d.name||"") + " " + (d.brand||"") + " " + (d.name_ar||"") + " " + (d.strength||""));
        if(hay.includes(query)){
          const opt = document.createElement("option");
          const label = (LANG==="ar" && d.name_ar) ? d.name_ar : (d.name||"");
          opt.value = (label || "") + (d.strength ? (" " + d.strength) : "");
          dl.appendChild(opt);
          count++;
          if(count >= 12) break;
        }
      }
    }

    function findDrug(q){
      const query = normalize(q);
      if(!query) return null;

      // Exact match (name+strength) in either language
      for(const d of DRUGS){
        const k1 = normalize((d.name||"") + " " + (d.strength||""));
        const k2 = normalize((d.name_ar||"") + " " + (d.strength||""));
        if(k1 === query || k2 === query) return d;
      }
      // Contains
      for(const d of DRUGS){
        const hay = normalize((d.name||"") + " " + (d.brand||"") + " " + (d.name_ar||"") + " " + (d.strength||""));
        if(hay.includes(query)) return d;
      }
      return null;
    }

    function buildDrugReply(d){
      const title = (LANG==="ar" && d.name_ar) ? d.name_ar : (d.name || "Medication");
      const brand = d.brand ? ` (${d.brand})` : "";
      const strength = d.strength ? ` â€” ${d.strength}` : "";
      const cls = (LANG==="ar" ? (d.class_ar || "") : (d.class_en || "")) || (d.class || "");
      const category = d.category || "";

      const notes = (LANG==="ar" ? d.notes_ar : d.notes_en) || "";
      const ramadan = (LANG==="ar" ? d.ramadan_ar : d.ramadan_en) || "";

      const risk = normalize(d.risk || "");
      let riskTag = {text:"âœ… General", type:"ok"};
      if(LANG==="ar") riskTag = {text:"âœ… Ø¥Ø±Ø´Ø§Ø¯ Ø¹Ø§Ù…", type:"ok"};
      if(risk === "moderate") riskTag = (LANG==="ar") ? {text:"âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡", type:"warn"} : {text:"âš ï¸ Caution", type:"warn"};
      if(risk === "high") riskTag = (LANG==="ar") ? {text:"â›” ÙŠØ­ØªØ§Ø¬ Ø®Ø·Ø© ÙØ±Ø¯ÙŠØ©", type:"danger"} : {text:"â›” Needs plan", type:"danger"};

      const tags = [];
      if(category) tags.push({text: category, type:""});
      if(cls) tags.push({text: cls, type:""});
      tags.push(riskTag);

      const lines = [];
      if(notes) lines.push("ğŸ“ " + notes);
      if(ramadan) lines.push("ğŸŒ™ " + ramadan);

      const copyText =
        `ğŸ’Š ${title}${brand}${strength}\n` +
        (category ? `Category: ${category}\n` : "") +
        (cls ? `Class: ${cls}\n` : "") +
        (notes ? `\nNotes:\n${notes}\n` : "") +
        (ramadan ? `\nRamadan:\n${ramadan}\n` : "") +
        `\nâš ï¸ ${T[LANG].disclaimer}`;

      return {
        title: `ğŸ’Š ${title}${brand}${strength}`,
        lines,
        tags,
        copyText
      };
    }

    // ---------- Category Listing ----------
    function listByCategory(cat){
      const c = normalize(cat);
      const items = DRUGS.filter(d => normalize(d.category) === c).slice(0, 30);

      const title = (LANG==="ar") ? `ğŸ“Œ ${cat}` : `ğŸ“Œ ${cat}`;
      if(!items.length){
        addBotMessage({
          title,
          lines: [ (LANG==="ar") ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ. ØªØ£ÙƒØ¯ Ø£Ù† drugs.json ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ category ØµØ­ÙŠØ­." : "No items found. Ensure drugs.json includes correct category values." ],
          tags: [{text:"Info", type:"warn"}],
          disclaimer:false
        });
        return;
      }

      const lines = items.map(d=>{
        const nm = (LANG==="ar" && d.name_ar) ? d.name_ar : (d.name||"");
        return `â€¢ ${nm}${d.strength ? " " + d.strength : ""}`;
      });

      addBotMessage({
        title,
        lines,
        tags: [{text: `Count: ${items.length}`, type:"ok"}],
        disclaimer:false,
        copyText: `${title}\n` + lines.join("\n")
      });
    }

    // ---------- Chips ----------
    function renderChips(){
      const box = document.getElementById("chips");
      box.innerHTML = "";
      T[LANG].chips.forEach(item=>{
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = item.label;
        b.onclick = () => handleCommand(item.q);
        box.appendChild(b);
      });
    }

    function handleCommand(cmd){
      if(cmd === "__RAMADAN_TIPS__"){
        addUserMessage(LANG==="ar" ? "Ù†ØµØ§Ø¦Ø­ Ø±Ù…Ø¶Ø§Ù†" : "Ramadan tips");
        addBotMessage({
          title: T[LANG].tipsTitle,
          lines: [T[LANG].tipsText],
          tags: [{text:"Guidance", type:"ok"}],
          disclaimer:false,
          copyText: T[LANG].tipsText
        });
        return;
      }
      if(cmd === "__TOP__"){
        addUserMessage(LANG==="ar" ? "Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©" : "Common");
        const top = getTopDrugs(10);
        if(!top.length){
          addBotMessage({title:T[LANG].topTitle, lines:[T[LANG].topEmpty], tags:[{text:"Empty", type:"warn"}], disclaimer:false});
          return;
        }
        const lines = top.map(([n,c],i)=> `${i+1}. ${n} â€” ${c}`);
        addBotMessage({title:T[LANG].topTitle, lines, tags:[{text:"Local", type:"ok"}], disclaimer:false, copyText: lines.join("\n")});
        return;
      }
      if(cmd.startsWith("__CAT__:")){
        const cat = cmd.split(":")[1] || "";
        addUserMessage((LANG==="ar") ? `ØªØµÙ†ÙŠÙ: ${cat}` : `Category: ${cat}`);
        listByCategory(cat);
        return;
      }

      // fallback: treat as text query
      handleMessage(cmd);
    }

    // ---------- Message Handling ----------
    function handleMessage(text){
      const q = (text||"").trim();
      if(!q) return;

      addUserMessage(q);

      const d = findDrug(q);
      if(d){
        const rep = buildDrugReply(d);
        addBotMessage({
          title: rep.title,
          lines: rep.lines.length ? rep.lines : [(LANG==="ar" ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©." : "No extra notes.")],
          tags: rep.tags,
          disclaimer:true,
          copyText: rep.copyText
        });
        const key = ((d.name||"") + (d.strength ? " " + d.strength : "")).trim();
        trackDrugUse(key);
        return;
      }

      addBotMessage({
        title: "â„¹ï¸",
        lines: [T[LANG].notFound],
        tags: [{text:"Not found", type:"warn"}],
        disclaimer:false
      });
    }

    // ---------- Top 10 Modal ----------
    function renderTopModal(){
      const list = document.getElementById("topList");
      const top = getTopDrugs(10);
      if(!top.length){
        list.innerHTML = `<div style="color:rgba(183,210,221,.9); font-size:13px;">${escapeHtml(T[LANG].topEmpty)}</div>`;
        return;
      }
      list.innerHTML = top.map(([name,count],i)=>`
        <div class="row">
          <div>${i+1}. ${escapeHtml(name)}</div>
          <div style="color:rgba(183,210,221,.9)">${count}</div>
        </div>
      `).join("");
    }

    // ---------- Install prompt ----------
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "inline-flex";
    });

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", ()=>{
      applyLang();
      loadDrugsJson();
      updateKpis();

      // welcome once
      clearChat();

      // events
      document.getElementById("sendBtn").onclick = ()=>{
        const input = document.getElementById("userInput");
        const v = input.value.trim();
        if(!v) return;
        input.value = "";
        updateHints("");
        handleMessage(v);
      };

      document.getElementById("userInput").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          document.getElementById("sendBtn").click();
        }
      });
      document.getElementById("userInput").addEventListener("input", (e)=> updateHints(e.target.value));

      document.getElementById("langBtn").onclick = ()=>{
        LANG = (LANG === "ar") ? "en" : "ar";
        applyLang();
        loadDrugsJson();
        clearChat();
      };

      document.getElementById("clearBtn").onclick = ()=> clearChat();

      const topModal = document.getElementById("topModal");
      document.getElementById("topBtn").onclick = ()=>{
        renderTopModal();
        topModal.style.display = "block";
      };
      document.getElementById("topClose").onclick = ()=> topModal.style.display = "none";
      topModal.onclick = (e)=>{ if(e.target.id==="topModal") topModal.style.display="none"; };

      document.getElementById("installBtn").onclick = async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById("installBtn").style.display = "none";
      };

      // register SW (your repo filename)
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    });
  </script>
</body>
</html>
