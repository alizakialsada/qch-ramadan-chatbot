<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2f7fa3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --brand:#2f7fa3;
  --brand2:#67b3cf;
  --text:#0c2a36;

  --bgTop:#ffffff;
  --bg1:#eef8fd;
  --bg2:#dfeff8;

  --card:#f6fbff;
  --cardBorder:#bfe0f0;

  --shadow:0 18px 40px rgba(10, 42, 54, .08);

  /* Ù…Ø­Ø§Ø°Ø§Ø© Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø´Ø¹Ø§Ø±Ø§Øª (ØªØ¹ÙˆÙŠØ¶ Ø§Ù„ÙØ±Ø§Øº Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ) */
  --logoBox:110px;
  --logoScaleQCH:1.00;
  --logoScaleHH:1.12;
  --logoYQCH:0px;
  --logoYHH:0px;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: Tahoma, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  color:var(--text);
  background:
    linear-gradient(180deg, var(--bgTop) 0%, var(--bg1) 35%, var(--bg2) 100%);
}

/* ===== Header (white, minimal, like screenshot) ===== */
.header{
  background:#fff;
  padding:26px 28px 22px;
  border-bottom:1px solid rgba(47,127,163,.15);
}

.header-inner{
  max-width:1280px;
  margin:0 auto;
  position:relative;
  display:flex;
  align-items:flex-start;
  justify-content:center;
}

/* corner logos */
.logoCorner{
  position:absolute;
  top:2px;
  width:var(--logoBox);
  height:var(--logoBox);
  display:flex;
  align-items:center;
  justify-content:center;
}
.logoCorner.left{left:0;}
.logoCorner.right{right:0;}

.logoCorner img{
  max-width:100%;
  max-height:100%;
  width:auto;
  height:auto;
  object-fit:contain;
  display:block;
  transform-origin:center center;
}
.logoCorner.right img{
  transform: translateY(var(--logoYQCH)) scale(var(--logoScaleQCH));
}
.logoCorner.left img{
  transform: translateY(var(--logoYHH)) scale(var(--logoScaleHH));
}

/* centered title */
.title{
  text-align:center;
  padding: 6px 140px 0; /* leave room for logos on wide screens */
}
.title h1{
  margin:0;
  color:var(--brand);
  font-size:64px;
  letter-spacing:.2px;
  font-weight:800;
}
.title p{
  margin:10px 0 0;
  color:var(--brand2);
  font-size:34px;
  font-weight:700;
}

/* ===== Main area ===== */
.main{
  max-width:1400px;
  margin:0 auto;
  padding: 34px 22px 60px;
}

/* subtle big panel background behind card (like screenshot) */
.panel{
  background:rgba(255,255,255,.35);
  border:1px solid rgba(47,127,163,.12);
  border-radius:26px;
  padding: 34px;
  box-shadow: 0 10px 24px rgba(10,42,54,.05);
}

/* chat card */
.card{
  background:var(--card);
  border:2px solid var(--cardBorder);
  border-radius:24px;
  box-shadow: var(--shadow);
  padding: 34px 34px 26px;
  min-height: 520px;
}

.welcome{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  font-size:34px;
  font-weight:800;
  color:#0b2b38;
  margin: 4px 0 22px;
}
.welcome .hand{font-size:28px;}

.prompt{
  font-size:30px;
  line-height:1.7;
  color:#123a4a;
  font-weight:650;
  margin:0 0 24px;
}

/* input row */
.inputRow{
  margin-top: 26px;
  display:flex;
  gap:14px;
  align-items:center;
}
.inputRow input{
  flex:1;
  height:60px;
  border-radius:14px;
  border:1px solid rgba(47,127,163,.25);
  padding: 0 18px;
  font-size:20px;
  outline:none;
  background:#fff;
}
.inputRow button{
  height:60px;
  padding:0 24px;
  border-radius:14px;
  border:0;
  background:var(--brand2);
  color:#053041;
  font-size:18px;
  font-weight:800;
  cursor:pointer;
}
.inputRow button:hover{filter:brightness(.97);}

#chatBox{
  min-height: 320px;
}

/* responsive */
@media (max-width: 980px){
  :root{ --logoBox:90px; }
  .title{ padding: 4px 110px 0; }
  .title h1{ font-size:44px; }
  .title p{ font-size:24px; }
  .card{ min-height: 460px; }
  .welcome{ font-size:28px; }
  .prompt{ font-size:22px; }
}
@media (max-width: 640px){
  :root{ --logoBox:74px; }
  .header{ padding:18px 16px 16px; }
  .title{ padding: 0 86px; }
  .title h1{ font-size:34px; }
  .title p{ font-size:20px; }
  .panel{ padding:18px; }
  .card{ padding:18px; }
  .inputRow{ flex-direction:column; }
  .inputRow input, .inputRow button{ width:100%; }
}

/* ===== Premium micro-animations ===== */
.title h1, .title p{
  opacity:0;
  transform: translateY(18px);
  animation: fadeRise 1.1s cubic-bezier(.2,.8,.2,1) forwards;
  will-change: transform, opacity;
}
.title p{ animation-delay:.35s; }
@keyframes fadeRise{ to{ opacity:1; transform: translateY(0);} }

/* subtle header shine */
.header::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(90deg, transparent, rgba(103,179,207,.08), transparent);
  transform: translateX(-100%);
  animation: shine 3.6s ease-in-out 1.2s forwards;
  pointer-events:none;
}
.header{ position:relative; overflow:hidden; }
@keyframes shine{ 40%{transform:translateX(100%);} 100%{transform:translateX(100%);} }

/* ===== Ramadan crescent (very subtle) ===== */
body::before{
  content:"";
  position:fixed;
  top:12%;
  left:6%;
  width:340px;
  height:340px;
  background:
    radial-gradient(circle at 42% 42%, #ffffff 60%, transparent 61%),
    radial-gradient(circle at 56% 46%, rgba(103,179,207,.9) 60%, transparent 61%);
  opacity:.055;
  filter: blur(.2px);
  pointer-events:none;
  z-index:0;
}
body::after{
  content:"";
  position:fixed;
  bottom:8%;
  right:7%;
  width:260px;
  height:260px;
  background:
    radial-gradient(circle at 42% 42%, #ffffff 60%, transparent 61%),
    radial-gradient(circle at 56% 46%, rgba(47,127,163,.95) 60%, transparent 61%);
  opacity:.04;
  filter: blur(.3px);
  pointer-events:none;
  z-index:0;
}

/* keep content above background */
.header, .main{ position:relative; z-index:1; }

/* ===== Chat UI upgrades ===== */
.chat{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin: 6px 0 18px;
}
.bubble{
  max-width:min(760px, 92%);
  padding:14px 16px;
  border-radius:16px;
  line-height:1.75;
  font-size:18px;
  box-shadow: 0 10px 22px rgba(10,42,54,.06);
  border:1px solid rgba(47,127,163,.14);
  background:#fff;
}
.bubble.user{
  align-self:flex-start;
  background: linear-gradient(180deg, rgba(103,179,207,.18), rgba(103,179,207,.10));
}
.bubble.bot{
  align-self:flex-end;
  background: linear-gradient(180deg, rgba(47,127,163,.12), rgba(47,127,163,.06));
}
.bubble small{ display:block; opacity:.75; margin-top:8px; }

.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  margin: 6px 0 18px;
}
.pills{
  display:flex; flex-wrap:wrap; gap:10px;
}
.pill{
  border:1px solid rgba(47,127,163,.20);
  background:#fff;
  border-radius:999px;
  padding:10px 14px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  transition: transform .06s ease, filter .2s ease;
}
.pill:hover{ filter:brightness(.98); }
.pill:active{ transform:scale(.98); }

.langToggle{
  display:flex;
  border:1px solid rgba(47,127,163,.22);
  border-radius:999px;
  overflow:hidden;
  background:#fff;
}
.langToggle button{
  border:0;
  background:transparent;
  padding:10px 14px;
  font-size:14px;
  font-weight:800;
  cursor:pointer;
  color:var(--text);
}
.langToggle button.active{
  background: rgba(103,179,207,.22);
}

.hint{
  margin: 0 0 8px;
  color:#1a4a5f;
  opacity:.85;
  font-size:16px;
  font-weight:650;
}

/* input row polish */
.inputRow input{
  box-shadow: 0 8px 18px rgba(10,42,54,.05);
}
.inputRow button{
  box-shadow: 0 10px 22px rgba(10,42,54,.08);
}

/* better mobile */
@media (max-width: 640px){
  .card{ min-height:auto; }
  #chatBox{ min-height: 180px; }
  .bubble{ font-size:16px; }
  .title{ padding: 0 84px; }
  .title h1{ font-size:32px; }
  .title p{ font-size:18px; }
  .welcome{ font-size:22px; }
  .prompt{ font-size:18px; }
  .pill{ font-size:14px; padding:9px 12px; }
}


/* ===== Footer ===== */
.footer{
  margin-top: 22px;
  padding: 18px 18px 28px;
}
.footer-inner{
  max-width:1400px;
  margin:0 auto;
  display:flex;
  gap:16px;
  align-items:flex-end;
  justify-content:space-between;
  background: rgba(255,255,255,.55);
  border:1px solid rgba(47,127,163,.14);
  border-radius:18px;
  padding: 14px 16px;
}
.footer-line{
  color:#0c2a36;
  font-size:14px;
  line-height:1.5;
  opacity:.92;
}
#usageStats{
  text-align:left;
  font-size:12px;
  color:#1a4a5f;
  opacity:.9;
}
#usageStats b{ font-size:12px; }
@media (max-width:640px){
  .footer-inner{ flex-direction:column; align-items:flex-start; }
  #usageStats{ text-align:right; width:100%; }
}


/* ===== Welcome Modal ===== */
.modal{ position:fixed; inset:0; z-index:50; display:grid; place-items:center; }
.modal[hidden]{ display:none; }
.modal-backdrop{ position:absolute; inset:0; background: rgba(11,31,38,.35); backdrop-filter: blur(6px); }
.modal-card{
  position:relative;
  width:min(720px, 92vw);
  background:#fff;
  border:1px solid rgba(47,127,163,.18);
  border-radius:22px;
  box-shadow: 0 22px 60px rgba(10,42,54,.22);
  padding: 18px 18px 16px;
  animation: popIn .22s ease-out forwards;
}
@keyframes popIn{ from{ transform: translateY(8px) scale(.98); opacity:.6;} to{ transform:none; opacity:1;} }
.modal-badge{
  display:inline-block;
  background: rgba(103,179,207,.18);
  border:1px solid rgba(47,127,163,.16);
  color:#0c2a36;
  font-weight:800;
  border-radius:999px;
  padding: 6px 10px;
  font-size:13px;
  margin-bottom:10px;
}
.modal-header h2{ margin:0; color: var(--brand); font-size:26px; }
.modal-sub{ margin:8px 0 0; color:#1a4a5f; opacity:.9; line-height:1.7; }
.modal-actions{ display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap; margin-top:14px; }

</style>
</head>

<body>

  <!-- ===== Welcome (first visit) ===== -->
  <div class="modal" id="welcomeModal" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle" hidden>
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="modal-badge">ğŸŒ™ Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</div>
          <h2 id="welcomeTitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</h2>
          <p class="modal-sub">Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø±Ù…Ø¶Ø§Ù† (Ø¹Ø±Ø¨ÙŠ/English). Ù„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ù‹Ø§ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„ØµÙŠØ¯Ù„ÙŠ.</p>
        </div>
      </div>
      <div class="modal-actions">
        <button class="pill" type="button" id="welcomeStart">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        <button class="pill" type="button" id="welcomeDontShow">Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
      </div>
    </div>
  </div>

  <header class="header">
    <div class="header-inner">
      <div class="logoCorner left" aria-label="Health Holding Co">
        <img src="logo_health_holding.png" alt="Health Holding Co" />
      </div>

      <div class="title">
        <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</p>
      </div>

      <div class="logoCorner right" aria-label="Qatif Central Hospital">
        <img src="logo_qch.png" alt="Qatif Central Hospital" />
      </div>
    </div>
  </header>

  <main class="main">
    <section class="panel">
      <section class="card">
        <div id="chatBox">
          <div class="welcome"><span>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ</span><span class="hand">ğŸ‘‹</span></div>
          <p class="prompt">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù„Ù…Ø¹Ø±ÙØ© Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø±Ù…Ø¶Ø§Ù†.</p>
        </div>

        <div class="inputRow">
          <button type="button" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
          <input id="userInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§..." autocomplete="off" />
        </div>
      </section>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-left">
        <div class="footer-line"><b>Pharmacy Department â€“ QCH</b></div>
        <div class="footer-line">Created by Automation Supervisor <b>Ali Alsada</b></div>
      </div>
      <div class="footer-right" id="usageStats" aria-label="usage stats"></div>
    </div>
  </footer>


<script>
function esc(s){
  return (s||"").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}
function sendMessage(){
  const input = document.getElementById("userInput");
  const chat = document.getElementById("chatBox");
  const v = (input.value||"").trim();
  if(!v) return;

  chat.insertAdjacentHTML("beforeend",
    `<div style="margin-top:18px;font-size:18px;color:#0b2b38;"><b>Ø£Ù†Øª:</b> ${esc(v)}</div>` +
    `<div style="margin-top:8px;font-size:18px;color:#123a4a;"><b>Ø§Ù„Ù†Ø¸Ø§Ù…:</b> ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡. (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹)</div>`
  );
  input.value = "";
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
}
document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter") sendMessage();
});
</script>

<script>
(async () => {
  // ===== Simple local analytics (privacy-friendly) =====
  const analyticsKey = "qch_ramadan_analytics_v1";
  const getAnalytics = () => { try { return JSON.parse(localStorage.getItem(analyticsKey) || '{"visits":0,"messages":0,"top":{}}'); } catch(e){ return {visits:0,messages:0,top:{}}; } };
  const setAnalytics = (a) => { try { localStorage.setItem(analyticsKey, JSON.stringify(a)); } catch(e){} };

  // ===== Language =====
  const LANG = { AR:"ar", EN:"en" };
  let lang = LANG.AR;

  const el = {
    input: document.querySelector(".inputRow input"),
    send: document.querySelector(".inputRow button"),
    chat: document.getElementById("chatBox"),
    hint: document.getElementById("hintLine"),
    btnTop: document.getElementById("btnTop"),
    btnExamples: document.getElementById("btnExamples"),
    btnClear: document.getElementById("btnClear"),
    langAR: document.getElementById("langAR"),
    langEN: document.getElementById("langEN"),
  };

  // count visit
  const __a0 = getAnalytics();
  __a0.visits = (__a0.visits||0) + 1;
  setAnalytics(__a0);

  // ===== Real-ish medication knowledge base (offline) =====
  // Note: This is general education, not individualized medical advice.
  
  // ===== Medication knowledge base (loaded from drugs.json) =====
  // Note: General education only, not individualized medical advice.
  let DB = [];
  async function loadDB(){
    try{
      const res = await fetch("drugs.json", {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      DB = Array.isArray(data.drugs) ? data.drugs : [];
    }catch(e){
      // Fallback minimal list if JSON not found
      DB = [
        {key:"metformin", ar:"Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†", en:"Metformin", tags:["metformin","Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†","glucophage","Ø¬Ù„ÙˆÙƒÙˆÙØ§Ø¬"], class:"Diabetes (T2DM)", highRisk:false,
          advice:{ar:"ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ¤Ø®Ø° Ù…Ø¹/Ø¨Ø¹Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø©. ÙÙŠ Ø±Ù…Ø¶Ø§Ù†: Ù…Ø±Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±ØŒ Ø£Ùˆ Ù…Ø±ØªÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø± ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø³Ø­ÙˆØ±. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¹Ù†Ø¯ Ù‡Ø¨ÙˆØ· Ø³ÙƒØ±.", en:"Usually with/after meals. In Ramadan: once after Iftar, or twice after Iftar and Suhoor. Consult your clinician if hypoglycemia occurs."}},
        {key:"warfarin", ar:"ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†", en:"Warfarin", tags:["warfarin","ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†","coumadin","ÙƒÙˆÙ…Ø§Ø¯ÙŠÙ†"], class:"Anticoagulant", highRisk:true,
          advice:{ar:"Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±ØŒ ÙˆÙˆØ§ØµÙ„ Ù…ØªØ§Ø¨Ø¹Ø© INR. Ù„Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¯ÙˆÙ† Ø·Ø¨ÙŠØ¨.", en:"Keep a consistent time after Iftar and monitor INR. Do not stop without medical advice."}},
        {key:"omeprazole", ar:"Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„", en:"Omeprazole", tags:["omeprazole","Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„","losec","Ù„ÙˆØ³ÙŠÙƒ"], class:"PPI/GERD", highRisk:false,
          advice:{ar:"Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø± Ø¨Ù€ 30â€“60 Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© ÙØ§Ø±ØºØ©.", en:"30â€“60 minutes before Iftar on an empty stomach."}},
      ];
    }
  }


  const TOP = [
    "Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†","Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†","ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†","Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„","Ø¨Ø§Ù†ØªÙˆØ¨Ø±Ø§Ø²ÙˆÙ„","Ø£Ù…Ù„ÙˆØ¯ÙŠØ¨ÙŠÙ†",
    "Ù„ÙˆØ³Ø§Ø±ØªØ§Ù†","Ù„ÙŠØ²ÙŠÙ†ÙˆØ¨Ø±ÙŠÙ„","Ø¨Ø§Ø±Ø§Ø³ÙŠØªØ§Ù…ÙˆÙ„","Ø¥ÙŠØ¨ÙˆØ¨Ø±ÙˆÙÙŠÙ†","Ù„ÙŠÙÙˆØ«ÙŠØ±ÙˆÙƒØ³ÙŠÙ†","Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ†"
  ];

  // ===== Helpers =====
  const norm = (s) => (s||"")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g," ")
    .replace(/[Ø£Ø¥Ø¢]/g,"Ø§")
    .replace(/Ø©/g,"Ù‡")
    .replace(/Ù‰/g,"ÙŠ");

  function setLang(next){
    lang = next;
    el.langAR.classList.toggle("active", lang===LANG.AR);
    el.langEN.classList.toggle("active", lang===LANG.EN);
    el.langAR.setAttribute("aria-selected", lang===LANG.AR ? "true":"false");
    el.langEN.setAttribute("aria-selected", lang===LANG.EN ? "true":"false");
    el.hint.textContent = lang===LANG.AR
      ? "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ (Ù…Ø«Ø§Ù„: ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†ØŒ Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†ØŒ Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„) Ø«Ù… Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„."
      : "Type a medication name (e.g., warfarin, metformin, omeprazole) then press Send.";
    el.input.placeholder = lang===LANG.AR ? "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù‡Ù†Ø§..." : "Type the medication name...";
    el.send.textContent = lang===LANG.AR ? "Ø¥Ø±Ø³Ø§Ù„" : "Send";
  }

  function bubble(text, who="bot", footer=""){
    const div = document.createElement("div");
    div.className = `bubble ${who}`;
    div.innerHTML = text + (footer ? `<small>${footer}</small>`:"");
    el.chat.appendChild(div);
    el.chat.scrollTop = el.chat.scrollHeight;
  }

  function findDrug(q){
    const nq = norm(q);
    if(!nq) return [];
    return DB.filter(d => d.tags.some(t => nq.includes(norm(t))));
  }

  function replyFor(drug){
    const disclaimerAR = "ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªØ«Ù‚ÙŠÙ ÙˆÙ„ÙŠØ³Øª Ø¨Ø¯ÙŠÙ„Ù‹Ø§ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„ØµÙŠØ¯Ù„ÙŠ. Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙƒ Ø³ÙƒØ±ÙŠ Ø¹Ù„Ù‰ Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†ØŒ Ø£Ùˆ Ø£Ø¯ÙˆÙŠØ© Ø³ÙŠÙˆÙ„Ø©ØŒ Ø£Ùˆ Ù…Ø±Ø¶ ÙƒÙ„Ù‰/Ù‚Ù„Ø¨â€”Ø§Ø³ØªØ´Ø± Ø·Ø¨ÙŠØ¨Ùƒ Ù‚Ø¨Ù„ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„.";
    const disclaimerEN = "Note: General education onlyâ€”not a substitute for your clinician/pharmacist. If you use insulin, anticoagulants, or have kidney/heart disease, consult your care team before any changes.";
    const title = lang===LANG.AR ? drug.ar : drug.en;
    const cls = lang===LANG.AR ? "Ø§Ù„ØªØµÙ†ÙŠÙ" : "Class";
    const risk = drug.highRisk ? (lang===LANG.AR ? "âš ï¸ ÙŠØ­ØªØ§Ø¬ Ø­Ø°Ø±/Ø®Ø·Ø© ÙØ±Ø¯ÙŠØ©" : "âš ï¸ Higher-risk / individualized plan") : "";
    const advice = lang===LANG.AR ? drug.advice.ar : drug.advice.en;
    const disc = lang===LANG.AR ? disclaimerAR : disclaimerEN;

    const html = `<b>${title}</b><br><span style="opacity:.85">${cls}: ${drug.class}${risk ? " â€¢ "+risk : ""}</span><br><br>${advice}`;
    return { html, disc };
  }

  function clearChat(){
    el.chat.innerHTML = "";
    welcome();
  }

  function welcome(){
    const w = lang===LANG.AR
      ? "Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ. Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø±Ø¹Ø© ÙÙŠ Ø±Ù…Ø¶Ø§Ù†."
      : "Hi ğŸ‘‹ Iâ€™m the Ramadan Smart Assistant. Type a medication name and Iâ€™ll provide general Ramadan timing guidance.";
    bubble(w, "bot");
  }

  function handleSend(text){
    const raw = (text ?? el.input.value).trim();
    if(!raw) return;
    bubble(lang===LANG.AR ? `<b>Ø£Ù†Øª:</b> ${raw}` : `<b>You:</b> ${raw}`, "user");
    const a = getAnalytics();
    a.messages = (a.messages||0) + 1;
    setAnalytics(a);
    updateStats();
    el.input.value = "";

    const hits = findDrug(raw);
    if(hits.length){
      const a2 = getAnalytics();
      const nameKey = (lang===LANG.AR ? (hits[0].ar||hits[0].en) : (hits[0].en||hits[0].ar));
      a2.top = a2.top || {};
      a2.top[nameKey] = (a2.top[nameKey]||0) + 1;
      setAnalytics(a2);
      updateStats();
      // If multiple matches, show first 2
      hits.slice(0,2).forEach(d => {
        const r = replyFor(d);
        bubble(r.html, "bot", r.disc);
      });
    }else{
      const msg = lang===LANG.AR
        ? "Ù„Ù… Ø£ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ§Ø¡. Ø¬Ø±Ù‘Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ/Ø§Ù„ØªØ¬Ø§Ø±ÙŠØŒ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù…."
        : "I couldnâ€™t match that medication. Try the generic/brand name, or part of the name.";
      bubble(msg, "bot");
    }
  }

  // ===== Events =====
  if(el.send){ el.send.addEventListener("click", () => handleSend()); }

  if(el.input){
    el.input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        handleSend();
      }
    });
  }

  if(el.langAR){
    el.langAR.addEventListener("click", () => {
      setLang(LANG.AR);
      clearChat();
      updateStats();
    });
  }

  if(el.langEN){
    el.langEN.addEventListener("click", () => {
      setLang(LANG.EN);
      clearChat();
      updateStats();
    });
  }

  if(el.btnClear){ el.btnClear.addEventListener("click", () => { clearChat(); updateStats(); }); }

  if(el.btnExamples){
    el.btnExamples.addEventListener("click", () => {
      const examples = (lang===LANG.AR)
        ? ["ÙˆØ§Ø±ÙØ§Ø±ÙŠÙ†","Ù…ÙŠØªÙÙˆØ±Ù…ÙŠÙ†","Ø£ÙˆÙ…ÙŠØ¨Ø±Ø§Ø²ÙˆÙ„","Ù„ÙŠÙÙˆØ«ÙŠØ±ÙˆÙƒØ³ÙŠÙ†","Ø£Ù…Ù„ÙˆØ¯ÙŠØ¨ÙŠÙ†"]
        : ["warfarin","metformin","omeprazole","levothyroxine","amlodipine"];
      bubble((lang===LANG.AR ? "Ø£Ù…Ø«Ù„Ø©: " : "Examples: ") + examples.join(" â€¢ "), "bot");
    });
  }

  if(el.btnTop){
    el.btnTop.addEventListener("click", () => {
      bubble(
        (lang===LANG.AR ? "â­ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§ (Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…):" : "â­ Top common meds (type the name):")
        + "<br><br>"
        + TOP.map(n => `â€¢ ${n}`).join("<br>"),
        "bot"
      );
    });
  }


  // ===== Init =====
  setLang(LANG.AR);
  await loadDB();
  clearChat();
  updateStats();
})();
</script>

</body>
</html>
