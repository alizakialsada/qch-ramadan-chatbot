
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QCH ‚Äì Smart Ramadan Medication Assistant (v7 fixed)</title>
  <meta name="description" content="Qatif Central Hospital ‚Äì Ramadan Medication Assistant (Arabic/English)." />
  <style>
    :root{
      --bg:#0b1f26; --text:#eaf6fb; --muted:#b7d2dd;
      --accent:#35d0c7; --accent2:#2aa6ff;
      --danger:#ff4d4f; --warn:#f5a524; --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
    }
    body{margin:0;background:radial-gradient(1200px 700px at 20% 10%, #15404d 0%, var(--bg) 55%);color:var(--text);}
    .wrap{max-width:1220px;margin:24px auto;padding:16px}
    .top{background:linear-gradient(135deg,#123747,#0d2a34);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:var(--shadow);
      padding:18px;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,var(--accent2),var(--accent));
      display:grid;place-items:center;font-weight:900;box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .title h1{margin:0;font-size:18px}
    .title p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select, button, input{
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);
      padding:10px 12px;border-radius:14px;outline:none;font-size:13px
    }
    button{cursor:pointer;background:rgba(53,208,199,.14);border-color:rgba(53,208,199,.35)}
    .grid{margin-top:16px;display:grid;grid-template-columns:1.45fr .75fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);border-radius:18px;box-shadow:var(--shadow);overflow:hidden;min-height:560px}
    .card header{padding:14px 16px;background:rgba(0,0,0,.15);border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px}
    .pillrow{display:flex;flex-wrap:wrap;gap:8px;padding:14px 16px 10px}
    .pill{font-size:12px;color:var(--text);padding:8px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      border-radius:999px;cursor:pointer;user-select:none}
    .pill:hover{border-color:rgba(53,208,199,.45)}
    /* IMPORTANT FIX: composer is fixed so it is ALWAYS clickable */
    .chatWrap{position:relative;height:560px}
    .chatlog{position:absolute;left:0;right:0;top:0;bottom:74px;padding:16px;overflow:auto;-webkit-overflow-scrolling:touch}
    .composer{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:9999;
      display:flex;gap:10px;padding:12px;background:rgba(8,18,22,.78);
      border:1px solid rgba(255,255,255,.10);border-radius:16px;backdrop-filter: blur(10px)
    }
    .composer input{flex:1;font-size:14px}
    .msg{display:flex;margin:10px 0}
    .msg .bubble{max-width:88%;padding:12px;border-radius:16px;line-height:1.35;font-size:14px;border:1px solid rgba(255,255,255,.10);white-space:pre-wrap}
    .me{justify-content:flex-end}
    .me .bubble{background:rgba(53,208,199,.16);border-color:rgba(53,208,199,.35)}
    .bot .bubble{background:rgba(255,255,255,.06)}
    .chips{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.12)}
    .chip.ok{border-color:rgba(34,197,94,.45)}
    .chip.warn{border-color:rgba(245,165,36,.45)}
    .chip.danger{border-color:rgba(255,77,79,.45)}
    .side .content{padding:16px;color:var(--muted);font-size:13px;line-height:1.5}
    .alert{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05)}
    .alert.warn{border-color:rgba(245,165,36,.45)}
    .alert.ok{border-color:rgba(34,197,94,.45)}
    .foot{margin-top:14px;font-size:12px;color:rgba(234,246,251,.75)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">QCH</div>
        <div class="title">
          <h1>QCH ‚Äì Smart Ramadan Medication Assistant</h1>
          <p>Hospital-grade rules: medication + class + frequency ‚Ä¢ Arabic / English</p>
        </div>
      </div>
      <div class="controls">
        <select id="lang">
          <option value="bi" selected>Arabic + English</option>
          <option value="ar">Arabic</option>
          <option value="en">English</option>
        </select>
        <select id="mode">
          <option value="patient" selected>Patient</option>
          <option value="hcp">Healthcare Staff</option>
        </select>
        <button id="reset" type="button">Reset</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <header>
          <div style="font-weight:800">Chat</div>
          <div class="badge">Ramadan ‚Ä¢ v7 (Typing Fix)</div>
        </header>

        <div class="pillrow" id="quick"></div>

        <div class="chatWrap">
          <div class="chatlog" id="chat"></div>
          <div class="composer">
            <input id="input" type="text" inputmode="text" autocapitalize="off" autocorrect="off"
                   placeholder="Type medication name‚Ä¶ / ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ°‚Ä¶" autocomplete="off" />
            <button id="send" type="button">Send</button>
          </div>
        </div>
      </section>

      <aside class="card side">
        <header>
          <div style="font-weight:800">Safety & How to use</div>
          <div class="badge">No PHI stored</div>
        </header>
        <div class="content">
          <div class="alert warn">
            <b>Important:</b> General guidance only. For <b>insulin</b>, <b>warfarin</b>, <b>pregnancy</b>, <b>CKD/CLD</b>,
            transplant, chemotherapy, seizure meds, or complex regimens ‚Üí consult your clinician/pharmacist.
          </div>
          <div class="alert ok" id="welcomeBox"></div>

          <div class="alert">
            <b>Perfect Ramadan method:</b><br/>
            1) Type the medication name. If not found ‚Üí type a <b>class</b> (e.g., <span class="mono">antibiotic</span>, <span class="mono">PPI</span>, <span class="mono">blood pressure</span>).<br/>
            2) If still unknown, the assistant will ask: <b>How many times per day?</b> (OD/BID/TID/QID).<br/>
            3) Follow the timing and the warning labels (‚õî/‚ö†Ô∏è/‚úÖ).
          </div>

          <div class="foot">
            Created by <b>Ali Alsada</b><br/>
            Pharmacy Department ‚Ä¢ Qatif Central Hospital
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  const ui = {
    lang: document.getElementById('lang'),
    mode: document.getElementById('mode'),
    reset: document.getElementById('reset'),
    chat: document.getElementById('chat'),
    input: document.getElementById('input'),
    send: document.getElementById('send'),
    quick: document.getElementById('quick'),
    welcomeBox: document.getElementById('welcomeBox'),
  };

  function t(ar,en){
    const L = ui.lang.value;
    if(L==="ar") return ar;
    if(L==="en") return en;
    return ar + "\n\n" + en;
  }
  function pushMsg(text, who="bot", chips=[]){
    const row = document.createElement("div");
    row.className = "msg " + (who==="me" ? "me":"bot");
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    if(chips && chips.length){
      const c = document.createElement("div");
      c.className = "chips";
      chips.forEach(ch=>{
        const s = document.createElement("span");
        s.className = "chip " + (ch.level||"");
        s.textContent = t(ch.ar, ch.en);
        c.appendChild(s);
      });
      bubble.appendChild(c);
    }
    row.appendChild(bubble);
    ui.chat.appendChild(row);
    ui.chat.scrollTop = ui.chat.scrollHeight;
  }
  function normalize(s){
    return (s||"").toLowerCase().replace(/\s+/g," ").trim();
  }
  function chips(list){ return (list||[]).map(x=>({level:x.l, ar:x.ar, en:x.en})); }

  function freqGuidance(freq){
    if(freq==="od"){
      return {
        en: "‚úÖ Once daily (OD): take after Iftar.\n‚Ä¢ If empty-stomach medicine: take 30‚Äì60 min before Suhoor (water only).\n‚Ä¢ Keep the same time every day.",
        ar: "‚úÖ ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß (OD): ÿÆÿ∞Ÿáÿß ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±.\n‚Ä¢ ÿ•ÿ∞ÿß ÿØŸàÿßÿ° ÿπŸÑŸâ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ©: ÿÆÿ∞Ÿá ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ± 30‚Äì60 ÿØŸÇŸäŸÇÿ© (ŸÖÿßÿ° ŸÅŸÇÿ∑).\n‚Ä¢ ÿ´ÿ®Ÿëÿ™ ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™ ŸäŸàŸÖŸäŸãÿß.",
        chips: chips([{l:"ok",ar:"ÿ´ÿ®Ÿëÿ™ ÿßŸÑŸàŸÇÿ™ ŸäŸàŸÖŸäŸãÿß",en:"Keep timing consistent"}])
      };
    }
    if(freq==="bid"){
      return {
        en: "‚úÖ Twice daily (BID): 1st dose after Iftar + 2nd dose after Suhoor (as close to 12 hours apart as possible).",
        ar: "‚úÖ ŸÖÿ±ÿ™ŸäŸÜ ŸäŸàŸÖŸäŸãÿß (BID): ÿßŸÑÿ¨ÿ±ÿπÿ© ÿßŸÑÿ£ŸàŸÑŸâ ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± + ÿßŸÑÿ´ÿßŸÜŸäÿ© ÿ®ÿπÿØ ÿßŸÑÿ≥ÿ≠Ÿàÿ± (ŸÇÿ±Ÿäÿ® ŸÖŸÜ 12 ÿ≥ÿßÿπÿ© ŸÇÿØÿ± ÿßŸÑÿ•ŸÖŸÉÿßŸÜ).",
        chips: chips([{l:"ok",ar:"ÿ•ŸÅÿ∑ÿßÿ± + ÿ≥ÿ≠Ÿàÿ±",en:"Iftar + Suhoor"}])
      };
    }
    if(freq==="tid"){
      return {
        en: "‚ö† Three times daily (TID): usually not ideal in Ramadan.\n‚úÖ Ask clinician to switch to BID or XR.\n‚õî Do NOT self-adjust.",
        ar: "‚ö† ÿ´ŸÑÿßÿ´ ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß (TID): ÿ∫ÿßŸÑÿ®Ÿãÿß ÿ∫Ÿäÿ± ŸÖŸÜÿßÿ≥ÿ® ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ.\n‚úÖ ÿßÿ≥ÿ™ÿ¥ÿ± ÿßŸÑÿ∑ÿ®Ÿäÿ® ŸÑÿ™ÿ≠ŸàŸäŸÑŸá ÿ•ŸÑŸâ ŸÖÿ±ÿ™ŸäŸÜ ÿ£Ÿà XR.\n‚õî ŸÑÿß ÿ™ÿπÿØŸëŸÑ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ ÿ®ŸÜŸÅÿ≥ŸÉ.",
        chips: chips([{l:"warn",ar:"ŸäŸÅÿ∂ŸÑ ÿ™ÿ≠ŸàŸäŸÑŸá",en:"Prefer switch to BID/XR"},{l:"danger",ar:"ŸÑÿß ÿ™ÿπÿØŸÑ ÿ®ŸÜŸÅÿ≥ŸÉ",en:"Do not self-adjust"}])
      };
    }
    return {
      en: "‚õî Four times daily (QID): not compatible with fasting safely for most meds. Consult your clinician.",
      ar: "‚õî ÿ£ÿ±ÿ®ÿπ ŸÖÿ±ÿßÿ™ ŸäŸàŸÖŸäŸãÿß (QID): ÿ∫ÿßŸÑÿ®Ÿãÿß ÿ∫Ÿäÿ± ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÑÿµŸäÿßŸÖ ÿ®ÿ¥ŸÉŸÑ ÿ¢ŸÖŸÜ. ÿßÿ≥ÿ™ÿ¥ÿ± ÿßŸÑÿ∑ÿ®Ÿäÿ®.",
      chips: chips([{l:"danger",ar:"ÿßÿ≥ÿ™ÿ¥ÿßÿ±ÿ© ÿ∂ÿ±Ÿàÿ±Ÿäÿ©",en:"Consultation required"}])
    };
  }

  function entry(keys, catEn, catAr, patEn, patAr, ch=[], hcpObj=null){
    return {keys: keys.map(normalize), cat:{en:catEn, ar:catAr}, patient:{en:patEn, ar:patAr}, chips:ch, hcp:hcpObj};
  }
  function hcp(en, ar){ return {en, ar}; }
  function classRule(keys, catEn, catAr, patEn, patAr, ch=[]){
    return {keys: keys.map(normalize), cat:{en:catEn, ar:catAr}, patient:{en:patEn, ar:patAr}, chips:ch};
  }

  const MEDS = [
    entry(["warfarin","coumadin","Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ","ŸÉŸàŸÖÿßÿØŸäŸÜ"], "Anticoagulant", "ŸÖÿ∂ÿßÿØ ÿ™ÿÆÿ´ÿ±",
      "‚úÖ Take after Iftar at the same time daily.\n‚õî Do not change dose.\nüìå INR monitoring as scheduled.",
      "‚úÖ ÿÆÿ∞Ÿá ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑŸàŸÇÿ™ ŸäŸàŸÖŸäŸãÿß.\n‚õî ŸÑÿß ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑÿ¨ÿ±ÿπÿ©.\nüìå ŸÖÿ™ÿßÿ®ÿπÿ© INR ÿ≠ÿ≥ÿ® ÿßŸÑÿÆÿ∑ÿ©.",
      chips([{l:"danger",ar:"Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ Ÿäÿ≠ÿ™ÿßÿ¨ INR",en:"Warfarin needs INR monitoring"},{l:"warn",ar:"ÿ™ÿØÿßÿÆŸÑÿßÿ™ ŸÖÿπ ŸÖÿ∂ÿßÿØÿßÿ™/NSAIDs",en:"Interactions with antibiotics/NSAIDs"}]),
      hcp("Keep time consistent; monitor INR with diet/drug changes.","ÿ´ÿ®Ÿëÿ™ ŸàŸÇÿ™ ÿßŸÑÿ¨ÿ±ÿπÿ© Ÿàÿ±ÿßŸÇÿ® INR ŸÖÿπ ÿ£Ÿä ÿ™ÿ∫ŸäŸäÿ± ÿ∫ÿ∞ÿßÿ¶Ÿä/ÿØŸàÿßÿ¶Ÿä.")
    ),
    entry(["insulin","ÿßŸÜÿ≥ŸàŸÑŸäŸÜ","lantus","novorapid","humalog","mixtard","glargine","aspart"], "Diabetes", "ÿßŸÑÿ≥ŸÉÿ± ‚Äì ÿ•ŸÜÿ≥ŸàŸÑŸäŸÜ",
      "‚ö† Insulin needs an individualized Ramadan plan.\n‚úÖ Mealtime doses with Iftar & Suhoor; basal often evening.\n‚õî Do not change doses without clinician.\nüìå Hypoglycemia symptoms ‚Üí break fast immediately.",
      "‚ö† ÿßŸÑÿ•ŸÜÿ≥ŸàŸÑŸäŸÜ Ÿäÿ≠ÿ™ÿßÿ¨ ÿÆÿ∑ÿ© ŸÅÿ±ÿØŸäÿ© ŸÑÿ±ŸÖÿ∂ÿßŸÜ.\n‚úÖ ÿ¨ÿ±ÿπÿßÿ™ ÿßŸÑŸàÿ¨ÿ®ÿßÿ™ ŸÖÿπ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸàÿßŸÑÿ≥ÿ≠Ÿàÿ±ÿõ ÿßŸÑŸÇÿßÿπÿØŸä ÿ∫ÿßŸÑÿ®Ÿãÿß ŸÖÿ≥ÿßÿ°.\n‚õî ŸÑÿß ÿ™ÿ∫ŸäŸëÿ± ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ ÿ®ÿØŸàŸÜ ÿßŸÑÿ∑ÿ®Ÿäÿ®.\nüìå ÿ£ÿπÿ±ÿßÿ∂ Ÿáÿ®Ÿàÿ∑ ÿßŸÑÿ≥ŸÉÿ± ‚Üí ÿßŸÅÿ∑ÿ± ŸÅŸàÿ±Ÿãÿß.",
      chips([{l:"danger",ar:"ÿÆÿ∑ÿ± Ÿáÿ®Ÿàÿ∑ ÿ≥ŸÉÿ± ÿ£ÿπŸÑŸâ",en:"Higher hypoglycemia risk"}])
    ),
    entry(["omeprazole","pantoprazole","esomeprazole","ppi","ÿ£ŸàŸÖŸäÿ®ÿ±ÿßÿ≤ŸàŸÑ","ÿ®ÿßŸÜÿ™Ÿàÿ®ÿ±ÿßÿ≤ŸàŸÑ","ÿ•Ÿäÿ≤ŸàŸÖŸäÿ®ÿ±ÿßÿ≤ŸàŸÑ"], "GI (PPI)", "ÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿπÿØÿ© (PPI)",
      "‚úÖ Best 30‚Äì60 min before Iftar. Alternative: before Suhoor. If BID: before Iftar + before Suhoor.",
      "‚úÖ ÿßŸÑÿ£ŸÅÿ∂ŸÑ ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± 30‚Äì60 ÿØŸÇŸäŸÇÿ©. ÿ®ÿØŸäŸÑ: ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ±. ÿ•ÿ∞ÿß ŸÖÿ±ÿ™ŸäŸÜ: ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± + ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ±.",
      chips([{l:"ok",ar:"ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑ",en:"Best before meals"}])
    ),
    entry(["levothyroxine","euthyrox","eltroxin","ŸÑŸäŸÅŸàÿ´Ÿäÿ±ŸàŸÉÿ≥ŸäŸÜ","ÿ´Ÿäÿ±ŸàŸÉÿ≥ŸäŸÜ"], "Endocrine", "ÿßŸÑÿ∫ÿØÿ© ÿßŸÑÿØÿ±ŸÇŸäÿ©",
      "‚úÖ Take 30‚Äì60 min before Suhoor on empty stomach with water. Separate 4h from iron/calcium/antacids.",
      "‚úÖ ÿÆÿ∞Ÿá ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ± 30‚Äì60 ÿØŸÇŸäŸÇÿ© ÿπŸÑŸâ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ© ŸÖÿπ ŸÖÿßÿ°. ÿßŸÅÿµŸÑ 4 ÿ≥ÿßÿπÿßÿ™ ÿπŸÜ ÿßŸÑÿ≠ÿØŸäÿØ/ÿßŸÑŸÉÿßŸÑÿ≥ŸäŸàŸÖ/ŸÖÿ∂ÿßÿØÿßÿ™ ÿßŸÑÿ≠ŸÖŸàÿ∂ÿ©.",
      chips([{l:"ok",ar:"ÿπŸÑŸâ ŸÖÿπÿØÿ© ŸÅÿßÿ±ÿ∫ÿ©",en:"Empty stomach"}])
    ),
    entry(["antibiotic","ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä"], "Antibiotic", "ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä",
      "‚úÖ If BID: after Iftar + after Suhoor. If OD: after Iftar. If TID/QID: ask for XR/BID alternative.",
      "‚úÖ ÿ•ÿ∞ÿß ŸÖÿ±ÿ™ŸäŸÜ: ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± + ÿ®ÿπÿØ ÿßŸÑÿ≥ÿ≠Ÿàÿ±. ÿ•ÿ∞ÿß ŸÖÿ±ÿ©: ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±. ÿ•ÿ∞ÿß 3/4 ŸÖÿ±ÿßÿ™: ÿßÿ∑ŸÑÿ® ÿ®ÿØŸäŸÑ XR/BID.",
      chips([{l:"warn",ar:"ÿ£ŸÉŸÖŸÑ ÿßŸÑŸÉŸàÿ±ÿ≥",en:"Finish the course"}])
    ),
  ];

  const CLASS_RULES = [
    classRule(["blood pressure","antihypertensive","ÿ∂ÿ∫ÿ∑"], "Blood pressure meds", "ÿ£ÿØŸàŸäÿ© ÿßŸÑÿ∂ÿ∫ÿ∑",
      "OD: after Iftar OR after Suhoor (consistent). Diuretics: early after Iftar.",
      "ŸÖÿ±ÿ©: ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ÿ£Ÿà ÿßŸÑÿ≥ÿ≠Ÿàÿ± (ŸàŸÇÿ™ ÿ´ÿßÿ®ÿ™). ÿßŸÑŸÖÿØÿ±ÿßÿ™: ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸÖÿ®ŸÉÿ±Ÿãÿß.",
      chips([{l:"warn",ar:"ÿ±ÿßŸÇÿ® ÿßŸÑÿØŸàÿÆÿ©/ÿßŸÑÿ∂ÿ∫ÿ∑",en:"Monitor dizziness/BP"}])
    ),
    classRule(["ppi","ŸÖÿπÿØÿ©","ÿßÿ±ÿ™ÿ¨ÿßÿπ"], "PPI", "ÿ£ÿØŸàŸäÿ© ÿßŸÑŸÖÿπÿØÿ© (PPI)",
      "30‚Äì60 min before Iftar (best). If BID: before Iftar + before Suhoor.",
      "ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± 30‚Äì60 ÿØŸÇŸäŸÇÿ© (ÿßŸÑÿ£ŸÅÿ∂ŸÑ). ÿ•ÿ∞ÿß ŸÖÿ±ÿ™ŸäŸÜ: ŸÇÿ®ŸÑ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± + ŸÇÿ®ŸÑ ÿßŸÑÿ≥ÿ≠Ÿàÿ±.",
      chips([{l:"ok",ar:"ŸÇÿ®ŸÑ ÿßŸÑÿ£ŸÉŸÑ ÿ£ŸÅÿ∂ŸÑ",en:"Best before meals"}])
    ),
    classRule(["pain","analgesic","ŸÖÿ≥ŸÉŸÜ"], "Pain relief", "ŸÖÿ≥ŸÉŸÜÿßÿ™",
      "Paracetamol between Iftar‚ÄìSuhoor as needed. NSAIDs after Iftar with food; avoid with ulcers/CKD/warfarin unless advised.",
      "ÿ®ÿßÿ±ÿßÿ≥Ÿäÿ™ÿßŸÖŸàŸÑ ÿ®ŸäŸÜ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸàÿßŸÑÿ≥ÿ≠Ÿàÿ± ÿπŸÜÿØ ÿßŸÑÿ≠ÿßÿ¨ÿ©. NSAIDs ÿ®ÿπÿØ ÿßŸÑÿ•ŸÅÿ∑ÿßÿ± ŸÖÿπ ÿßŸÑÿ∑ÿπÿßŸÖÿõ ÿ™ÿ¨ŸÜÿ®Ÿáÿß ŸÖÿπ ŸÇÿ±ÿ≠ÿ©/ŸÉŸÑŸâ/Ÿàÿßÿ±ŸÅÿßÿ±ŸäŸÜ ÿ•ŸÑÿß ÿ®ÿ™Ÿàÿ¨ŸäŸá.",
      chips([{l:"warn",ar:"ŸÖÿπ ÿßŸÑÿ∑ÿπÿßŸÖ",en:"With food"}])
    ),
    classRule(["inhaler","asthma","ÿ®ÿÆÿßÿÆ"], "Inhalers", "ÿ®ÿÆÿßÿÆÿßÿ™",
      "Continue as prescribed. Do not delay treatment if severe symptoms.",
      "ÿßÿ≥ÿ™ŸÖÿ± ÿ≠ÿ≥ÿ® ÿßŸÑŸàÿµŸÅÿ©. ŸÑÿß ÿ™ÿ§ÿÆÿ± ÿßŸÑÿπŸÑÿßÿ¨ ÿ•ÿ∞ÿß ÿßŸÑÿ£ÿπÿ±ÿßÿ∂ ÿ¥ÿØŸäÿØÿ©.",
      chips([{l:"warn",ar:"ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸÑŸÑÿ£ŸÖÿßŸÜ",en:"Safety first"}])
    ),
  ];

  let state = { pending: null };

  function findMed(q){
    const qq = normalize(q);
    if(!qq) return null;
    for(const m of MEDS){
      if(m.keys.some(k => qq===k)) return m;
    }
    for(const m of MEDS){
      if(m.keys.some(k => k.includes(qq) || qq.includes(k))) return m;
    }
    return null;
  }
  function findClass(q){
    const qq = normalize(q);
    if(!qq) return null;
    for(const c of CLASS_RULES){
      if(c.keys.some(k => qq.includes(k) || k.includes(qq))) return c;
    }
    return null;
  }

  function askFrequency(classHint=null){
    state.pending = {type:"freq", classHint};
    pushMsg(t(
      "To cover ALL medications safely, tell me the dosing frequency:\n1) Once daily (OD)\n2) Twice daily (BID)\n3) Three times daily (TID)\n4) Four times daily (QID)\n\nReply: 1 / 2 / 3 / 4",
      "ŸÑÿ™ÿ∫ÿ∑Ÿäÿ© ŸÉŸÑ ÿßŸÑÿ£ÿØŸàŸäÿ© ÿ®ÿ£ŸÖÿßŸÜÿå ÿ≠ÿØŸëÿØ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ™ ÿ®ÿßŸÑŸäŸàŸÖ:\n1) ŸÖÿ±ÿ© ŸäŸàŸÖŸäŸãÿß (OD)\n2) ŸÖÿ±ÿ™ŸäŸÜ (BID)\n3) ÿ´ŸÑÿßÿ´ ŸÖÿ±ÿßÿ™ (TID)\n4) ÿ£ÿ±ÿ®ÿπ ŸÖÿ±ÿßÿ™ (QID)\n\nÿßŸÉÿ™ÿ®: 1 ÿ£Ÿà 2 ÿ£Ÿà 3 ÿ£Ÿà 4"
    ));
  }

  function renderMed(m){
    const header = t(`üìå Category: ${m.cat.en}\n`, `üìå ÿßŸÑÿ™ÿµŸÜŸäŸÅ: ${m.cat.ar}\n`);
    const body = (ui.mode.value==="hcp" && m.hcp)
      ? t("üßë‚Äç‚öïÔ∏è For HCP:\n" + m.hcp.en, "üßë‚Äç‚öïÔ∏è ŸÑŸÑŸÉŸàÿßÿØÿ± ÿßŸÑÿµÿ≠Ÿäÿ©:\n" + m.hcp.ar)
      : t(m.patient.ar, m.patient.en);
    pushMsg(header + "\n" + body, "bot", m.chips || []);
  }

  function renderClass(c){
    const header = t(`üìå Class: ${c.cat.en}\n`, `üìå ÿßŸÑŸÅÿ¶ÿ©: ${c.cat.ar}\n`);
    pushMsg(header + "\n" + t(c.patient.ar, c.patient.en), "bot", c.chips || []);
    askFrequency(c.cat);
  }

  function handleFrequencyReply(q){
    const qq = normalize(q);
    const map = {"1":"od","od":"od","once":"od","ŸÖÿ±ÿ©":"od","2":"bid","bid":"bid","twice":"bid","ŸÖÿ±ÿ™ŸäŸÜ":"bid","3":"tid","tid":"tid","4":"qid","qid":"qid"};
    const f = map[qq];
    if(!f){ pushMsg(t("Reply 1/2/3/4.","ÿßŸÉÿ™ÿ® 1/2/3/4."),"bot"); return; }
    const g = freqGuidance(f);
    const label = (state.pending && state.pending.classHint)
      ? t(`üìå Based on class: ${state.pending.classHint.en||""}\n`, `üìå ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÅÿ¶ÿ©: ${state.pending.classHint.ar||""}\n`)
      : "";
    pushMsg(label + "\n" + t(g.ar,g.en), "bot", g.chips||[]);
    state.pending = null;
  }

  function route(q){
    if(state.pending && state.pending.type==="freq"){ handleFrequencyReply(q); return; }
    const m = findMed(q); if(m){ renderMed(m); return; }
    const c = findClass(q); if(c){ renderClass(c); return; }
    pushMsg(t(
      "Not found by name. Type a class (antibiotic / PPI / blood pressure / inhaler / pain) OR reply with 1/2/3/4 for frequency.",
      "ŸÑŸÖ ÿ£ÿ¨ÿØ ÿßŸÑÿßÿ≥ŸÖ. ÿßŸÉÿ™ÿ® ŸÅÿ¶ÿ© (ŸÖÿ∂ÿßÿØ ÿ≠ŸäŸàŸä / PPI / ÿ∂ÿ∫ÿ∑ / ÿ®ÿÆÿßÿÆ / ŸÖÿ≥ŸÉŸÜ) ÿ£Ÿà ÿßŸÉÿ™ÿ® 1/2/3/4 ŸÑÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßÿ™."
    ),"bot");
    askFrequency();
  }

  const quick = ["warfarin","insulin","levothyroxine","omeprazole","antibiotic","blood pressure","PPI","inhaler","pain","OD (1)","BID (2)","TID (3)","QID (4)"];
  function buildQuick(){
    ui.quick.innerHTML = "";
    quick.forEach(label=>{
      const b = document.createElement("div");
      b.className = "pill";
      b.textContent = label;
      b.onclick = ()=>{
        let v = label;
        if(label==="OD (1)") v="1";
        if(label==="BID (2)") v="2";
        if(label==="TID (3)") v="3";
        if(label==="QID (4)") v="4";
        pushMsg(v,"me");
        route(v);
        focusInput();
      };
      ui.quick.appendChild(b);
    });
  }

  function welcome(){
    ui.chat.innerHTML = "";
    state.pending = null;
    pushMsg(t(
      "Ramadan Kareem üåô\n\nWelcome to QCH Smart Ramadan Medication Assistant.\nType your medication name (Arabic/English).",
      "Ramadan Kareem üåô\n\nÿ£ŸáŸÑŸãÿß ÿ®ŸÉ ŸÅŸä ŸÖÿ≥ÿßÿπÿØ ÿ£ÿØŸàŸäÿ© ÿ±ŸÖÿ∂ÿßŸÜ ‚Äì ŸÖÿ≥ÿ™ÿ¥ŸÅŸâ ÿßŸÑŸÇÿ∑ŸäŸÅ ÿßŸÑŸÖÿ±ŸÉÿ≤Ÿä.\nÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° (ÿπÿ±ÿ®Ÿä/ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä)."
    ), "bot");
    ui.welcomeBox.textContent = t(
      "If your medicine is TID/QID ‚Üí ask for XR/BID alternative.",
      "ÿ•ÿ∞ÿß ÿßŸÑÿØŸàÿßÿ° 3/4 ŸÖÿ±ÿßÿ™ ‚Üí ÿßÿ∑ŸÑÿ® ÿ®ÿØŸäŸÑ XR/BID."
    );
    focusInput();
  }

  function focusInput(){
    setTimeout(()=>{ try{ ui.input.focus(); }catch(e){} }, 50);
  }

  function send(){
    const q = ui.input.value;
    if(!q.trim()) return;
    pushMsg(q,"me");
    ui.input.value = "";
    route(q);
    focusInput();
  }

  ui.send.addEventListener("click", send);
  ui.input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); send(); } });
  ui.reset.addEventListener("click", welcome);
  ui.lang.addEventListener("change", welcome);
  ui.mode.addEventListener("change", welcome);

  document.addEventListener("click", (e)=>{ if(e.target !== ui.input){ focusInput(); } }, {passive:true});

  buildQuick();
  welcome();
})();
</script>
</body>
</html>
