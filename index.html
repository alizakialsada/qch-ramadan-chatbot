<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCH ‚Äì Smart Ramadan Medication Assistant</title>
  <meta name="description" content="Qatif Central Hospital ‚Äì Ramadan Medication Assistant (Arabic/English)." />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#dfeef8">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#f5fbff;
      --panel:#ffffff;
      --stroke:#cfe0ec;
      --stroke2:#bcd2e2;
      --text:#0f2a3a;
      --muted:#466274;

      --bubble:#eaf4fb;
      --bubble2:#dff0fb;

      --btn:#6bb6d6;
      --btnText:#0a2230;

      --shadow: 0 10px 35px rgba(15,42,58,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #f7fcff, #eef7ff);
      color: var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px;}

    /* Header: light, with logos right & left */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:14px 18px;
      border:2px solid var(--stroke);
      background: rgba(255,255,255,.85);
      border-radius: 28px;
      box-shadow: var(--shadow);
    }
    .logoBox{
      width:92px; height:56px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      overflow:hidden;
    }
    .logoBox img{max-width:100%; max-height:100%; object-fit:contain; display:block;}
    .titleBox{
      flex:1;
      text-align:center;
      line-height:1.2;
    }
    .titleBox h1{margin:0; font-size:22px; font-weight:800;}
    .titleBox .sub{margin-top:6px; font-size:14px; color:var(--muted);}

    .topBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pillBtn{
      border:1px solid var(--stroke2);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius: 999px;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
    }
    .pillBtn:hover{filter:brightness(0.98)}
    .pillBtn.primary{
      background: linear-gradient(180deg, #e7f6ff, #d8eefc);
      border-color:#9ec7dd;
    }

    /* Layout like your light screenshot */
    .card{
      margin-top:14px;
      border:2px solid var(--stroke);
      border-radius: 28px;
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(223,240,251,.70), rgba(255,255,255,.55));
    }
    .cardHead .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .cardHead .title{font-weight:800; font-size:16px;}
    .cardHead .hint{font-size:13px; color:var(--muted);}
    .status{font-size:13px; color:var(--muted);}

    #chat{
      padding:16px;
      min-height: 520px;
      max-height: 520px;
      overflow:auto;
      background: linear-gradient(180deg, rgba(245,251,255,.75), rgba(232,245,255,.55));
    }

    /* Bubbles like your screenshot */
    .msg{display:flex; flex-direction:column; gap:10px; margin:14px 0;}
    .msg.bot{align-items:stretch;}
    .msg.user{align-items:flex-start;}

    .bubble{
      border-radius: 22px;
      border:2px solid var(--stroke);
      background: radial-gradient(140% 160% at 50% 0%, rgba(255,255,255,.95), var(--bubble));
      padding:18px 18px;
      box-shadow: 0 8px 22px rgba(15,42,58,.08);
      line-height:1.9;
      font-size:18px;
    }
    .bubble.user{
      background: radial-gradient(140% 160% at 50% 0%, rgba(255,255,255,.95), var(--bubble2));
    }

    .botTitle{
      font-weight:900;
      font-size:22px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .metaLine{
      font-size:18px;
      color: #1c3a4d;
      margin:6px 0 0 0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .warn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid #f3d08a;
      background: #fff7df;
      color:#6a4b00;
      font-weight:700;
      font-size:16px;
    }
    .sectionText{font-size:19px; margin-top:10px;}
    .finePrint{
      font-size:16px;
      color: var(--muted);
      border-top:1px solid var(--stroke);
      margin-top:14px;
      padding-top:10px;
      line-height:1.8;
    }

    .actionsRow{display:flex; gap:10px; flex-wrap:wrap;}
    .copyBtn{
      border:1px solid var(--stroke2);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-size:15px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 6px 18px rgba(15,42,58,.08);
      width: fit-content;
    }
    .copyBtn:hover{filter:brightness(0.98)}

    /* Composer like your screenshot */
    .composer{
      display:flex;
      gap:14px;
      padding:16px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      align-items:center;
    }
    #userInput{
      flex:1;
      padding:18px 18px;
      border-radius: 22px;
      border:2px solid var(--stroke);
      background:#fff;
      font-size:18px;
      outline:none;
    }
    #sendBtn{
      padding:18px 22px;
      border-radius: 22px;
      border:0;
      background: var(--btn);
      color: #083047;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(107,182,214,.35);
    }
    #sendBtn:hover{filter:brightness(0.98)}

    /* Top10 modal (light) */
    #topModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;}
    .modalBox{
      max-width:560px;
      margin: 10vh auto;
      background:#fff;
      border-radius: 22px;
      border:2px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:18px;}
    .row{
      display:flex;
      justify-content:space-between;
      padding:10px 0;
      border-bottom:1px solid var(--stroke);
      font-size:16px;
    }

    /* Responsive tweaks */
    @media (max-width: 780px){
      .titleBox{text-align:center}
      .titleBox h1{font-size:18px}
      .bubble{font-size:16px}
      #userInput{font-size:16px}
      #sendBtn{font-size:16px}
      .logoBox{width:80px; height:50px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- Header with BOTH logos: right & left -->
    <div class="header">
      <!-- RIGHT logo (in RTL this appears right) -->
      <div class="logoBox" title="QCH">
        <img src="logo_qch.png" alt="QCH Logo">
      </div>

      <div class="titleBox">
        <h1 id="appTitle">QCH ‚Äì Smart Ramadan Medication Assistant</h1>
        <div class="sub" id="appSub">Arabic / English ¬∑ Patient-friendly ¬∑ Offline analytics</div>
      </div>

      <!-- LEFT logo -->
      <div class="logoBox" title="Health Holding Company">
        <img src="logo_health_holding.png" alt="Health Holding Logo">
      </div>
    </div>

    <div class="topBtns" style="margin-top:12px; justify-content:center;">
      <button id="langBtn" class="pillBtn primary" type="button">üåê English</button>
      <button id="topBtn" class="pillBtn" type="button">üìä Top 10</button>
      <button id="installBtn" class="pillBtn" type="button" style="display:none;">‚¨áÔ∏è Install</button>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="left">
          <div class="title" id="chatTitle">ÿßŸÑÿØÿ±ÿØÿ¥ÿ©</div>
          <div class="hint" id="chatHint">ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° Ÿàÿ≥Ÿäÿ∏Ÿáÿ± ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÉÿ™ÿßÿ®ÿ©</div>
        </div>
        <div class="status" id="statusHint">‚Ä¶</div>
      </div>

      <div id="chat"></div>

      <div class="composer">
        <input id="userInput" list="drugHints" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ŸáŸÜÿß‚Ä¶" autocomplete="off" />
        <datalist id="drugHints"></datalist>
        <button id="sendBtn" type="button">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      </div>
    </div>
  </div>

  <!-- Top 10 modal -->
  <div id="topModal">
    <div class="modalBox">
      <div class="modalHead">
        <h3 id="topTitle">üìä Top 10 ÿ£ÿØŸàŸäÿ©</h3>
        <button id="topClose" class="pillBtn" type="button">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
      </div>
      <div id="topList"></div>
      <div style="margin-top:10px; color:var(--muted); font-size:13px;" id="topNote">
        Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäŸãÿß ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ (ÿ®ÿØŸàŸÜ ÿ≥Ÿäÿ±ŸÅÿ±).
      </div>
    </div>
  </div>

  <script>
    // ========== Language ==========
    let LANG = "ar"; // start Arabic like your screenshot
    const T = {
      ar: {
        dir:"rtl", htmlLang:"ar",
        langBtn:"üåê English",
        appTitle:"QCH ‚Äì ŸÖÿ≥ÿßÿπÿØ ÿ±ŸÖÿ∂ÿßŸÜ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÑÿ£ÿØŸàŸäÿ©",
        appSub:"ÿπÿ±ÿ®Ÿä / ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ¬∑ ÿ≥ŸáŸÑ ŸÑŸÑŸÖÿ±Ÿäÿ∂ ¬∑ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÖÿ≠ŸÑŸäÿ©",
        chatTitle:"ÿßŸÑÿØÿ±ÿØÿ¥ÿ©",
        chatHint:"ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° Ÿàÿ≥Ÿäÿ∏Ÿáÿ± ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÉÿ™ÿßÿ®ÿ©",
        statusLoading:"ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ drugs.json‚Ä¶",
        statusReady:"Ready",
        inputPh:"ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° ŸáŸÜÿß‚Ä¶",
        send:"ÿ•ÿ±ÿ≥ÿßŸÑ",
        you:"ÿ£ŸÜÿ™",
        welcome:"ŸÖÿ±ÿ≠ÿ®ÿßŸã üëã ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØ ÿ±ŸÖÿ∂ÿßŸÜ ÿßŸÑÿ∞ŸÉŸä. ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿØŸàÿßÿ° Ÿàÿ≥ÿ£ÿπÿ∑ŸäŸÉ ÿ•ÿ±ÿ¥ÿßÿØÿßÿ™ ÿπÿßŸÖÿ© ŸÑÿ™ŸàŸÇŸäÿ™ ÿßŸÑÿ¨ÿ±ÿπÿ© ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ.",
        copy:"üìã ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿØ",
        copied:"‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ",
        topTitle:"üìä Top 10 ÿ£ÿØŸàŸäÿ©",
        topEmpty:"ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¥ÿßÿ™ Ÿàÿ≥Ÿäÿ™ŸÉŸàŸëŸÜ Top 10 ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß.",
        disclaimer:"ÿ™ŸÜÿ®ŸäŸá: ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπÿßŸÖÿ© ŸÑŸÑÿ™ÿ´ŸÇŸäŸÅ ŸàŸÑŸäÿ≥ÿ™ ÿ®ÿØŸäŸÑÿßŸã ÿπŸÜ ÿßŸÑÿ∑ÿ®Ÿäÿ®/ÿßŸÑÿµŸäÿØŸÑŸä. ÿ•ÿ∞ÿß ŸÑÿØŸäŸÉ ÿ≥ŸÉÿ± ÿπŸÑŸâ ÿ£ŸÜÿ≥ŸàŸÑŸäŸÜ/ÿ£ÿØŸàŸäÿ© ÿ≥ŸäŸàŸÑÿ©ÿå ÿ£Ÿà ŸÖÿ±ÿ∂ ŸÉŸÑŸâ/ŸÇŸÑÿ®‚Äîÿßÿ≥ÿ™ÿ¥ÿ± ÿ∑ÿ®Ÿäÿ®ŸÉ ŸÇÿ®ŸÑ ÿ£Ÿä ÿ™ÿπÿØŸäŸÑ.",
        classLabel:"ÿßŸÑÿ™ÿµŸÜŸäŸÅ",
        needsPlan:"Ÿäÿ≠ÿ™ÿßÿ¨ ÿ≠ÿ∞ÿ±/ÿÆÿ∑ÿ© ŸÅÿ±ÿØŸäÿ©",
        diabetes:"Diabetes",
        defaultReply:"ŸÑŸÖ ÿ£ÿ¨ÿØ Ÿáÿ∞ÿß ÿßŸÑÿØŸàÿßÿ° ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ≠ÿßŸÑŸäÿßŸã. ÿ¨ÿ±Ÿëÿ® ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ÿ£Ÿà ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑÿßÿ≥ŸÖ."
      },
      en: {
        dir:"ltr", htmlLang:"en",
        langBtn:"üåê Arabic",
        appTitle:"QCH ‚Äì Smart Ramadan Medication Assistant",
        appSub:"Arabic / English ¬∑ Patient-friendly ¬∑ Offline analytics",
        chatTitle:"Chat",
        chatHint:"Type medication name and get autocomplete suggestions",
        statusLoading:"Loading drugs.json‚Ä¶",
        statusReady:"Ready",
        inputPh:"Type medication name here‚Ä¶",
        send:"Send",
        you:"You",
        welcome:"Hello üëã I'm the Ramadan Medication Assistant. Type a medication name and I‚Äôll provide general timing guidance for Ramadan.",
        copy:"üìã Copy reply",
        copied:"‚úÖ Copied",
        topTitle:"üìä Top 10 meds",
        topEmpty:"No data yet. Use the chat and it will auto-build Top 10.",
        disclaimer:"Note: General guidance only, not a substitute for a clinician/pharmacist. If you use insulin/anticoagulants, or have kidney/heart disease‚Äîconsult your clinician before changes.",
        classLabel:"Class",
        needsPlan:"Needs caution / individual plan",
        diabetes:"Diabetes",
        defaultReply:"I couldn‚Äôt find this medication in the list. Try English name or part of the name."
      }
    };

    function applyLang(){
      document.documentElement.dir = T[LANG].dir;
      document.documentElement.lang = T[LANG].htmlLang;

      document.getElementById("langBtn").textContent = T[LANG].langBtn;
      document.getElementById("appTitle").textContent = T[LANG].appTitle;
      document.getElementById("appSub").textContent = T[LANG].appSub;

      document.getElementById("chatTitle").textContent = T[LANG].chatTitle;
      document.getElementById("chatHint").textContent = T[LANG].chatHint;

      document.getElementById("userInput").placeholder = T[LANG].inputPh;
      document.getElementById("sendBtn").textContent = T[LANG].send;

      document.getElementById("topTitle").textContent = T[LANG].topTitle;

      // Re-render welcome in the new language if chat is empty
      if(document.getElementById("chat").children.length === 0){
        addBotWelcome();
      }
    }

    // ========== Analytics (local) ==========
    function trackDrugUse(drugKey){
      try{
        const key = "qch_drug_analytics_v1";
        const db = JSON.parse(localStorage.getItem(key) || "{}");
        db[drugKey] = (db[drugKey] || 0) + 1;
        localStorage.setItem(key, JSON.stringify(db));
      }catch(e){}
    }
    function getTopDrugs(limit=10){
      const key = "qch_drug_analytics_v1";
      const db = JSON.parse(localStorage.getItem(key) || "{}");
      return Object.entries(db).sort((a,b)=>b[1]-a[1]).slice(0, limit);
    }

    // ========== Helpers ==========
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function scrollChat(){
      const c = document.getElementById("chat");
      c.scrollTop = c.scrollHeight;
    }

    // ========== Chat UI ==========
    function addUserMessage(text){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg user";

      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.innerHTML = `<div style="font-weight:800; margin-bottom:6px;">${T[LANG].you} : ${escapeHtml(text)}</div>`;

      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      scrollChat();
    }

    function addBotBubble(html, copyText){
      const chat = document.getElementById("chat");
      const wrap = document.createElement("div");
      wrap.className = "msg bot";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = html;

      const actions = document.createElement("div");
      actions.className = "actionsRow";

      const copyBtn = document.createElement("button");
      copyBtn.className = "copyBtn";
      copyBtn.type = "button";
      copyBtn.textContent = T[LANG].copy;
      copyBtn.onclick = async () => {
        const text = copyText || bubble.innerText;
        try{
          await navigator.clipboard.writeText(text);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=> copyBtn.textContent = T[LANG].copy, 1200);
        }catch(e){
          const ta = document.createElement("textarea");
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy");
          document.body.removeChild(ta);
          copyBtn.textContent = T[LANG].copied;
          setTimeout(()=> copyBtn.textContent = T[LANG].copy, 1200);
        }
      };

      actions.appendChild(copyBtn);

      wrap.appendChild(bubble);
      wrap.appendChild(actions);
      chat.appendChild(wrap);
      scrollChat();
    }

    function addBotWelcome(){
      const welcomeHtml = `
        <div class="botTitle">ŸÖÿ±ÿ≠ÿ®ÿßŸã üëã</div>
        <div class="sectionText">${escapeHtml(T[LANG].welcome)}</div>
      `;
      addBotBubble(welcomeHtml, T[LANG].welcome);
    }

    // ========== Drugs + Autocomplete ==========
    let DRUGS = [];
    function setAutocomplete(drugs){
      DRUGS = Array.isArray(drugs) ? drugs : [];
    }
    function updateHints(q){
      const dl = document.getElementById("drugHints");
      dl.innerHTML = "";
      if(!q || q.trim().length < 2) return;

      const query = q.trim().toLowerCase();
      const matches = DRUGS
        .filter(d => (d.name||"").toLowerCase().includes(query) || (d.brand||"").toLowerCase().includes(query))
        .slice(0, 10);

      for(const m of matches){
        const opt = document.createElement("option");
        opt.value = m.name + (m.strength ? ` ${m.strength}` : "");
        dl.appendChild(opt);
      }
    }

    async function loadDrugsJson(){
      const status = document.getElementById("statusHint");
      status.textContent = T[LANG].statusLoading;
      try{
        const res = await fetch("drugs.json", {cache:"no-store"});
        if(!res.ok) throw new Error("no drugs.json");
        const data = await res.json();
        setAutocomplete(data);
        status.textContent = T[LANG].statusReady;
      }catch(e){
        setAutocomplete([]);
        status.textContent = "drugs.json not found";
      }
    }

    function findDrugByQuery(q){
      const query = (q||"").trim().toLowerCase();
      if(!query) return null;

      // exact match: "name strength"
      const exact = DRUGS.find(d => ((d.name + " " + (d.strength||"")).trim().toLowerCase()) === query);
      if(exact) return exact;

      // contains
      return DRUGS.find(d => ((d.name + " " + (d.strength||"") + " " + (d.brand||"")).toLowerCase()).includes(query)) || null;
    }

    function buildLightReply(d){
      const drugNameAr = (d.name_ar && LANG==="ar") ? d.name_ar : (d.name || "");
      const drugNameEn = (d.name || "");
      const title = (LANG==="ar")
        ? `${drugNameAr || drugNameEn}`
        : `${drugNameEn}${d.brand ? " ("+d.brand+")" : ""}`;

      const brandPart = d.brand ? ` (${d.brand})` : "";
      const strengthPart = d.strength ? ` ‚Äî ${d.strength}` : "";

      // Class (simple example)
      const cls = d.class || ( (d.name||"").toLowerCase().includes("metformin") ? T[LANG].diabetes : "" );

      const notes = (LANG==="ar" ? d.notes_ar : d.notes_en) || "";
      const ramadan = (LANG==="ar" ? d.ramadan_ar : d.ramadan_en) || "";

      const html = `
        <div class="botTitle">üíä ${escapeHtml((LANG==="ar" ? (drugNameAr || drugNameEn) : (drugNameEn + brandPart)))}${escapeHtml(strengthPart)}</div>

        <div class="metaLine">
          <span style="font-weight:800;">${escapeHtml(T[LANG].classLabel)}:</span>
          <span>${escapeHtml(cls || "‚Äî")}</span>
          <span class="warn">‚ö†Ô∏è ${escapeHtml(T[LANG].needsPlan)}</span>
        </div>

        ${notes ? `<div class="sectionText">üìù ${escapeHtml(notes)}</div>` : ""}
        ${ramadan ? `<div class="sectionText">üåô ${escapeHtml(ramadan)}</div>` : ""}

        <div class="finePrint">‚ö†Ô∏è ${escapeHtml(T[LANG].disclaimer)}</div>
      `;

      // Copy text (nice clean)
      const copyText =
        `üíä ${(LANG==="ar" ? (drugNameAr || drugNameEn) : (drugNameEn + brandPart))}${strengthPart}\n` +
        `${T[LANG].classLabel}: ${cls || "‚Äî"}\n` +
        (notes ? `\n${notes}\n` : "") +
        (ramadan ? `\n${ramadan}\n` : "") +
        `\n‚ö†Ô∏è ${T[LANG].disclaimer}`;

      return {html, copyText};
    }

    function handleMessage(text){
      const q = (text||"").trim();
      if(!q) return;

      addUserMessage(q);

      // Find drug
      const d = findDrugByQuery(q);
      if(d){
        const {html, copyText} = buildLightReply(d);
        addBotBubble(html, copyText);
        const key = (d.name + (d.strength ? " " + d.strength : "")).trim();
        trackDrugUse(key);
        return;
      }

      // fallback
      const html = `
        <div class="botTitle">‚ÑπÔ∏è</div>
        <div class="sectionText">${escapeHtml(T[LANG].defaultReply)}</div>
      `;
      addBotBubble(html, T[LANG].defaultReply);
    }

    // ========== Top 10 ==========
    function renderTop(){
      const list = document.getElementById("topList");
      const top = getTopDrugs(10);

      if(!top.length){
        list.innerHTML = `<div style="color:var(--muted); font-size:15px;">${escapeHtml(T[LANG].topEmpty)}</div>`;
        return;
      }

      list.innerHTML = top.map(([name,count],i)=>`
        <div class="row">
          <div>${i+1}. ${escapeHtml(name)}</div>
          <div style="color:var(--muted)">${count}</div>
        </div>
      `).join("");
    }

    // ========== Install prompt ==========
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById("installBtn").style.display = "inline-flex";
    });

    // ========== Boot ==========
    document.addEventListener("DOMContentLoaded", ()=>{
      applyLang();
      addBotWelcome();
      loadDrugsJson();

      document.getElementById("langBtn").onclick = ()=>{
        LANG = (LANG === "ar") ? "en" : "ar";
        // Clear chat to look consistent when switching like the light design
        document.getElementById("chat").innerHTML = "";
        applyLang();
        addBotWelcome();
        loadDrugsJson();
      };

      document.getElementById("sendBtn").onclick = ()=>{
        const input = document.getElementById("userInput");
        const v = input.value.trim();
        if(!v) return;
        input.value = "";
        updateHints("");
        handleMessage(v);
      };

      document.getElementById("userInput").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          document.getElementById("sendBtn").click();
        }
      });
      document.getElementById("userInput").addEventListener("input", (e)=> updateHints(e.target.value));

      const topModal = document.getElementById("topModal");
      document.getElementById("topBtn").onclick = ()=>{ renderTop(); topModal.style.display="block"; };
      document.getElementById("topClose").onclick = ()=>{ topModal.style.display="none"; };
      topModal.onclick = (e)=>{ if(e.target.id==="topModal") topModal.style.display="none"; };

      document.getElementById("installBtn").onclick = async ()=>{
        if(!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        document.getElementById("installBtn").style.display = "none";
      };

      // Register your existing service worker file name
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    });
  </script>
</body>
</html>
